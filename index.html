<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Distory Go - V58 FULL CODE</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* =========================================
           CSS GLOBAL ET DESIGN HUD
           ========================================= */
        :root {
            --bg-color: #02050e;
            --panel-color: rgba(10, 15, 30, 0.95);
            --border-color: #1e293b;
            --main-blue: #3b82f6;
            --glow-blue: rgba(59, 130, 246, 0.5);
            --danger-red: #ef4444;
            --gold-color: #fbbf24;
            --purple-color: #a855f7;
        }

        body {
            background-color: var(--bg-color);
            color: #ffffff;
            font-family: 'Rajdhani', sans-serif;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            user-select: none;
        }

        /* --- ANIMATIONS --- */
        
        /* Respiration de l'avatar */
        @keyframes breathe-anim {
            0% { transform: scale(1); filter: drop-shadow(0 0 10px var(--glow-blue)); }
            50% { transform: scale(1.05); filter: drop-shadow(0 0 25px var(--glow-blue)); }
            100% { transform: scale(1); filter: drop-shadow(0 0 10px var(--glow-blue)); }
        }
        .anim-breathe { animation: breathe-anim 4s infinite ease-in-out; }

        /* Effet de Scan (Laser) */
        @keyframes scan-down {
            0% { top: -20px; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }
        .laser-effect {
            position: absolute;
            left: 0;
            width: 100%;
            height: 4px;
            background-color: var(--main-blue);
            box-shadow: 0 0 20px var(--main-blue);
            z-index: 100;
            pointer-events: none;
            display: none; /* Cach√© par d√©faut */
        }
        .laser-active {
            display: block;
            animation: scan-down 0.8s linear forwards;
        }

        /* Tremblement (D√©g√¢ts) */
        @keyframes shake-screen {
            0% { transform: translate(0, 0); }
            10% { transform: translate(-5px, 5px); }
            20% { transform: translate(5px, -5px); }
            30% { transform: translate(-5px, 5px); }
            40% { transform: translate(5px, -5px); }
            100% { transform: translate(0, 0); }
        }
        .shake-active {
            animation: shake-screen 0.4s cubic-bezier(.36,.07,.19,.97) both;
        }

        /* Flash de Fusion */
        @keyframes fusion-flash {
            0% { background-color: rgba(255, 255, 255, 0); }
            50% { background-color: rgba(255, 255, 255, 0.2); }
            100% { background-color: rgba(255, 255, 255, 0); }
        }
        .flash-active {
            animation: fusion-flash 0.3s ease-out;
        }

        /* --- STRUCTURE DE LA PAGE --- */
        .app-layout {
            display: grid;
            grid-template-columns: 350px 1fr 320px;
            gap: 15px;
            height: 100vh;
            padding: 15px;
            position: relative;
            z-index: 1;
        }

        /* Effet de flou quand une modale est ouverte */
        .layout-blur {
            filter: blur(8px) brightness(0.4);
            pointer-events: none;
        }

        .panel-container {
            background-color: var(--panel-color);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        .panel-header {
            padding: 15px;
            background: rgba(0,0,0,0.3);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 700;
            font-size: 14px;
            letter-spacing: 1px;
            color: var(--main-blue);
        }

        /* --- PANNEAU GAUCHE (STATS) --- */
        .avatar-zone {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .hero-big-icon { font-size: 130px; }
        
        .stats-wrapper { padding: 20px; }
        .hp-container { margin-bottom: 20px; }
        .hp-text-row { display: flex; justify-content: space-between; font-size: 12px; font-weight: bold; margin-bottom: 5px; color: #94a3b8; }
        .hp-bar-bg { width: 100%; height: 8px; background: #0f172a; border-radius: 4px; overflow: hidden; border: 1px solid #334155; }
        .hp-bar-fg { height: 100%; background: linear-gradient(90deg, #991b1b, #ef4444); width: 100%; transition: width 0.2s; }

        .attributes-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .attr-box { background: rgba(255,255,255,0.03); border: 1px solid var(--border-color); padding: 10px; text-align: center; border-radius: 6px; }
        .attr-label { font-size: 10px; color: #64748b; font-weight: 700; text-transform: uppercase; }
        .attr-val { font-size: 24px; font-weight: 800; }

        .slots-row { padding: 15px; border-top: 1px solid var(--border-color); display: flex; gap: 10px; background: rgba(0,0,0,0.2); }
        .equip-slot { flex: 1; aspect-ratio: 1; background: rgba(0,0,0,0.3); border: 1px solid var(--border-color); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 24px; color: #475569; }
        .equip-slot.active { color: white; border-color: var(--main-blue); box-shadow: inset 0 0 10px rgba(59,130,246,0.2); }

        /* --- PANNEAU CENTRAL (JEU) --- */
        .viewport-zone { flex-grow: 1; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; overflow: hidden; }
        
        /* Ecran Mission */
        .mission-screen { text-align: center; }
        .mission-big-text { font-size: 80px; font-weight: 900; text-transform: uppercase; line-height: 1; }
        .mission-tag { display: inline-block; padding: 5px 20px; border: 1px solid var(--main-blue); border-radius: 20px; color: var(--main-blue); font-weight: bold; font-size: 12px; margin-top: 10px; }

        /* Ecran Combat */
        .combat-screen { display: none; text-align: center; }
        .enemy-sprite { font-size: 150px; filter: drop-shadow(0 0 30px rgba(239, 68, 68, 0.5)); transition: transform 0.1s; }
        .enemy-hp-bar { width: 200px; height: 6px; background: #330000; margin: 20px auto; border-radius: 3px; overflow: hidden; }
        .enemy-hp-fill { height: 100%; background: #ef4444; width: 100%; transition: width 0.2s; }

        /* Actions et Soute */
        .action-zone { height: 220px; border-top: 1px solid var(--border-color); padding: 15px; display: grid; grid-template-columns: 1fr 180px; gap: 15px; background: rgba(0,0,0,0.2); }
        
        .inventory-wrapper { display: flex; flex-direction: column; }
        .inventory-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .inv-label { font-size: 10px; font-weight: bold; color: #64748b; text-transform: uppercase; }
        .btn-chest { background: #7c3aed; color: white; border: none; padding: 4px 10px; border-radius: 4px; font-size: 10px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-chest:hover { background: #6d28d9; transform: scale(1.05); }

        .inv-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 5px; align-content: flex-start; }
        .inv-slot { aspect-ratio: 1; background: rgba(255,255,255,0.03); border: 1px solid var(--border-color); border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer; transition: 0.1s; }
        .inv-slot:hover { border-color: var(--main-blue); background: rgba(59,130,246,0.1); }

        .controls-wrapper { display: flex; flex-direction: column; justify-content: flex-end; gap: 10px; }
        
        .btn-large-action { width: 100%; height: 60px; background: linear-gradient(180deg, #3b82f6, #1d4ed8); border: 1px solid #60a5fa; border-radius: 8px; color: white; font-size: 24px; font-weight: 800; text-transform: uppercase; cursor: pointer; transition: 0.1s; box-shadow: 0 4px 0 #1e40af; }
        .btn-large-action:active { transform: translateY(4px); box-shadow: none; }
        .btn-large-action:disabled { filter: grayscale(100%); opacity: 0.5; cursor: not-allowed; }

        .sub-controls { display: flex; gap: 5px; }
        .btn-toggle { flex: 1; background: transparent; border: 1px solid var(--border-color); color: #94a3b8; font-size: 10px; font-weight: bold; padding: 8px 0; border-radius: 4px; cursor: pointer; text-transform: uppercase; }
        .btn-toggle.active { background: rgba(59,130,246,0.1); border-color: var(--main-blue); color: white; }

        /* --- PANNEAU DROIT (LOGS) --- */
        .logs-container { flex-grow: 1; padding: 15px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 12px; color: #94a3b8; display: flex; flex-direction: column-reverse; }
        .log-message { margin-bottom: 4px; padding-bottom: 4px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .nav-footer { height: 50px; border-top: 1px solid var(--border-color); display: flex; }
        .nav-btn { flex: 1; background: transparent; border: none; color: #64748b; font-weight: 700; font-size: 12px; text-transform: uppercase; cursor: pointer; transition: 0.2s; }
        .nav-btn:hover { color: white; }
        .nav-btn.active { color: white; border-bottom: 3px solid var(--main-blue); background: rgba(255,255,255,0.02); }

        /* --- MODALES --- */
        .full-screen-modal { position: fixed; inset: 0; background: var(--bg-color); z-index: 5000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .char-select-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 40px; }
        .char-btn { font-size: 60px; padding: 20px; background: rgba(255,255,255,0.05); border: 2px solid var(--border-color); border-radius: 12px; cursor: pointer; transition: 0.2s; }
        .char-btn:hover { border-color: var(--main-blue); transform: scale(1.1); background: rgba(59,130,246,0.1); }

        .overlay-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 6000; display: none; align-items: center; justify-content: center; }
        .popup-content { background: #0f172a; border: 1px solid var(--main-blue); padding: 40px; border-radius: 12px; text-align: center; width: 400px; }

        /* Utilitaires */
        .hidden { display: none !important; }
        .text-gold { color: var(--gold-color); }
        .text-purple { color: var(--purple-color); }

    </style>
</head>
<body>

    <div id="laser-layer" class="laser-effect"></div>

    <div id="boot-screen" class="full-screen-modal">
        <h1 class="text-4xl font-black text-white mb-10 tracking-[5px] uppercase">Identification</h1>
        <div class="char-select-grid">
            <button class="char-btn" onclick="GameEngine.selectAvatar('üêô')">üêô</button>
            <button class="char-btn" onclick="GameEngine.selectAvatar('üêπ')">üêπ</button>
            <button class="char-btn" onclick="GameEngine.selectAvatar('ü¶ä')">ü¶ä</button>
            <button class="char-btn" onclick="GameEngine.selectAvatar('ü¶å')">ü¶å</button>
            <button class="char-btn" onclick="GameEngine.selectAvatar('üêï')">üêï</button>
            <button class="char-btn" onclick="GameEngine.selectAvatar('üê±')">üê±</button>
        </div>
        <p class="text-xs text-gray-500 font-mono">S√âLECTIONNEZ UNE FORME BIOLOGIQUE</p>
    </div>

    <div id="main-ui" class="app-layout layout-blur">
        
        <div class="panel-container">
            <div class="panel-header">
                <span>PILOTE</span>
                <span id="ui-pilot-name" class="text-blue-400">COMMANDANT</span>
            </div>
            
            <div class="avatar-zone">
                <div class="absolute top-2 right-4 text-right">
                    <div class="text-[10px] text-gray-500 uppercase font-bold">Niveau</div>
                    <div id="ui-level" class="text-2xl font-black">1</div>
                </div>
                <div id="ui-avatar-display" class="hero-big-icon anim-breathe">?</div>
            </div>

            <div class="stats-wrapper">
                <div class="hp-container">
                    <div class="hp-text-row">
                        <span>STRUCTURE</span>
                        <span id="ui-hp-text">100/100</span>
                    </div>
                    <div class="hp-bar-bg">
                        <div id="ui-hp-bar" class="hp-bar-fg" style="width: 100%;"></div>
                    </div>
                </div>

                <div class="attributes-grid">
                    <div class="attr-box">
                        <div class="attr-label">PUISSANCE</div>
                        <div id="ui-atk" class="attr-val text-blue-400">10</div>
                    </div>
                    <div class="attr-box">
                        <div class="attr-label">BLINDAGE</div>
                        <div id="ui-def" class="attr-val text-blue-400">0</div>
                    </div>
                </div>
            </div>

            <div class="slots-row">
                <div id="slot-weapon" class="equip-slot">‚öîÔ∏è</div>
                <div id="slot-head" class="equip-slot">üõ°Ô∏è</div>
                <div id="slot-pet" class="equip-slot">üêæ</div>
            </div>
        </div>

        <div class="panel-container" id="center-panel">
            <div class="panel-header">
                <span>ZONE <span id="ui-zone">1-1</span></span>
                <div class="flex gap-4 font-bold text-sm">
                    <span class="text-gold">ü™ô <span id="ui-gold">0</span></span>
                    <span class="text-purple">‚ú® <span id="ui-gems">0</span></span>
                </div>
            </div>

            <div class="viewport-zone">
                <div id="screen-mission" class="mission-screen">
                    <div class="mission-big-text">MISSION</div>
                    <div class="mission-tag">SECTEUR D'EXPLORATION</div>
                </div>

                <div id="screen-combat" class="combat-screen">
                    <div class="enemy-hp-bar"><div id="ui-enemy-hp-bar" class="enemy-hp-fill"></div></div>
                    <div id="ui-enemy-sprite" class="enemy-sprite">üëæ</div>
                    <div class="mt-4 font-bold text-red-400 bg-red-900/20 px-4 py-1 rounded inline-block uppercase">Hostile D√©tect√©</div>
                </div>
            </div>

            <div class="action-zone">
                <div class="inventory-wrapper">
                    <div class="inventory-header">
                        <span class="inv-label">STOCKAGE</span>
                        <button onclick="GameEngine.openChest()" class="btn-chest">COFFRE (5‚ú®)</button>
                    </div>
                    <div id="ui-inventory" class="inv-grid">
                        </div>
                </div>

                <div class="controls-wrapper">
                    <button id="btn-main-action" onclick="GameEngine.handleMainClick()" class="btn-large-action">
                        LANCER
                    </button>
                    <div class="sub-controls">
                        <button id="btn-auto" onclick="GameEngine.toggleAuto()" class="btn-toggle">AUTO: OFF</button>
                        <button id="btn-speed" onclick="GameEngine.toggleSpeed()" class="btn-toggle">VIT: x1</button>
                        <button onclick="UI.openSettings()" class="btn-toggle" style="flex:0.3">‚öôÔ∏è</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="panel-container">
            <div class="panel-header">
                <span>TERMINAL DE BORD</span>
            </div>
            <div id="ui-logs" class="logs-container">
                <div class="log-message">> Syst√®me initialis√©. En attente.</div>
            </div>
            <div class="nav-footer">
                <button class="nav-btn active" onclick="UI.switchRightTab('logs')">JOURNAL</button>
                <button class="nav-btn" onclick="UI.switchRightTab('base')">BASE</button>
            </div>
        </div>
    </div>

    <div id="hub-overlay" class="full-screen-modal hidden" style="background: rgba(2, 5, 14, 0.95);">
        <h2 class="text-4xl font-bold text-white mb-12 italic uppercase">Centre d'Am√©lioration</h2>
        <div class="grid grid-cols-1 gap-6 w-80">
            <div onclick="GameEngine.upgradeStat('hp')" class="bg-white/5 border border-blue-900 p-6 rounded hover:border-blue-500 cursor-pointer flex justify-between items-center transition">
                <div class="text-left">
                    <div class="text-xs text-gray-500 font-bold uppercase">Int√©grit√©</div>
                    <div class="text-2xl font-bold text-white">+20 PV</div>
                </div>
                <div id="cost-hp" class="text-gold font-bold">100 ü™ô</div>
            </div>

            <div onclick="GameEngine.upgradeStat('atk')" class="bg-white/5 border-blue-900 border p-6 rounded hover:border-blue-500 cursor-pointer flex justify-between items-center transition">
                <div class="text-left">
                    <div class="text-xs text-gray-500 font-bold uppercase">Puissance</div>
                    <div class="text-2xl font-bold text-white">+5 ATK</div>
                </div>
                <div id="cost-atk" class="text-gold font-bold">100 ü™ô</div>
            </div>

            <div onclick="GameEngine.upgradeStat('def')" class="bg-white/5 border-blue-900 border p-6 rounded hover:border-blue-500 cursor-pointer flex justify-between items-center transition">
                <div class="text-left">
                    <div class="text-xs text-gray-500 font-bold uppercase">Blindage</div>
                    <div class="text-2xl font-bold text-white">+2 DEF</div>
                </div>
                <div id="cost-def" class="text-gold font-bold">100 ü™ô</div>
            </div>
        </div>
        <button onclick="UI.closeHub()" class="mt-12 text-blue-500 font-bold uppercase tracking-widest hover:text-white border-b border-transparent hover:border-white transition">Retour Mission</button>
    </div>

    <div id="settings-modal" class="overlay-modal">
        <div class="popup-content">
            <h2 class="text-2xl font-bold text-white mb-8">PARAM√àTRES</h2>
            <button onclick="GameEngine.hardReset()" class="w-full py-4 bg-red-900/80 border border-red-500 text-white rounded font-bold hover:bg-red-700 mb-4 transition">
                R√âINITIALISER LA PROGRESSION
            </button>
            <button onclick="UI.closeSettings()" class="w-full py-4 bg-slate-800 rounded text-gray-300 font-bold hover:bg-slate-700 transition">
                RETOUR
            </button>
        </div>
    </div>

    <script>
        /* =========================================
           DONN√âES DU JEU (BASE DE DONN√âES)
           ========================================= */
        const DB = {
            enemies: [
                { name: "Drone", icon: "üõ∏", hp: 50, atk: 5 },
                { name: "Xeno", icon: "üëæ", hp: 80, atk: 8 },
                { name: "Sonde", icon: "üõ∞Ô∏è", hp: 40, atk: 12 }
            ],
            items: [
                { name: "Lame", icon: "‚öîÔ∏è", type: "weapon", stat: 10 },
                { name: "Casque", icon: "üõ°Ô∏è", type: "head", stat: 20 },
                { name: "Bot", icon: "ü§ñ", type: "pet", stat: 5 }
            ]
        };

        /* =========================================
           VARIABLES D'√âTAT (STATE)
           ========================================= */
        let Player = {
            avatar: null,
            gold: 0,
            gems: 20,
            baseStats: { hp: 0, atk: 0, def: 0 },
            inventory: [],
            equipment: { weapon: null, head: null, pet: null }
        };

        let GameState = {
            day: 0,
            currentHp: 100,
            maxHp: 100,
            totalAtk: 10,
            totalDef: 0,
            
            // √âtat des processus
            isRunActive: false,     // Si une run est lanc√©e
            isProcessing: false,    // Si une animation/calcul est en cours
            isCombat: false,        // Si on est en combat
            
            // Options
            autoMode: false,
            speedMultiplier: 1,     // 1 = normal, 2 = rapide
            
            // Combat Data
            enemyCurrentHp: 0,
            enemyMaxHp: 0,
            enemyAtk: 0
        };

        let autoTimer = null; // R√©f√©rence pour le setTimeout du mode auto

        /* =========================================
           MOTEUR LOGIQUE (GAME ENGINE)
           ========================================= */
        const GameEngine = {
            
            // --- INITIALISATION ---
            init: () => {
                const save = localStorage.getItem('distory_save_v58');
                if (save) {
                    try {
                        const loadedData = JSON.parse(save);
                        Player = loadedData;
                        if (Player.avatar) {
                            UI.showGameInterface();
                            GameEngine.recalcStats();
                            UI.updateAll();
                        }
                    } catch (e) {
                        console.error("Save corrompue", e);
                    }
                }
            },

            selectAvatar: (emoji) => {
                Player.avatar = emoji;
                GameEngine.save();
                UI.showGameInterface();
                UI.updateAll();
            },

            // --- BOUCLE PRINCIPALE ---
            handleMainClick: () => {
                if (GameState.isProcessing || GameState.isCombat) return;
                GameEngine.triggerCycle();
            },

            triggerCycle: () => {
                GameState.isProcessing = true;
                
                // Si c'est le tout premier jour
                if (!GameState.isRunActive) {
                    GameState.isRunActive = true;
                    GameState.day = 0;
                    UI.log("Nouvelle mission initialis√©e.");
                }

                // Animation Laser
                const laser = document.getElementById('laser-layer');
                laser.classList.add('laser-active');
                
                // D√©lai d'animation du scan (d√©pend de la vitesse)
                const delay = 600 / GameState.speedMultiplier;

                setTimeout(() => {
                    laser.classList.remove('laser-active');
                    GameEngine.executeCycleLogic();
                }, delay);
            },

            executeCycleLogic: () => {
                GameState.day++;
                GameEngine.recalcStats(); // Mise √† jour des stats (r√©gen passive √©ventuelle)
                
                // Logique de rencontre : Combat tous les 5 jours
                if (GameState.day % 5 === 0) {
                    GameEngine.startCombat();
                } else {
                    // √âv√©nement pacifique (Loot)
                    const goldGain = 20 + Math.floor(Math.random() * 10);
                    Player.gold += goldGain;
                    UI.log(`> Secteur scann√©. Trouv√©: ${goldGain} Or.`);
                    UI.updateAll();
                    GameEngine.endCycle();
                }
            },

            endCycle: () => {
                GameState.isProcessing = false;
                
                // V√©rification Mode Auto
                if (GameState.autoMode && GameState.isRunActive && !GameState.isCombat) {
                    const delay = 800 / GameState.speedMultiplier;
                    autoTimer = setTimeout(GameEngine.triggerCycle, delay);
                }
            },

            // --- SYST√àME DE COMBAT ---
            startCombat: () => {
                GameState.isCombat = true;
                
                // Choix ennemi
                const enemyTemplate = DB.enemies[Math.floor(Math.random() * DB.enemies.length)];
                
                // Scaling
                const difficultyMult = 1 + (GameState.day * 0.1);
                
                GameState.enemyMaxHp = Math.floor(enemyTemplate.hp * difficultyMult);
                GameState.enemyCurrentHp = GameState.enemyMaxHp;
                GameState.enemyAtk = Math.floor(enemyTemplate.atk * (1 + GameState.day * 0.05));
                
                UI.setupCombatScreen(enemyTemplate.icon, GameState.enemyMaxHp);
                UI.log(`! ALERTE : ${enemyTemplate.name} en approche !`);
                
                // Lancer le premier tour
                setTimeout(GameEngine.combatRound, 800 / GameState.speedMultiplier);
            },

            combatRound: () => {
                if (!GameState.isCombat) return;

                // 1. Joueur attaque
                GameState.enemyCurrentHp -= GameState.totalAtk;
                UI.animShakeElement('ui-enemy-sprite'); // Ennemi secou√©
                UI.updateEnemyHp(GameState.enemyCurrentHp, GameState.enemyMaxHp);

                if (GameState.enemyCurrentHp <= 0) {
                    GameEngine.winCombat();
                    return;
                }

                // 2. Ennemi attaque (apr√®s d√©lai)
                setTimeout(() => {
                    const dmg = Math.max(1, GameState.enemyAtk - GameState.totalDef);
                    GameState.currentHp -= dmg;
                    
                    UI.animShakeElement('center-panel'); // √âcran secou√©
                    UI.updateAll(); // Met √† jour HP joueur

                    if (GameState.currentHp <= 0) {
                        GameEngine.loseCombat();
                    } else {
                        // Prochain tour
                        setTimeout(GameEngine.combatRound, 800 / GameState.speedMultiplier);
                    }
                }, 400 / GameState.speedMultiplier);
            },

            winCombat: () => {
                GameState.isCombat = false;
                const reward = 50 + (GameState.day * 2);
                Player.gold += reward;
                
                UI.log(`> Cible d√©truite. Gain: ${reward} Or.`);
                UI.returnToMissionScreen();
                UI.updateAll();
                GameEngine.save();
                
                // Reprise du cycle
                GameEngine.endCycle();
            },

            loseCombat: () => {
                GameState.isCombat = false;
                GameState.isRunActive = false; // Arr√™t de la run
                GameState.autoMode = false;    // Arr√™t auto
                GameState.currentHp = 0;
                
                UI.log("!!! √âCHEC CRITIQUE DE LA MISSION !!!");
                UI.returnToMissionScreen();
                UI.updateAll(); // Affiche 0 HP
                GameEngine.save();
            },

            // --- INVENTAIRE & STATS ---
            recalcStats: () => {
                // Base
                let hp = 100 + (Player.baseStats.hp * 20);
                let atk = 10 + (Player.baseStats.atk * 5);
                let def = 0 + (Player.baseStats.def * 2);

                // Equipement
                if (Player.equipment.weapon) atk += Player.equipment.weapon.stat;
                if (Player.equipment.head) hp += Player.equipment.head.stat;
                if (Player.equipment.pet) atk += Player.equipment.pet.stat;

                GameState.maxHp = hp;
                GameState.totalAtk = atk;
                GameState.totalDef = def;

                // Soin passif (si pas en combat et run active)
                if (GameState.isRunActive && !GameState.isCombat) {
                    GameState.currentHp = Math.min(GameState.currentHp + 5, GameState.maxHp);
                } else if (!GameState.isRunActive) {
                    // Reset full HP si pas en run
                    GameState.currentHp = GameState.maxHp;
                }
            },

            openChest: () => {
                if (Player.gems >= 5) {
                    Player.gems -= 5;
                    const template = DB.items[Math.floor(Math.random() * DB.items.length)];
                    // Cr√©ation instance unique
                    const newItem = { ...template, uid: Date.now() };
                    Player.inventory.push(newItem);
                    
                    UI.log(`> Coffre: ${newItem.name} obtenu.`);
                    GameEngine.checkFusion();
                    GameEngine.recalcStats();
                    UI.updateAll();
                    GameEngine.save();
                } else {
                    UI.log("> Pas assez de mati√®re (5‚ú®).");
                }
            },

            checkFusion: () => {
                const counts = {};
                Player.inventory.forEach(item => {
                    counts[item.name] = (counts[item.name] || 0) + 1;
                });

                for (const name in counts) {
                    if (counts[name] >= 3) {
                        const baseItem = Player.inventory.find(i => i.name === name);
                        
                        // Retirer 3
                        let removed = 0;
                        Player.inventory = Player.inventory.filter(i => {
                            if (i.name === name && removed < 3) {
                                removed++;
                                return false;
                            }
                            return true;
                        });

                        // Ajouter am√©lior√©
                        const upgraded = {
                            ...baseItem,
                            stat: Math.floor(baseItem.stat * 2.2),
                            name: baseItem.name + "+",
                            uid: Date.now()
                        };
                        Player.inventory.push(upgraded);
                        
                        UI.log(`*** FUSION: ${baseItem.name} -> ${upgraded.name} ***`);
                        document.body.classList.add('flash-active');
                        setTimeout(() => document.body.classList.remove('flash-active'), 300);
                        
                        // Recursif
                        GameEngine.checkFusion();
                        return;
                    }
                }
            },

            equipItem: (uid) => {
                const idx = Player.inventory.findIndex(i => i.uid === uid);
                if (idx > -1) {
                    const item = Player.inventory[idx];
                    // Si slot occup√©, renvoyer √† l'inventaire
                    if (Player.equipment[item.type]) {
                        Player.inventory.push(Player.equipment[item.type]);
                    }
                    // Equiper
                    Player.equipment[item.type] = item;
                    // Retirer de l'inventaire
                    Player.inventory.splice(idx, 1);

                    GameEngine.recalcStats();
                    UI.updateAll();
                    GameEngine.save();
                }
            },

            upgradeStat: (type) => {
                const cost = 100 + (Player.baseStats[type] * 50);
                if (Player.gold >= cost) {
                    Player.gold -= cost;
                    Player.baseStats[type]++;
                    GameEngine.recalcStats();
                    UI.updateAll();
                    GameEngine.save();
                }
            },

            // --- OPTIONS ---
            toggleAuto: () => {
                GameState.autoMode = !GameState.autoMode;
                UI.updateAll();
                // Si on active l'auto et qu'on attend, on lance
                if (GameState.autoMode && GameState.isRunActive && !GameState.isProcessing && !GameState.isCombat) {
                    GameEngine.triggerCycle();
                }
            },

            toggleSpeed: () => {
                GameState.speedMultiplier = (GameState.speedMultiplier === 1) ? 2 : 1;
                UI.updateAll();
            },

            hardReset: () => {
                if (confirm("Confirmation : Effacer toutes les donn√©es ?")) {
                    localStorage.clear();
                    location.reload();
                }
            },

            save: () => {
                localStorage.setItem('distory_save_v58', JSON.stringify(Player));
            }
        };

        /* =========================================
           GESTION DE L'INTERFACE (UI)
           ========================================= */
        const UI = {
            showGameInterface: () => {
                document.getElementById('boot-screen').classList.add('hidden');
                document.getElementById('main-ui').classList.remove('layout-blur');
            },

            updateAll: () => {
                // Top Bar
                document.getElementById('ui-gold').innerText = Player.gold;
                document.getElementById('ui-gems').innerText = Player.gems;
                document.getElementById('ui-zone').innerText = `1-${GameState.day}`;

                // Stats Panel
                document.getElementById('ui-avatar-display').innerText = Player.avatar;
                document.getElementById('ui-level').innerText = Math.floor(GameState.day/10) + 1;
                
                document.getElementById('ui-hp-text').innerText = `${Math.floor(GameState.currentHp)}/${GameState.maxHp}`;
                const hpPct = Math.max(0, (GameState.currentHp / GameState.maxHp) * 100);
                document.getElementById('ui-hp-bar').style.width = `${hpPct}%`;

                document.getElementById('ui-atk').innerText = GameState.totalAtk;
                document.getElementById('ui-def').innerText = GameState.totalDef;

                // Slots Equipment
                const setEq = (id, item, defaultIcon) => {
                    const el = document.getElementById(id);
                    if (item) {
                        el.innerText = item.icon;
                        el.classList.add('active');
                    } else {
                        el.innerText = defaultIcon;
                        el.classList.remove('active');
                    }
                };
                setEq('slot-weapon', Player.equipment.weapon, "‚öîÔ∏è");
                setEq('slot-head', Player.equipment.head, "üõ°Ô∏è");
                setEq('slot-pet', Player.equipment.pet, "üêæ");

                // Inventory Grid
                const grid = document.getElementById('ui-inventory');
                grid.innerHTML = '';
                Player.inventory.forEach(item => {
                    const el = document.createElement('div');
                    el.className = 'inv-slot';
                    el.innerText = item.icon;
                    el.onclick = () => GameEngine.equipItem(item.uid);
                    grid.appendChild(el);
                });

                // Buttons State
                const btnMain = document.getElementById('btn-main-action');
                if (GameState.isProcessing || GameState.isCombat) {
                    btnMain.innerText = GameState.isCombat ? "COMBAT EN COURS..." : "EN COURS...";
                    btnMain.disabled = true;
                } else {
                    btnMain.innerText = "LANCER";
                    btnMain.disabled = false;
                }

                const btnAuto = document.getElementById('btn-auto');
                btnAuto.innerText = GameState.autoMode ? "AUTO: ON" : "AUTO: OFF";
                btnAuto.classList.toggle('active', GameState.autoMode);

                const btnSpeed = document.getElementById('btn-speed');
                btnSpeed.innerText = `VIT: x${GameState.speedMultiplier}`;

                // Upgrade Costs
                ['hp','atk','def'].forEach(stat => {
                    document.getElementById(`cost-${stat}`).innerText = (100 + Player.baseStats[stat]*50) + " ü™ô";
                });
            },

            // Gestion Combat Visuals
            setupCombatScreen: (icon, maxHp) => {
                document.getElementById('screen-mission').classList.add('hidden');
                document.getElementById('screen-combat').style.display = 'block';
                document.getElementById('ui-enemy-sprite').innerText = icon;
                document.getElementById('ui-enemy-hp-bar').style.width = '100%';
            },

            updateEnemyHp: (current, max) => {
                const pct = Math.max(0, (current / max) * 100);
                document.getElementById('ui-enemy-hp-bar').style.width = `${pct}%`;
            },

            returnToMissionScreen: () => {
                document.getElementById('screen-combat').style.display = 'none';
                document.getElementById('screen-mission').classList.remove('hidden');
            },

            animShakeElement: (id) => {
                const el = document.getElementById(id);
                el.classList.remove('shake-active');
                void el.offsetWidth; // Trigger reflow
                el.classList.add('shake-active');
            },

            // Logs & Tabs
            log: (msg) => {
                const container = document.getElementById('ui-logs');
                const line = document.createElement('div');
                line.className = 'log-message';
                line.innerText = `> ${msg}`;
                container.prepend(line);
                if (container.children.length > 50) container.lastChild.remove();
            },

            switchRightTab: (tab) => {
                if (tab === 'base') document.getElementById('hub-overlay').classList.remove('hidden');
            },

            closeHub: () => document.getElementById('hub-overlay').classList.add('hidden'),
            
            openSettings: () => document.getElementById('settings-modal').style.display = 'flex',
            closeSettings: () => document.getElementById('settings-modal').style.display = 'none'
        };

        // Lancement
        window.onload = GameEngine.init;

    </script>
</body>
</html>
