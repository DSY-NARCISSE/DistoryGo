<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Distory Go - V62 FULLY EXPANDED</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ==========================================================================
           1. CONFIGURATION CSS ET VARIABLES
           ========================================================================== */
        :root {
            --color-background-dark: #02050e;
            --color-panel-background: rgba(10, 15, 30, 0.98);
            --color-border: #1e293b;
            --color-blue-neon: #3b82f6;
            --color-gold: #fbbf24;
            --color-red-danger: #ef4444;
            --color-purple: #a855f7;
            --color-text-dim: #94a3b8;
        }

        body {
            background-color: var(--color-background-dark);
            color: white;
            font-family: 'Rajdhani', sans-serif;
            overflow: hidden;
            height: 100vh;
            user-select: none;
            margin: 0;
            padding: 0;
        }

        /* ==========================================================================
           2. ANIMATIONS
           ========================================================================== */
        
        /* Animation de respiration pour l'avatar */
        @keyframes animation-breathe {
            0% {
                transform: scale(1);
                filter: drop-shadow(0 0 10px rgba(59, 130, 246, 0.3));
            }
            50% {
                transform: scale(1.05);
                filter: drop-shadow(0 0 25px rgba(59, 130, 246, 0.6));
            }
            100% {
                transform: scale(1);
                filter: drop-shadow(0 0 10px rgba(59, 130, 246, 0.3));
            }
        }
        .anim-breathe {
            animation: animation-breathe 3s infinite ease-in-out;
        }

        /* Animation du Laser de Scan */
        @keyframes animation-scan {
            0% {
                top: -20px;
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            100% {
                top: 100%;
                opacity: 0;
            }
        }
        .laser-line {
            position: absolute;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--color-blue-neon);
            box-shadow: 0 0 20px var(--color-blue-neon);
            z-index: 50;
            pointer-events: none;
            display: none;
        }
        .laser-active {
            display: block;
            animation: animation-scan 0.8s linear forwards;
        }

        /* Animation de secousse (D√©g√¢ts) */
        @keyframes animation-shake {
            0% { transform: translate(0, 0); }
            25% { transform: translate(-5px, 5px); }
            75% { transform: translate(5px, -5px); }
            100% { transform: translate(0, 0); }
        }
        .anim-shake {
            animation: animation-shake 0.3s cubic-bezier(.36,.07,.19,.97) both;
        }

        /* ==========================================================================
           3. STRUCTURE DE LA PAGE (LAYOUT)
           ========================================================================== */
        .main-layout {
            display: grid;
            grid-template-columns: 350px 1fr 320px;
            gap: 15px;
            height: 100vh;
            padding: 15px;
            transition: filter 0.3s;
        }

        .layout-blur {
            filter: blur(8px);
            pointer-events: none;
        }

        .panel-container {
            background-color: var(--color-panel-background);
            border: 1px solid var(--color-border);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .panel-header {
            padding: 15px;
            background: rgba(255, 255, 255, 0.02);
            border-bottom: 1px solid var(--color-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 800;
            color: var(--color-blue-neon);
            text-transform: uppercase;
        }

        /* ==========================================================================
           4. PANNEAU GAUCHE : PILOTE
           ========================================================================== */
        .avatar-zone {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .hero-image {
            font-size: 130px;
        }

        .stats-container {
            padding: 20px;
        }

        .stats-box {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--color-border);
            padding: 10px;
            border-radius: 6px;
            text-align: center;
        }

        .hp-bar-background {
            width: 100%;
            height: 8px;
            background: #000;
            border: 1px solid #334155;
            border-radius: 4px;
            overflow: hidden;
        }

        .hp-bar-fill {
            height: 100%;
            background: var(--color-red-danger);
            width: 100%;
            transition: width 0.3s;
        }

        .equipment-row {
            padding: 15px;
            border-top: 1px solid var(--color-border);
            display: flex;
            gap: 10px;
            background: rgba(0, 0, 0, 0.2);
        }

        .equipment-slot {
            flex: 1;
            aspect-ratio: 1;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--color-border);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #475569;
        }

        .equipment-slot.active {
            color: white;
            border-color: var(--color-blue-neon);
            box-shadow: inset 0 0 10px rgba(59, 130, 246, 0.2);
        }

        /* ==========================================================================
           5. PANNEAU CENTRAL : JEU
           ========================================================================== */
        .viewport-container {
            flex-grow: 1;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .mission-text-large {
            font-size: 70px;
            font-weight: 900;
            text-transform: uppercase;
            line-height: 1;
        }

        .mission-subtitle {
            font-size: 14px;
            border: 1px solid var(--color-blue-neon);
            padding: 5px 20px;
            border-radius: 20px;
            color: var(--color-blue-neon);
            margin-top: 10px;
        }

        .enemy-container {
            display: none;
            text-align: center;
        }

        .enemy-image {
            font-size: 150px;
            filter: drop-shadow(0 0 30px rgba(220, 38, 38, 0.5));
        }

        .actions-container {
            height: 220px;
            border-top: 1px solid var(--color-border);
            padding: 15px;
            display: grid;
            grid-template-columns: 1fr 180px;
            gap: 15px;
            background: rgba(0, 0, 0, 0.2);
        }

        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 5px;
            align-content: start;
        }

        .inventory-item {
            aspect-ratio: 1;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--color-border);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            transition: 0.1s;
        }

        .inventory-item:hover {
            border-color: var(--color-blue-neon);
            background: rgba(59, 130, 246, 0.1);
        }

        .btn-launch-large {
            width: 100%;
            height: 60px;
            background: linear-gradient(180deg, #3b82f6, #1d4ed8);
            border: 1px solid #60a5fa;
            border-radius: 8px;
            color: white;
            font-size: 24px;
            font-weight: 800;
            text-transform: uppercase;
            cursor: pointer;
            transition: 0.1s;
            box-shadow: 0 4px 0 #1e40af;
        }

        .btn-launch-large:active {
            transform: translateY(4px);
            box-shadow: none;
        }

        .btn-launch-large:disabled {
            filter: grayscale(1);
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-control-small {
            flex: 1;
            background: transparent;
            border: 1px solid var(--color-border);
            color: var(--color-text-dim);
            font-size: 10px;
            font-weight: bold;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            text-transform: uppercase;
        }

        .btn-control-small.active {
            border-color: var(--color-blue-neon);
            color: white;
            background: rgba(59, 130, 246, 0.1);
        }

        /* ==========================================================================
           6. PANNEAU DROIT : LOGS
           ========================================================================== */
        .logs-container {
            flex-grow: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column-reverse;
            font-family: monospace;
            font-size: 12px;
            color: var(--color-text-dim);
        }

        .log-message {
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            margin-bottom: 4px;
            padding-bottom: 2px;
        }

        .tabs-container {
            display: flex;
            height: 50px;
            border-top: 1px solid var(--color-border);
        }

        .tab-button {
            flex: 1;
            background: transparent;
            border: none;
            color: #64748b;
            font-weight: 700;
            font-size: 12px;
            text-transform: uppercase;
            cursor: pointer;
        }

        .tab-button:hover {
            color: white;
        }

        .tab-button.active {
            color: white;
            border-bottom: 3px solid var(--color-blue-neon);
            background: rgba(255, 255, 255, 0.02);
        }

        /* ==========================================================================
           7. MODALES ET OVERLAYS
           ========================================================================== */
        .modal-fullscreen {
            position: fixed;
            inset: 0;
            background: var(--color-background-dark);
            z-index: 5000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .grid-character-select {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 40px;
        }

        .btn-character-option {
            font-size: 60px;
            padding: 30px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid var(--color-border);
            border-radius: 16px;
            cursor: pointer;
            transition: 0.2s;
        }

        .btn-character-option:hover {
            border-color: var(--color-blue-neon);
            transform: scale(1.1);
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 6000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .modal-box {
            background: #0f172a;
            border: 1px solid var(--color-blue-neon);
            padding: 40px;
            border-radius: 12px;
            text-align: center;
            width: 400px;
        }

        .element-hidden {
            display: none !important;
        }

        .text-gold {
            color: var(--color-gold);
        }
    </style>
</head>
<body>

    <div id="laser-effect" class="laser-line"></div>

    <div id="screen-boot" class="modal-fullscreen">
        <h1 class="text-4xl font-black text-white mb-10 tracking-widest">S√âLECTION PILOTE</h1>
        <div class="grid-character-select">
            <button class="btn-character-option" onclick="GameEngine.startNewGame('üêô')">üêô</button>
            <button class="btn-character-option" onclick="GameEngine.startNewGame('üêπ')">üêπ</button>
            <button class="btn-character-option" onclick="GameEngine.startNewGame('ü¶ä')">ü¶ä</button>
            <button class="btn-character-option" onclick="GameEngine.startNewGame('ü¶å')">ü¶å</button>
            <button class="btn-character-option" onclick="GameEngine.startNewGame('üêï')">üêï</button>
            <button class="btn-character-option" onclick="GameEngine.startNewGame('üê±')">üê±</button>
        </div>
        <button onclick="GameEngine.hardResetGame()" class="text-xs text-red-500 uppercase border-b border-transparent hover:border-red-500">Effacer les donn√©es</button>
    </div>

    <div id="screen-game" class="main-layout layout-blur">
        
        <div class="panel-container">
            <div class="panel-header">
                <span>PILOTE</span> 
                <span class="text-blue-400">COMMANDANT</span>
            </div>
            
            <div class="avatar-zone">
                <div class="absolute top-2 right-4 text-right">
                    <div class="text-[10px] text-gray-500 font-bold uppercase">Niveau</div>
                    <div id="ui-level-display" class="text-2xl font-bold">1</div>
                </div>
                <div id="ui-avatar-display" class="hero-image anim-breathe">?</div>
            </div>
            
            <div class="stats-container">
                <div class="flex justify-between text-[10px] font-bold text-gray-400 mb-1 uppercase">
                    <span>Int√©grit√©</span> 
                    <span id="ui-hp-text">100/100</span>
                </div>
                <div class="hp-bar-background">
                    <div id="ui-hp-fill" class="hp-bar-fill"></div>
                </div>
                
                <div class="grid grid-cols-2 gap-2 mt-4">
                    <div class="stats-box">
                        <div class="text-[10px] text-gray-500 font-bold">PUISSANCE</div>
                        <div id="ui-atk-display" class="text-2xl font-bold text-blue-400">10</div>
                    </div>
                    <div class="stats-box">
                        <div class="text-[10px] text-gray-500 font-bold">BLINDAGE</div>
                        <div id="ui-def-display" class="text-2xl font-bold text-blue-400">0</div>
                    </div>
                </div>
            </div>
            
            <div class="equipment-row">
                <div id="slot-weapon" class="equipment-slot">‚öîÔ∏è</div>
                <div id="slot-head" class="equipment-slot">üõ°Ô∏è</div>
                <div id="slot-pet" class="equipment-slot">üêæ</div>
            </div>
        </div>

        <div class="panel-container">
            <div class="panel-header">
                <span>ZONE <span id="ui-zone-display">1-1</span></span>
                <div class="flex gap-4">
                    <span class="text-gold">ü™ô <span id="ui-gold-display">0</span></span>
                    <span class="text-purple-400">‚ú® <span id="ui-gems-display">0</span></span>
                </div>
            </div>
            
            <div class="viewport-container">
                <div id="view-mission" class="mission-screen">
                    <div class="mission-text-large">MISSION</div>
                    <div id="ui-story-text" class="mission-subtitle">PR√äT AU D√âCOLLAGE</div>
                </div>
                
                <div id="view-combat" class="enemy-container">
                    <div class="enemy-hp-bar">
                        <div id="ui-enemy-hp-fill" class="enemy-hp-fill"></div>
                    </div>
                    <div id="ui-enemy-icon" class="enemy-image">üëæ</div>
                    <div class="mt-4 bg-red-900/30 border border-red-500 text-red-400 px-4 py-1 rounded font-bold uppercase inline-block">
                        Cible Hostile
                    </div>
                </div>
            </div>
            
            <div class="actions-container">
                <div class="flex flex-col">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-[10px] font-bold text-gray-500 uppercase">SOUTE</span>
                        <button onclick="GameEngine.openChest()" class="bg-purple-600 hover:bg-purple-500 text-white text-[10px] font-bold px-2 py-1 rounded">
                            COFFRE (5‚ú®)
                        </button>
                    </div>
                    <div id="inventory-grid" class="inventory-grid">
                        </div>
                </div>
                
                <div class="flex flex-col justify-end gap-2">
                    <button id="btn-action-main" onclick="GameEngine.triggerAction()" class="btn-launch-large">
                        LANCER
                    </button>
                    <div class="flex gap-2">
                        <button id="btn-auto-toggle" onclick="GameEngine.toggleAutoMode()" class="btn-control-small">AUTO: OFF</button>
                        <button id="btn-speed-toggle" onclick="GameEngine.toggleGameSpeed()" class="btn-control-small">VIT: x1</button>
                        <button onclick="UIManager.openSettingsModal()" class="btn-control-small" style="flex:0.3">‚öôÔ∏è</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="panel-container">
            <div class="panel-header">
                <span>TERMINAL</span>
            </div>
            <div id="logs-container" class="logs-container">
                <div class="log-message">> Syst√®me pr√™t.</div>
            </div>
            <div class="tabs-container">
                <button class="tab-button active" onclick="UIManager.switchTab('logs')">JOURNAL</button>
                <button class="tab-button" onclick="UIManager.switchTab('hub')">BASE</button>
            </div>
        </div>
    </div>

    <div id="modal-hub" class="modal-overlay hidden" style="background: rgba(2,5,14,0.95); display: none;">
        <h2 class="text-4xl font-bold text-white mb-10 italic">AM√âLIORATION BASE</h2>
        <div class="grid grid-cols-1 gap-6 w-80">
            <div onclick="GameEngine.upgradeStat('hp')" class="bg-white/5 border border-blue-900 p-4 rounded hover:border-blue-500 cursor-pointer flex justify-between items-center">
                <div>
                    <div class="text-xs text-gray-500 font-bold">STRUCTURE</div>
                    <div class="text-xl font-bold text-white">+20 PV</div>
                </div>
                <div id="cost-hp" class="text-gold font-bold">100</div>
            </div>
            <div onclick="GameEngine.upgradeStat('atk')" class="bg-white/5 border border-blue-900 p-4 rounded hover:border-blue-500 cursor-pointer flex justify-between items-center">
                <div>
                    <div class="text-xs text-gray-500 font-bold">FORCE</div>
                    <div class="text-xl font-bold text-white">+5 ATK</div>
                </div>
                <div id="cost-atk" class="text-gold font-bold">100</div>
            </div>
            <div onclick="GameEngine.upgradeStat('def')" class="bg-white/5 border border-blue-900 p-4 rounded hover:border-blue-500 cursor-pointer flex justify-between items-center">
                <div>
                    <div class="text-xs text-gray-500 font-bold">D√âFENSE</div>
                    <div class="text-xl font-bold text-white">+2 DEF</div>
                </div>
                <div id="cost-def" class="text-gold font-bold">100</div>
            </div>
        </div>
        <button onclick="UIManager.closeHubModal()" class="mt-12 text-blue-500 font-bold uppercase hover:text-white">RETOUR</button>
    </div>

    <div id="modal-settings" class="modal-overlay">
        <div class="modal-box">
            <h2 class="text-2xl font-bold text-white mb-8">PARAM√àTRES</h2>
            <button onclick="GameEngine.hardResetGame()" class="w-full py-3 bg-red-900/50 border border-red-500 text-white rounded font-bold hover:bg-red-900 mb-4">
                R√âINITIALISER TOUT
            </button>
            <button onclick="UIManager.closeSettingsModal()" class="w-full py-3 bg-slate-800 rounded text-white font-bold hover:bg-slate-700">
                RETOUR
            </button>
        </div>
    </div>

    <script>
        /* ==========================================================================
           1. DONN√âES DU JEU
           ========================================================================== */
        const GameDatabase = {
            enemies: [
                { name: "Drone", icon: "üõ∏", hp: 50, atk: 5 },
                { name: "Xeno", icon: "üëæ", hp: 80, atk: 8 },
                { name: "Sonde", icon: "üõ∞Ô∏è", hp: 40, atk: 12 }
            ],
            items: [
                { name: "Lame", icon: "‚öîÔ∏è", type: "weapon", stat: 10 },
                { name: "Casque", icon: "üõ°Ô∏è", type: "head", stat: 20 },
                { name: "Bot", icon: "ü§ñ", type: "pet", stat: 5 }
            ],
            stories: [
                "Signal radio capt√©.",
                "D√©bris analys√©s.",
                "Pluie de m√©t√©orites.",
                "Station abandonn√©e.",
                "Capsule de survie.",
                "Anomalie magn√©tique."
            ]
        };

        /* ==========================================================================
           2. VARIABLES D'√âTAT GLOBALES
           ========================================================================== */
        let PlayerState = {
            avatar: null,
            gold: 0,
            gems: 20,
            baseStats: { hp: 0, atk: 0, def: 0 }, // NOM CORRIG√â : baseStats
            inventory: [],
            equipment: { weapon: null, head: null, pet: null }
        };

        let RunState = {
            isActive: false,
            isBusy: false,
            day: 0,
            currentHp: 100,
            maxHp: 100,
            atk: 10,
            def: 0,
            autoMode: false,
            speedMultiplier: 1
        };

        let CombatState = {
            isActive: false,
            enemyHp: 0,
            enemyMaxHp: 0,
            enemyAtk: 0
        };

        let autoIntervalTimer = null;

        /* ==========================================================================
           3. MOTEUR DE JEU (LOGIQUE)
           ========================================================================== */
        const GameEngine = {
            
            // Initialisation
            initializeGame: function() {
                let savedData = localStorage.getItem('distory_v62'); // Nouvelle cl√© de sauvegarde propre
                if (savedData) {
                    PlayerState = JSON.parse(savedData);
                    // V√©rification que l'avatar est bien d√©fini avant de lancer
                    if (PlayerState.avatar) {
                        document.getElementById('screen-boot').classList.add('hidden');
                        document.getElementById('screen-game').classList.remove('blur');
                        GameEngine.recalculateStats();
                        UIManager.updateAllElements();
                    }
                }
            },

            // D√©marrage nouvelle partie
            startNewGame: function(avatarEmoji) {
                PlayerState.avatar = avatarEmoji;
                GameEngine.saveGame();
                document.getElementById('screen-boot').classList.add('hidden');
                document.getElementById('screen-game').classList.remove('blur');
                UIManager.updateAllElements();
            },

            // Action principale (Bouton Lancer)
            triggerAction: function() {
                // Si occup√© ou en combat, on ne fait rien
                if (RunState.isBusy || CombatState.isActive) return;
                
                RunState.isBusy = true;

                // Initialisation premier jour
                if (!RunState.isActive) {
                    RunState.isActive = true;
                    RunState.day = 0;
                    UIManager.logMessage("Mission D√©marr√©e.");
                }
                
                // Animation Laser
                const laserElement = document.getElementById('laser-effect');
                laserElement.classList.remove('laser-active');
                void laserElement.offsetWidth; // Force Reflow
                laserElement.classList.add('laser-active');

                // D√©lai d'action
                setTimeout(() => {
                    RunState.day++;
                    GameEngine.recalculateStats();

                    // Logique : Combat ou Histoire
                    if (RunState.day % 5 === 0) {
                        GameEngine.startCombat();
                    } else {
                        // √âv√©nement pacifique
                        let goldFound = 20 + Math.floor(Math.random() * 10);
                        let randomStory = GameDatabase.stories[Math.floor(Math.random() * GameDatabase.stories.length)];
                        
                        PlayerState.gold += goldFound;
                        
                        UIManager.setStoryText(randomStory);
                        UIManager.logMessage(`> ${randomStory} (+${goldFound} Or)`);
                        
                        UIManager.updateAllElements();
                        GameEngine.endCycle();
                    }
                }, 600 / RunState.speedMultiplier);
            },

            // Fin de cycle
            endCycle: function() {
                RunState.isBusy = false;
                GameEngine.saveGame();
                
                // Gestion Mode Auto
                if (RunState.autoMode && RunState.isActive && !CombatState.isActive) {
                    autoIntervalTimer = setTimeout(GameEngine.triggerAction, 800 / RunState.speedMultiplier);
                }
            },

            // Combat : Initialisation
            startCombat: function() {
                CombatState.isActive = true;
                
                let enemyTemplate = GameDatabase.enemies[Math.floor(Math.random() * GameDatabase.enemies.length)];
                let multiplier = 1 + (RunState.day * 0.1);
                
                CombatState.enemyMaxHp = Math.floor(enemyTemplate.hp * multiplier);
                CombatState.enemyHp = CombatState.enemyMaxHp;
                CombatState.enemyAtk = Math.floor(enemyTemplate.atk * multiplier);
                
                UIManager.showCombatView(true, enemyTemplate.icon);
                UIManager.logMessage(`! COMBAT : ${enemyTemplate.name} !`);
                
                setTimeout(GameEngine.processCombatRound, 800 / RunState.speedMultiplier);
            },

            // Combat : Tour par tour
            processCombatRound: function() {
                if (!CombatState.isActive) return;

                // 1. Joueur attaque
                document.getElementById('ui-avatar-display').classList.add('shake');
                setTimeout(() => document.getElementById('ui-avatar-display').classList.remove('shake'), 300);
                
                CombatState.enemyHp -= RunState.atk;
                UIManager.updateCombatBar();

                // Victoire ?
                if (CombatState.enemyHp <= 0) {
                    CombatState.isActive = false;
                    let reward = 50 + (RunState.day * 2);
                    PlayerState.gold += reward;
                    
                    UIManager.logMessage(`> Victoire (+${reward} Or).`);
                    UIManager.showCombatView(false); // Retour vue mission
                    UIManager.updateAllElements();
                    GameEngine.endCycle();
                    return;
                }

                // 2. Ennemi riposte
                setTimeout(() => {
                    let damage = Math.max(1, CombatState.enemyAtk - RunState.def);
                    RunState.currentHp -= damage;
                    
                    UIManager.updateAllElements();
                    
                    // Animation secousse ennemi qui tape
                    document.getElementById('view-combat').classList.add('shake');
                    setTimeout(() => document.getElementById('view-combat').classList.remove('shake'), 300);

                    // D√©faite ?
                    if (RunState.currentHp <= 0) {
                        CombatState.isActive = false;
                        RunState.isActive = false;
                        RunState.autoMode = false;
                        RunState.currentHp = 0;
                        
                        UIManager.logMessage("!!! ECHEC CRITIQUE !!!");
                        UIManager.showCombatView(false);
                        UIManager.updateAllElements();
                        GameEngine.saveGame();
                    } else {
                        // Prochain tour
                        setTimeout(GameEngine.processCombatRound, 800 / RunState.speedMultiplier);
                    }
                }, 400 / RunState.speedMultiplier);
            },

            // Coffre et Inventaire
            openChest: function() {
                if (PlayerState.gems >= 5) {
                    PlayerState.gems -= 5;
                    // Cr√©ation d'un item unique
                    let newItem = { ...GameDatabase.items[Math.floor(Math.random() * GameDatabase.items.length)], uid: Date.now() };
                    
                    PlayerState.inventory.push(newItem);
                    UIManager.logMessage(`> Coffre: ${newItem.name}`);
                    
                    GameEngine.checkInventoryFusion();
                    UIManager.updateAllElements();
                    GameEngine.saveGame();
                } else {
                    UIManager.logMessage("> Pas assez de gemmes.");
                }
            },

            checkInventoryFusion: function() {
                let counts = {};
                PlayerState.inventory.forEach(i => counts[i.name] = (counts[i.name] || 0) + 1);
                
                for (let name in counts) {
                    if (counts[name] >= 3) {
                        let baseItem = PlayerState.inventory.find(i => i.name === name);
                        
                        // Retirer 3 items
                        let removedCount = 0;
                        PlayerState.inventory = PlayerState.inventory.filter(i => {
                            if (i.name === name && removedCount < 3) {
                                removedCount++;
                                return false;
                            }
                            return true;
                        });

                        // Ajouter l'item am√©lior√©
                        PlayerState.inventory.push({
                            ...baseItem,
                            stat: Math.floor(baseItem.stat * 2.2),
                            name: baseItem.name + "+",
                            uid: Date.now()
                        });

                        UIManager.logMessage(`*** FUSION: ${baseItem.name} ***`);
                        GameEngine.checkInventoryFusion(); // R√©cursif
                        return;
                    }
                }
            },

            equipItem: function(itemUid) {
                let index = PlayerState.inventory.findIndex(i => i.uid === itemUid);
                if (index > -1) {
                    let item = PlayerState.inventory[index];
                    
                    // Si un item est d√©j√† √©quip√©, on le remet dans l'inventaire
                    if (PlayerState.equipment[item.type]) {
                        PlayerState.inventory.push(PlayerState.equipment[item.type]);
                    }
                    
                    // √âquiper
                    PlayerState.equipment[item.type] = item;
                    // Retirer de l'inventaire
                    PlayerState.inventory.splice(index, 1);
                    
                    GameEngine.recalculateStats();
                    UIManager.updateAllElements();
                    GameEngine.saveGame();
                }
            },

            // Am√©liorations (Hub)
            upgradeStat: function(statKey) {
                let cost = 100 + (PlayerState.baseStats[statKey] * 50);
                if (PlayerState.gold >= cost) {
                    PlayerState.gold -= cost;
                    PlayerState.baseStats[statKey]++;
                    GameEngine.recalculateStats();
                    UIManager.updateAllElements();
                    GameEngine.saveGame();
                }
            },

            // Calcul des Stats
            recalculateStats: function() {
                let maxHealth = 100 + (PlayerState.baseStats.hp * 20);
                let attack = 10 + (PlayerState.baseStats.atk * 5);
                let defense = 0 + (PlayerState.baseStats.def * 2);

                if (PlayerState.equipment.weapon) attack += PlayerState.equipment.weapon.stat;
                if (PlayerState.equipment.head) maxHealth += PlayerState.equipment.head.stat;
                if (PlayerState.equipment.pet) attack += PlayerState.equipment.pet.stat;

                RunState.maxHp = maxHealth;
                RunState.atk = attack;
                RunState.def = defense;

                // R√©g√©n√©ration passive hors combat
                if (!CombatState.isActive) {
                    RunState.currentHp = Math.min(RunState.currentHp + 5, RunState.maxHp);
                }
            },

            // Contr√¥les
            toggleAutoMode: function() {
                RunState.autoMode = !RunState.autoMode;
                UIManager.updateAllElements();
                
                // Si on active l'auto et que rien ne se passe, on lance
                if (RunState.autoMode && RunState.isActive && !RunState.isBusy && !CombatState.isActive) {
                    GameEngine.triggerAction();
                } else {
                    clearTimeout(autoIntervalTimer);
                }
            },

            toggleGameSpeed: function() {
                RunState.speedMultiplier = (RunState.speedMultiplier === 1) ? 2 : 1;
                UIManager.updateAllElements();
            },

            hardResetGame: function() {
                localStorage.removeItem('distory_v62');
                location.reload();
            },

            saveGame: function() {
                localStorage.setItem('distory_v62', JSON.stringify(PlayerState));
            }
        };

        /* ==========================================================================
           4. GESTION DE L'INTERFACE (UI)
           ========================================================================== */
        const UIManager = {
            
            updateAllElements: function() {
                // Ressources
                document.getElementById('ui-gold-display').innerText = PlayerState.gold;
                document.getElementById('ui-gems-display').innerText = PlayerState.gems;
                
                // Avatar et Niveau
                document.getElementById('ui-avatar-display').innerText = PlayerState.avatar;
                document.getElementById('ui-level-display').innerText = Math.floor(RunState.day / 10) + 1;
                document.getElementById('ui-zone-display').innerText = `1-${RunState.day}`;

                // Stats Barres
                document.getElementById('ui-hp-text').innerText = `${Math.floor(RunState.currentHp)}/${RunState.maxHp}`;
                document.getElementById('ui-hp-fill').style.width = `${(RunState.currentHp / RunState.maxHp) * 100}%`;
                
                // Stats Chiffres
                document.getElementById('ui-atk-display').innerText = RunState.atk;
                document.getElementById('ui-def-display').innerText = RunState.def;
                
                // Inventaire (Reconstruction compl√®te √† chaque update pour √©viter les bugs)
                let grid = document.getElementById('inventory-grid');
                grid.innerHTML = '';
                PlayerState.inventory.forEach(item => {
                    let div = document.createElement('div');
                    div.className = 'inventory-item';
                    div.innerText = item.icon; // .icon
                    div.onclick = () => GameEngine.equipItem(item.uid);
                    grid.appendChild(div);
                });

                // √âquipement (Affichage)
                const setEquipmentSlot = (elementId, item, defaultIcon) => {
                    let element = document.getElementById(elementId);
                    if (item) {
                        element.innerText = item.icon;
                        element.classList.add('active');
                    } else {
                        element.innerText = defaultIcon;
                        element.classList.remove('active');
                    }
                };
                setEquipmentSlot('slot-weapon', PlayerState.equipment.weapon, "‚öîÔ∏è");
                setEquipmentSlot('slot-head', PlayerState.equipment.head, "üõ°Ô∏è");
                setEquipmentSlot('slot-pet', PlayerState.equipment.pet, "üêæ");

                // Boutons
                document.getElementById('btn-action-main').innerText = (RunState.isBusy || CombatState.isActive) ? "..." : "LANCER";
                document.getElementById('btn-action-main').disabled = (RunState.isBusy || CombatState.isActive);
                
                document.getElementById('btn-auto-toggle').innerText = RunState.autoMode ? "AUTO: ON" : "AUTO: OFF";
                document.getElementById('btn-auto-toggle').classList.toggle('active', RunState.autoMode);
                
                document.getElementById('btn-speed-toggle').innerText = `VIT: x${RunState.speedMultiplier}`;

                // Co√ªts du Hub
                ['hp', 'atk', 'def'].forEach(key => {
                    document.getElementById(`cost-${key}`).innerText = (100 + PlayerState.baseStats[key] * 50) + " ü™ô";
                });
            },

            showCombatView: function(isCombat, icon) {
                document.getElementById('view-mission').style.display = isCombat ? 'none' : 'block';
                document.getElementById('view-combat').style.display = isCombat ? 'block' : 'none';
                
                if (isCombat && icon) {
                    document.getElementById('ui-enemy-icon').innerText = icon;
                    document.getElementById('ui-enemy-hp-fill').style.width = '100%';
                }
            },

            updateCombatBar: function() {
                let pct = (CombatState.enemyHp / CombatState.enemyMaxHp) * 100;
                document.getElementById('ui-enemy-hp-fill').style.width = `${pct}%`;
            },

            setStoryText: function(text) {
                document.getElementById('ui-story-text').innerText = text;
            },

            logMessage: function(message) {
                let logContainer = document.getElementById('logs-container');
                logContainer.innerHTML = `<div class="log-message">> ${message}</div>` + logContainer.innerHTML;
            },

            // Onglets et Modales
            switchTab: function(tabName) {
                if (tabName === 'hub') {
                    document.getElementById('modal-hub').style.display = 'flex';
                }
            },

            closeHubModal: function() {
                document.getElementById('modal-hub').style.display = 'none';
            },

            openSettingsModal: function() {
                document.getElementById('modal-settings').style.display = 'flex';
            },

            closeSettingsModal: function() {
                document.getElementById('modal-settings').style.display = 'none';
            }
        };

        // Lancement au chargement de la page
        window.onload = GameEngine.initializeGame;

    </script>
</body>
</html>
