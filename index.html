<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Distory Go - V98 HOSTILE-TAKEOVER</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* === CONFIGURATION GRAPHIQUE GLOBALE === */
        :root {
            --bg-dark: #02050e;
            --panel-bg: rgba(10, 15, 30, 0.95);
            --border-color: #1e293b;
            --highlight-blue: #3b82f6;
            --highlight-cyan: #22d3ee;
            --highlight-purple: #8b5cf6;
            --text-main: #94a3b8;
            --text-light: #f8fafc;
            --hp-red: #be123c;
            --gold: #fbbf24;
            --crit-color: #f59e0b;
            --skill-green: #10b981;
        }

        body { background-color: var(--bg-dark); color: var(--text-light); font-family: 'Rajdhani', sans-serif; height: 100vh; overflow: hidden; user-select: none; background-image: radial-gradient(circle at 50% 50%, #0f172a 0%, #02050e 100%); }

        /* TOOLTIP */
        #tooltip { position: fixed; background: rgba(2, 6, 23, 0.98); border: 1px solid var(--highlight-blue); color: var(--text-light); padding: 10px 14px; border-radius: 6px; font-size: 12px; pointer-events: none; z-index: 9999; display: none; box-shadow: 0 4px 20px rgba(0,0,0,0.8); white-space: pre-line; max-width: 250px; text-align: left; backdrop-filter: blur(4px); }
        #tooltip strong { color: var(--highlight-cyan); display: block; margin-bottom: 4px; font-size: 14px; text-transform: uppercase; }
        #tooltip .stat-row { display: flex; justify-content: space-between; width: 100%; border-bottom: 1px solid rgba(255,255,255,0.1); padding: 2px 0; }
        #tooltip .stat-row span:last-child { color: var(--highlight-blue); font-weight: bold; }

        /* ANIMATIONS */
        @keyframes hero-float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes pet-float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        @keyframes enemy-float { 0%, 100% { transform: translateY(0) scale(1); } 50% { transform: translateY(15px) scale(1.05); } }
        @keyframes attack-lunge { 0% { transform: translateX(0); } 50% { transform: translateX(80px) scale(1.1); } 100% { transform: translateX(0); } }
        @keyframes pet-attack-lunge { 0% { transform: translateX(0); } 50% { transform: translateX(120px) scale(1.2); } 100% { transform: translateX(0); } }
        @keyframes enemy-lunge { 0% { transform: translateX(0); } 40% { transform: translateX(-120px) scale(1.3); } 100% { transform: translateX(0); } }
        @keyframes hit-shake { 0% { transform: translate(0, 0); filter: brightness(1); } 20% { translate: -5px 5px; filter: brightness(2) sepia(1) hue-rotate(-50deg) saturate(5); } 40% { translate: 5px -5px; } 60% { translate: -5px 5px; } 80% { translate: 5px -5px; } 100% { translate: 0 0; filter: brightness(1); } }
        @keyframes enemy-shake-hit { 0% { transform: translate(0, 0) scale(1); filter: brightness(1); } 20% { transform: translate(10px, -10px) rotate(5deg) scale(0.9); filter: brightness(5) sepia(1) saturate(10) hue-rotate(-50deg); } 40% { transform: translate(-10px, 10px) rotate(-5deg); } 60% { transform: translate(5px, -5px); } 100% { transform: translate(0, 0) scale(1); filter: brightness(1); } }
        @keyframes crit-shake { 0% { transform: scale(1); } 50% { transform: scale(1.5) rotate(5deg); filter: brightness(2) drop-shadow(0 0 10px var(--crit-color)); } 100% { transform: scale(1); } }
        @keyframes hp-pulse { 0% { filter: brightness(1); box-shadow: 0 0 5px rgba(239, 68, 68, 0.6); } 100% { filter: brightness(1.5); box-shadow: 0 0 20px rgba(239, 68, 68, 0.9); } }
        @keyframes hp-gradient-move { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        @keyframes boss-intro { 0% { transform: scale(0.1); opacity: 0; filter: blur(10px); } 60% { transform: scale(1.2); opacity: 1; filter: blur(0); } 100% { transform: scale(1); } }
        @keyframes ai-pulse { 0% { box-shadow: 0 0 5px #a855f7; } 50% { box-shadow: 0 0 20px #a855f7, 0 0 40px #a855f7; } 100% { box-shadow: 0 0 5px #a855f7; } }
        @keyframes status-poison-pulse { 0% { filter: drop-shadow(0 0 2px #84cc16) hue-rotate(45deg); } 50% { filter: drop-shadow(0 0 15px #84cc16) hue-rotate(45deg); } 100% { filter: drop-shadow(0 0 2px #84cc16) hue-rotate(45deg); } }
        @keyframes status-burn-pulse { 0% { filter: drop-shadow(0 0 2px #f97316) sepia(1) saturate(3) hue-rotate(-30deg); } 50% { filter: drop-shadow(0 0 15px #f97316) sepia(1) saturate(5) hue-rotate(-40deg); } 100% { filter: drop-shadow(0 0 2px #f97316) sepia(1) saturate(3) hue-rotate(-30deg); } }
        @keyframes fx-shock { 0% { filter: brightness(1); transform: translateX(0); } 25% { filter: brightness(5) sepia(1) hue-rotate(0deg) saturate(5); transform: translateX(-5px); } 50% { transform: translateX(5px); } 100% { filter: brightness(1); transform: translateX(0); } }
        @keyframes fx-explode { 0% { transform: scale(1); } 50% { transform: scale(1.5); filter: brightness(3) sepia(1) saturate(5); } 100% { transform: scale(1); filter: brightness(1); } }
        @keyframes fx-bleed { 0% { color: inherit; } 50% { color: #ef4444; transform: scale(0.95) rotate(-5deg); } 100% { color: inherit; } }
        @keyframes float-up-fade { 0% { transform: translateY(0) scale(0.5); opacity: 0; } 20% { transform: translateY(-10px) scale(1.2); opacity: 1; } 100% { transform: translateY(-80px) scale(1); opacity: 0; } }
        @keyframes resource-pop-anim { 0% { transform: scale(1); filter: brightness(1); } 50% { transform: scale(1.4); filter: brightness(1.5) drop-shadow(0 0 5px currentColor); } 100% { transform: scale(1); filter: brightness(1); } }

        .anim-hero-float { animation: hero-float 4s ease-in-out infinite; }
        .anim-pet-float { animation: pet-float 3s ease-in-out infinite; }
        .anim-enemy-float { animation: enemy-float 3s ease-in-out infinite alternate-reverse; }
        .anim-attacking { animation: attack-lunge 0.3s ease-in-out forwards; }
        .anim-pet-attacking { animation: pet-attack-lunge 0.3s ease-in-out forwards; }
        .anim-enemy-attacking { animation: enemy-lunge 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .anim-hit { animation: hit-shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        .anim-enemy-hit { animation: enemy-shake-hit 0.4s ease-out forwards; }
        .anim-crit { animation: crit-shake 0.4s ease-out forwards; color: var(--crit-color) !important; }
        .anim-boss-spawn { animation: boss-intro 1.5s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards; }
        .anim-ai-loading { animation: ai-pulse 1.5s infinite; border-color: #a855f7 !important; color: #a855f7 !important; }
        .status-poison { animation: status-poison-pulse 1.5s infinite; }
        .status-burn { animation: status-burn-pulse 0.8s infinite; }
        .status-frozen { filter: drop-shadow(0 0 10px #67e8f9) brightness(1.2) hue-rotate(170deg); animation: none !important; }
        .status-weak { filter: grayscale(100%) opacity(0.6); transform: scale(0.9); }
        .fx-shock { animation: fx-shock 0.3s linear forwards; }
        .fx-explode { animation: fx-explode 0.4s ease-out forwards; }
        .fx-bleed { animation: fx-bleed 0.5s ease-in-out forwards; }
        .resource-pop { animation: resource-pop-anim 0.3s ease-out; }
        
        .pet-avatar { position: absolute; bottom: 20px; right: 40px; font-size: 60px; filter: drop-shadow(0 0 15px rgba(59, 130, 246, 0.6)); z-index: 10; }

        /* LAYOUT */
        .main-layout { display: grid; grid-template-columns: 350px 1fr 320px; gap: 16px; height: 100vh; padding: 16px; transition: filter 0.3s ease; }
        .game-panel { background-color: var(--panel-bg); border: 1px solid var(--border-color); border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; position: relative; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5); }
        .panel-header { padding: 12px 16px; background: rgba(255, 255, 255, 0.03); border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; font-size: 14px; font-weight: 700; letter-spacing: 1px; color: var(--highlight-blue); text-transform: uppercase; }

        .bio-container { flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; padding: 20px; }
        .hero-avatar { width: 220px; height: 220px; filter: drop-shadow(0 0 20px rgba(59, 130, 246, 0.3)); transition: transform 0.2s; display: flex; align-items: center; justify-content: center; }
        .hero-avatar svg { width: 100%; height: 100%; overflow: visible; }
        .hero-avatar.cyber-octo { filter: drop-shadow(0 0 25px rgba(34, 211, 238, 0.5)); }
        .hero-avatar.mecha-hamster { filter: drop-shadow(0 0 25px rgba(249, 115, 22, 0.5)); }
        .hero-avatar.holo-fox { filter: drop-shadow(0 0 25px rgba(168, 85, 247, 0.5)); }
        .hero-avatar.neon-stag { filter: drop-shadow(0 0 25px rgba(34, 197, 94, 0.5)); }
        .hero-avatar.robo-dog { filter: drop-shadow(0 0 25px rgba(59, 130, 246, 0.5)); }
        .hero-avatar.neko-mancer { filter: drop-shadow(0 0 25px rgba(236, 72, 153, 0.5)); }

        .level-badge { position: absolute; top: 10px; right: 10px; text-align: right; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 0 20px 10px 20px; }
        .stat-card { background: rgba(255, 255, 255, 0.02); border: 1px solid var(--border-color); border-radius: 6px; padding: 10px; text-align: center; cursor: help; }
        .stat-title { font-size: 10px; color: var(--text-main); font-weight: 700; text-transform: uppercase; }
        .stat-value { font-size: 24px; font-weight: 700; color: white; }
        .hp-bar-container { width: 100%; padding: 0 20px 10px 20px; cursor: help; }
        .hp-track { width: 100%; height: 10px; background: #000; border: 1px solid var(--border-color); border-radius: 6px; overflow: hidden; }
        .hp-fill { height: 100%; width: 100%; transition: width 0.3s ease-out, background 0.5s ease, box-shadow 0.5s ease; background-size: 400% 100%; animation: hp-gradient-move 4s linear infinite; }
        .hp-high { background: linear-gradient(90deg, #10b981, #34d399, #10b981); box-shadow: 0 0 10px rgba(16, 185, 129, 0.4); }
        .hp-mid { background: linear-gradient(90deg, #f59e0b, #fbbf24, #f59e0b); box-shadow: 0 0 10px rgba(245, 158, 11, 0.4); }
        .hp-low { background: linear-gradient(90deg, #ef4444, #dc2626, #ef4444); animation: hp-pulse 0.8s infinite alternate, hp-gradient-move 2s linear infinite; }
        .shield-bar { width: 100%; height: 4px; background: rgba(30, 58, 138, 0.3); border-radius: 2px; overflow: hidden; margin-bottom: 2px; }
        .shield-fill { height: 100%; width: 0%; background: #22d3ee; box-shadow: 0 0 8px #22d3ee; transition: width 0.3s ease-out; }

        .equipment-slots { display: flex; gap: 10px; padding: 20px; background: rgba(0,0,0,0.3); border-top: 1px solid var(--border-color); }
        .skills-list { display: flex; flex-wrap: wrap; gap: 4px; padding: 0 20px 10px 20px; justify-content: center; max-height: 80px; overflow-y: auto; }
        .skill-tag { font-size: 10px; background: rgba(16, 185, 129, 0.2); border: 1px solid var(--skill-green); color: var(--skill-green); padding: 2px 6px; border-radius: 4px; cursor: help; }

        .mission-display { flex-grow: 1; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; overflow: hidden; padding: 20px; }
        .mission-title { font-size: 80px; font-weight: 900; color: white; text-transform: uppercase; letter-spacing: -2px; text-shadow: 0 0 20px rgba(0,0,0,0.5); margin-bottom: 20px; }
        .mission-subtitle { font-size: 16px; line-height: 1.5; color: var(--highlight-cyan); border: 1px solid var(--border-color); padding: 15px 25px; border-radius: 8px; background: rgba(15, 23, 42, 0.8); max-width: 90%; text-align: center; font-style: italic; box-shadow: 0 4px 15px rgba(0,0,0,0.3); min-height: 80px; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        
        /* V98: ENEMY DISPLAY UPDATE */
        .enemy-display { width: 220px; height: 220px; filter: drop-shadow(0 0 20px rgba(220, 38, 38, 0.4)); transition: transform 0.1s; display: flex; align-items: center; justify-content: center; }
        .enemy-display svg { width: 100%; height: 100%; overflow: visible; }
        
        .bottom-action-area { height: 200px; background: rgba(0,0,0,0.2); border-top: 1px solid var(--border-color); padding: 15px; display: grid; grid-template-columns: 1fr 200px; gap: 15px; }
        .inventory-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; align-content: start; overflow-y: auto; max-height: 100%; padding-right: 4px; }
        .inventory-grid::-webkit-scrollbar { width: 4px; }
        .inventory-grid::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); }
        .inventory-grid::-webkit-scrollbar-thumb { background: var(--highlight-blue); border-radius: 2px; }

        .item-slot { aspect-ratio: 1; background: rgba(255,255,255,0.03); border: 2px solid var(--border-color); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; transition: all 0.2s; position: relative; }
        .item-slot:hover { border-color: var(--highlight-blue); transform: scale(1.05); background: rgba(59, 130, 246, 0.1); }
        .item-slot.equipped { border-color: var(--gold); box-shadow: inset 0 0 10px rgba(251, 191, 36, 0.2); }
        .rarity-0 { border-color: var(--common); }
        .rarity-1 { border-color: var(--rare); box-shadow: inset 0 0 5px var(--rare); }
        .rarity-2 { border-color: var(--epic); box-shadow: inset 0 0 8px var(--epic); }
        .rarity-3 { border-color: var(--legendary); box-shadow: inset 0 0 12px var(--legendary); animation: hp-pulse 2s infinite; }

        .main-btn { width: 100%; height: 70px; background: linear-gradient(to bottom, #3b82f6, #1d4ed8); border: 1px solid #60a5fa; border-radius: 8px; color: white; font-size: 24px; font-weight: 800; text-transform: uppercase; cursor: pointer; transition: all 0.1s; box-shadow: 0 4px 0 #1e40af; }
        .main-btn:active { transform: translateY(4px); box-shadow: 0 0 0 #1e40af; }
        .main-btn:disabled { filter: grayscale(100%); opacity: 0.5; cursor: not-allowed; }
        .base-btn { width: 100%; height: 50px; background: linear-gradient(to bottom, #475569, #1e293b); border: 1px solid #64748b; border-radius: 8px; color: #cbd5e1; font-size: 18px; font-weight: 700; text-transform: uppercase; cursor: pointer; transition: all 0.1s; box-shadow: 0 4px 0 #0f172a; margin-bottom: 8px; }
        .base-btn:active { transform: translateY(4px); box-shadow: 0 0 0 #0f172a; }
        .base-btn:hover { background: linear-gradient(to bottom, #64748b, #334155); color: white; border-color: #94a3b8; }
        .rank-btn { width: 100%; height: 40px; background: #0f172a; border: 1px solid var(--gold); border-radius: 6px; color: var(--gold); font-size: 14px; font-weight: 700; text-transform: uppercase; cursor: pointer; transition: 0.2s; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .rank-btn:hover { background: rgba(251, 191, 36, 0.1); box-shadow: 0 0 10px rgba(251, 191, 36, 0.2); }
        .map-btn { font-size: 20px; color: var(--highlight-cyan); border: 1px solid var(--highlight-cyan); border-radius: 4px; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; margin-right: 10px; }
        .map-btn:hover { background: rgba(34, 211, 238, 0.2); box-shadow: 0 0 10px var(--highlight-cyan); }
        .ai-mode-btn { background: linear-gradient(to right, #4c1d95, #6d28d9); border-color: #a78bfa; }

        .choice-btn { width: 100%; padding: 20px; margin-bottom: 12px; border: 1px solid rgba(59, 130, 246, 0.3); background: rgba(15, 23, 42, 0.8); color: #e2e8f0; font-family: 'Share Tech Mono', monospace; font-size: 16px; font-weight: normal; border-radius: 4px; cursor: pointer; transition: all 0.2s ease; text-align: left; position: relative; overflow: hidden; display: flex; align-items: center; }
        .choice-btn:hover { background: rgba(59, 130, 246, 0.15); border-color: var(--highlight-blue); transform: translateX(5px); box-shadow: -4px 0 0 var(--highlight-blue); }
        .choice-btn::before { content: "‚ñ∂"; margin-right: 15px; color: var(--highlight-blue); font-size: 12px; opacity: 0.7; }
        .choice-btn:hover::before { color: white; opacity: 1; }
        .choice-risky { border-color: rgba(220, 38, 38, 0.3); }
        .choice-risky:hover { background: rgba(220, 38, 38, 0.15); border-color: var(--hp-red); box-shadow: -4px 0 0 var(--hp-red); }
        .choice-risky::before { color: var(--hp-red); }
        .event-desc-box { background: rgba(0, 0, 0, 0.3); border: 1px dashed rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 6px; margin-bottom: 25px; text-align: left; font-style: italic; color: #94a3b8; line-height: 1.6; font-size: 14px; }

        .controls-row { display: flex; justify-content: space-between; margin-top: 10px; }
        .control-toggle { font-size: 11px; font-weight: 700; color: var(--text-main); background: none; border: 1px solid var(--border-color); padding: 4px 8px; border-radius: 4px; cursor: pointer; text-transform: uppercase; }
        .control-toggle.active { color: var(--highlight-blue); border-color: var(--highlight-blue); background: rgba(59, 130, 246, 0.1); }

        .log-container { flex-grow: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column-reverse; font-family: 'Courier New', monospace; font-size: 12px; color: #94a3b8; }
        .log-entry { margin-bottom: 6px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 4px; }
        .log-crit { color: var(--crit-color); font-weight: bold; border-left: 2px solid var(--crit-color); padding-left: 5px; }
        .log-story { color: var(--highlight-cyan); font-style: italic; border-left: 2px solid var(--highlight-cyan); padding-left: 5px; background: rgba(34, 211, 238, 0.05); padding: 4px; margin-bottom: 6px; }
        .log-event { color: var(--skill-green); font-weight: bold; border-left: 2px solid var(--skill-green); padding-left: 5px; background: rgba(16, 185, 129, 0.05); padding: 4px; }
        .log-ai { color: #a855f7; font-style: italic; border-left: 2px solid #a855f7; padding-left: 5px; background: rgba(168, 85, 247, 0.05); padding: 4px; }
        .log-fire { color: var(--el-fire); border-left: 2px solid var(--el-fire); padding-left: 5px; }
        .log-ice { color: var(--el-ice); border-left: 2px solid var(--el-ice); padding-left: 5px; }
        .log-poison { color: var(--el-poison); border-left: 2px solid var(--el-poison); padding-left: 5px; }
        .log-elec { color: var(--el-elec); border-left: 2px solid var(--el-elec); padding-left: 5px; }
        .log-shadow { color: var(--el-shadow); border-left: 2px solid var(--el-shadow); padding-left: 5px; }
        .log-blood { color: var(--el-blood); border-left: 2px solid var(--el-blood); padding-left: 5px; }

        .nav-tabs { display: flex; height: 50px; border-top: 1px solid var(--border-color); }
        .nav-tab { flex: 1; background: transparent; border: none; color: var(--text-main); font-weight: 700; font-size: 12px; text-transform: uppercase; cursor: pointer; transition: 0.3s; }
        .nav-tab:hover { color: white; }
        .nav-tab.active { color: white; border-bottom: 3px solid var(--highlight-blue); background: rgba(255,255,255,0.02); }

        .modal-fullscreen { position: fixed; inset: 0; background-color: var(--bg-dark); z-index: 5000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .avatar-selection-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 40px; }
        .avatar-option { width: 120px; height: 120px; padding: 15px; background: rgba(255,255,255,0.05); border: 2px solid var(--border-color); border-radius: 20px; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; }
        .avatar-option:hover { transform: scale(1.1) translateY(-5px); border-color: var(--highlight-cyan); background: rgba(34, 211, 238, 0.15); box-shadow: 0 0 25px rgba(34, 211, 238, 0.4); }
        .avatar-option svg { width: 100%; height: 100%; filter: drop-shadow(0 0 5px rgba(255,255,255,0.5)); }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 6000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-box { background: #0f172a; border: 1px solid var(--highlight-blue); padding: 40px; border-radius: 12px; text-align: center; width: 400px; max-width: 90%; animation: modal-pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .zone-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; max-height: 300px; overflow-y: auto; }
        .zone-card { background: rgba(255,255,255,0.05); border: 1px solid var(--border-color); padding: 15px; border-radius: 8px; cursor: pointer; transition: 0.2s; text-align: left; }
        .zone-card:hover { background: rgba(255,255,255,0.1); border-color: var(--highlight-cyan); }
        .zone-card.locked { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }

        .leaderboard-list { text-align: left; max-height: 300px; overflow-y: auto; margin-top: 20px; }
        .leaderboard-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .leaderboard-item:first-child { color: var(--gold); font-weight: bold; font-size: 1.1em; }
        
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: var(--highlight-blue); cursor: pointer; margin-top: -6px; box-shadow: 0 0 10px var(--highlight-blue); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #334155; border-radius: 2px; }

        .floating-text { position: absolute; font-weight: 900; font-size: 28px; text-shadow: 0 2px 0 #000, 0 0 10px currentColor; animation: float-up-fade 1s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; white-space: nowrap; }
        #fx-layer { position: fixed; inset: 0; pointer-events: none; z-index: 50; overflow: hidden; }
        @keyframes float-up-fade { 0% { transform: translateY(0) scale(0.5); opacity: 0; } 20% { transform: translateY(-10px) scale(1.2); opacity: 1; } 100% { transform: translateY(-80px) scale(1); opacity: 0; } }

    </style>
</head>
<body>

    <div id="laser-layer"><div id="fx-layer"></div></div>
    <div id="tooltip"></div>

    <div id="boot-screen" class="modal-fullscreen">
        <h1 class="text-4xl font-bold text-white mb-8 tracking-widest text-center">INITIALISATION DU PILOTE</h1>
        <input type="text" id="player-name-input" placeholder="VOTRE NOM" maxlength="12" class="mb-8 bg-transparent border-b-2 border-blue-500 text-white text-center text-2xl outline-none uppercase tracking-widest w-64 placeholder-gray-600 focus:border-cyan-400 transition" autocomplete="off">
        <div class="avatar-selection-grid" id="avatar-grid"></div>
        <button onclick="Game.hardReset()" class="text-xs text-gray-500 uppercase hover:text-red-500 transition border-b border-transparent hover:border-red-500">Effacer les donn√©es locales</button>
    </div>

    <div id="game-interface" class="main-layout blur">
        <div class="game-panel">
            <div class="panel-header"><span>PILOTE</span><span id="ui-pseudo" class="text-blue-400">COMMANDANT</span></div>
            <div class="bio-container">
                <div class="level-badge"><span class="text-[10px] text-gray-500 uppercase font-bold">Niveau</span><span id="ui-level" class="block text-3xl font-bold text-white">1</span></div>
                <div id="ui-avatar" class="hero-avatar anim-hero-float"></div>
                <div id="ui-pet-display" class="pet-avatar anim-pet-float"></div>
            </div>
            
            <div class="hp-bar-container" onmouseenter="UI.showStatsTooltip(event)" onmouseleave="UI.hideTooltip()">
                <div id="ui-shield-bar" class="hidden w-full h-1 bg-blue-900/30 mb-0.5 rounded-full overflow-hidden relative"><div id="ui-shield-fill" class="h-full bg-cyan-400 shadow-[0_0_10px_#22d3ee] transition-all duration-300" style="width: 0%"></div></div>
                <div class="flex justify-between text-[10px] font-bold text-gray-400 mb-1 uppercase"><span>Int√©grit√© Structurelle</span><span id="ui-hp-text">100/100</span></div>
                <div class="hp-track"><div id="ui-hp-fill" class="hp-fill"></div></div>
            </div>
            <div class="stat-grid">
                <div class="stat-card" onmouseenter="UI.showTooltip(event, 'PUISSANCE (ATK)', 'D√©g√¢ts inflig√©s par tour.\nAugmentez-la pour d√©truire les ennemis plus vite.')" onmouseleave="UI.hideTooltip()"><div class="stat-title">PUISSANCE</div><div id="ui-atk" class="stat-value text-blue-400">10</div></div>
                <div class="stat-card" onmouseenter="UI.showTooltip(event, 'BLINDAGE (DEF)', 'R√©duit les d√©g√¢ts subis lors des attaques ennemies.')" onmouseleave="UI.hideTooltip()"><div class="stat-title">BLINDAGE</div><div id="ui-def" class="stat-value text-blue-400">0</div></div>
            </div>
            <div id="ui-skills" class="skills-list"></div>
            <div class="equipment-slots">
                <div id="slot-weapon" class="item-slot" style="flex:1;">‚öîÔ∏è</div>
                <div id="slot-head" class="item-slot" style="flex:1;">üõ°Ô∏è</div>
                <div id="slot-pet" class="item-slot" style="flex:1;">üêæ</div>
            </div>
        </div>

        <div class="game-panel">
            <div class="panel-header">
                <div class="flex items-center">
                    <button onclick="UI.openMap()" class="map-btn" onmouseenter="UI.showTooltip(event, 'CARTE STELLAIRE', 'Changer de zone de d√©ploiement.\nAcc√®s PROTOCOLE OMEGA.')" onmouseleave="UI.hideTooltip()">üó∫Ô∏è</button>
                    <span id="ui-zone-display" onmouseenter="UI.showTooltip(event, 'PROGRESSION', 'Zone et Jour actuel.\nLe Boss appara√Æt au Jour 60.')" onmouseleave="UI.hideTooltip()">ZONE 1 | JOUR 1/60</span>
                </div>
                <div class="flex gap-4">
                    <span id="res-gold" class="text-gold font-bold cursor-help" onmouseenter="UI.showTooltip(event, 'OR', 'Monnaie standard.\nUtilis√©e pour les am√©liorations de base.')" onmouseleave="UI.hideTooltip()">ü™ô <span id="ui-gold">0</span></span>
                    <span id="res-gems" class="text-purple font-bold cursor-help" onmouseenter="UI.showTooltip(event, 'MATI√àRE NOIRE (GEMMES)', 'Ressource rare.\nN√©cessaire pour ouvrir les coffres de la soute.')" onmouseleave="UI.hideTooltip()">‚ú® <span id="ui-gems">0</span></span>
                </div>
            </div>
            <div class="mission-display" id="mission-viewport">
                <div id="view-mission" class="text-center w-full flex flex-col items-center relative">
                    <div class="mission-title">MISSION</div>
                    <div id="mission-story-text" class="mission-subtitle">Initialisation des syst√®mes de navigation...<br>En attente des ordres du commandant.</div>
                </div>
                
                <div id="view-combat" class="text-center hidden flex flex-col items-center w-full relative">
                    <div class="relative w-full flex flex-col items-center">
                        <div id="enemy-sprite" class="enemy-display anim-enemy-float mb-2"></div> <!-- V98: Empty for SVG injection -->
                        <div id="enemy-hp-container" class="w-full max-w-[200px] mt-4">
                            <div class="flex justify-between text-[10px] font-bold text-gray-400 mb-1 uppercase"><span>CIBLE</span><span id="ui-enemy-hp-text">100/100</span></div>
                            <div class="h-2 bg-black border border-red-900/50 rounded overflow-hidden"><div id="ui-enemy-hp-fill" class="h-full bg-red-600 transition-all duration-300" style="width: 100%;"></div></div>
                        </div>
                        <div id="combat-status-text" class="mt-4 inline-block bg-red-900/50 border border-red-500 px-4 py-1 rounded text-red-300 font-bold uppercase text-sm">Cible D√©tect√©e</div>
                    </div>
                </div>
            </div>
            <div class="bottom-action-area">
                <div class="flex flex-col h-full overflow-hidden">
                    <div class="flex justify-between items-center mb-2 shrink-0"><span class="text-[10px] font-bold text-gray-500 uppercase">SOUTE MAT√âRIEL</span><button onclick="Game.openChest()" class="bg-purple-600 hover:bg-purple-500 text-white text-[10px] font-bold px-2 py-1 rounded transition" onmouseenter="UI.showTooltip(event, 'COFFRE DIMENSIONNEL', 'Contient un √©quipement al√©atoire.\nCo√ªt : 5 ‚ú®')" onmouseleave="UI.hideTooltip()">COFFRE (5‚ú®)</button></div>
                    <div id="inventory-grid" class="inventory-grid flex-grow overflow-y-auto pr-1"></div>
                </div>
                <div class="flex flex-col justify-end">
                    <div class="flex gap-2">
                        <button onclick="UI.openBase()" class="base-btn flex-1">BASE OP√âRATIONS</button>
                        <button onclick="UI.showLeaderboard()" class="rank-btn flex-1">üèÜ CLASSEMENT</button>
                    </div>
                    <button id="btn-action" onclick="Game.triggerAction()" class="main-btn">LANCER</button>
                    <div class="controls-row">
                        <button id="btn-auto" onclick="Game.toggleAuto()" class="control-toggle">AUTO: OFF</button>
                        <button id="btn-speed" onclick="Game.toggleSpeed()" class="control-toggle">VIT: x1</button>
                        <button onclick="UI.openSettings()" class="control-toggle">‚öôÔ∏è</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="game-panel">
            <div class="panel-header"><span>TERMINAL DE BORD</span></div>
            <div id="log-container" class="log-container"><div class="log-entry">> Syst√®me initialis√©.</div></div>
        </div>
    </div>

    <!-- MODALS -->
    <div id="event-overlay" class="modal-overlay"><div class="modal-box w-[600px]"><h2 id="event-title" class="text-3xl font-bold text-white mb-2 uppercase tracking-widest text-cyan-400">ANOMALIE D√âTECT√âE</h2><div id="event-desc" class="event-desc-box"></div><div id="event-choices-container"></div></div></div>
    <div id="game-over-overlay" class="modal-overlay"><div class="modal-box w-[500px] border-red-600 shadow-[0_0_50px_rgba(220,38,38,0.5)]"><h2 class="text-5xl font-black text-red-600 mb-4 tracking-tighter animate-pulse">SIGNAL PERDU</h2><div class="text-4xl mb-4">üíÄ</div><p class="text-gray-300 mb-8 font-mono">L'unit√© a cess√© d'√©mettre.<br>R√©cup√©ration de la bo√Æte noire...</p><button onclick="UI.hideGameOver()" class="w-full py-4 bg-red-900/80 border border-red-500 text-white font-bold rounded hover:bg-red-800 transition tracking-widest text-xl">REINITIALISER LA SEQUENCE</button></div></div>
    <div id="settings-modal" class="modal-overlay"><div class="modal-box w-[400px]"><h2 class="text-2xl font-bold text-white mb-8">PARAM√àTRES</h2><div class="mb-8 w-full"><div class="flex justify-between mb-2"><label class="text-gray-400 text-sm font-bold uppercase">Volume Musique</label><span id="volume-val" class="text-highlight-blue font-bold text-sm">50%</span></div><input type="range" id="volume-slider" min="0" max="1" step="0.05" value="0.5" class="w-full" oninput="Game.setVolume(this.value)"></div><button onclick="Game.hardReset()" class="w-full py-3 bg-red-900/50 border border-red-500 text-red-200 rounded font-bold hover:bg-red-900 transition mb-4">R√âINITIALISATION D'USINE</button><button onclick="UI.closeSettings()" class="w-full py-3 bg-slate-800 rounded text-white font-bold hover:bg-slate-700 transition">RETOUR</button></div></div>
    <div id="leaderboard-modal" class="modal-overlay"><div class="modal-box w-[500px]"><h2 class="text-3xl font-bold text-gold mb-6 uppercase tracking-widest">CLASSEMENT INTERSTELLAIRE</h2><div id="leaderboard-content" class="leaderboard-list text-gray-300 mb-6"></div><button onclick="UI.closeLeaderboard()" class="w-full py-3 bg-slate-800 rounded text-white font-bold hover:bg-slate-700 transition">FERMER</button></div></div>
    
    <div id="map-modal" class="modal-overlay">
        <div class="modal-box w-[600px]">
            <h2 class="text-3xl font-bold text-cyan-400 mb-6 uppercase tracking-widest">CARTE STELLAIRE</h2>
            <div id="map-content" class="zone-grid mb-6"></div>
             <button onclick="Game.startAcidRun()" class="mt-4 w-full py-3 bg-purple-900/50 border border-purple-500 text-purple-100 font-bold uppercase rounded hover:bg-purple-900 transition relative overflow-hidden group">
                <span class="relative z-10">‚ò†Ô∏è ENTRER DANS LA ZONE OMEGA (IA)</span>
                <div class="absolute inset-0 bg-purple-600 opacity-0 group-hover:opacity-20 transition"></div>
            </button>
            <button onclick="UI.closeMap()" class="w-full mt-4 py-3 bg-slate-800 rounded text-white font-bold hover:bg-slate-700 transition">FERMER</button>
        </div>
    </div>

    <div id="hub-overlay" class="modal-fullscreen hidden">
        <h2 class="text-4xl font-bold text-white mb-6 italic">AM√âLIORATION DE LA BASE</h2>
        <div class="flex gap-8 mb-8 text-2xl bg-black/50 px-6 py-2 rounded-full border border-slate-700"><span class="text-gold font-bold">ü™ô <span id="hub-gold">0</span></span><span class="text-purple font-bold">‚ú® <span id="hub-gems">0</span></span></div>
        <div class="grid grid-cols-1 gap-6 w-80">
            <div onclick="Game.upgradeStat('hp')" class="stat-card cursor-pointer hover:border-blue-500 transition p-6 flex justify-between items-center"><div class="text-left"><div class="stat-title">INT√âGRIT√â</div><div class="text-xl font-bold text-white">+20 PV</div></div><div id="cost-hp" class="text-gold font-bold">100 ü™ô</div></div>
            <div onclick="Game.upgradeStat('atk')" class="stat-card cursor-pointer hover:border-blue-500 transition p-6 flex justify-between items-center"><div class="text-left"><div class="stat-title">PUISSANCE</div><div class="text-xl font-bold text-white">+5 ATK</div></div><div id="cost-atk" class="text-gold font-bold">100 ü™ô</div></div>
            <div onclick="Game.upgradeStat('def')" class="stat-card cursor-pointer hover:border-blue-500 transition p-6 flex justify-between items-center"><div class="text-left"><div class="stat-title">BLINDAGE</div><div class="text-xl font-bold text-white">+2 DEF</div></div><div id="cost-def" class="text-gold font-bold">100 ü™ô</div></div>
        </div>
        <button onclick="UI.closeHub()" class="mt-8 text-blue-400 font-bold uppercase hover:text-white transition tracking-widest border-b border-transparent hover:border-white">RETOUR AUX OP√âRATIONS</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'distory-go';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        let db = null, auth = null, user = null;

        const initFirebase = async () => {
            if (!firebaseConfig) return;
            try {
                const app = initializeApp(firebaseConfig); auth = getAuth(app); db = getFirestore(app);
                if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken); else await signInAnonymously(auth);
                user = auth.currentUser;
            } catch(e) { console.warn("Firebase init warning:", e); }
        };
        initFirebase();

        const bgMusic = new Audio('https://cdn.freesound.org/previews/842/842666_2694936-lq.mp3'); bgMusic.loop = true;
        const apiKey = "AIzaSyC5XOwFHDRuJuwBEsRl4OaK4vi2lUfxH9A"; 

        const AVATAR_DB = {
            'cyber-octo': `<svg viewBox="0 0 100 100" fill="none" stroke="#22d3ee" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="filter: drop-shadow(0 0 5px #22d3ee);"><defs><linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#0f172a;stop-opacity:1" /><stop offset="100%" style="stop-color:#1e293b;stop-opacity:1" /></linearGradient></defs><path d="M50 20 C70 20 80 35 75 55 C70 70 50 65 50 65 C50 65 30 70 25 55 C20 35 30 20 50 20 Z" fill="url(#grad1)"/><circle cx="40" cy="40" r="3" fill="#facc15" stroke="none"/><circle cx="60" cy="40" r="3" fill="#facc15" stroke="none"/><path d="M30 60 Q20 80 40 85" /><path d="M70 60 Q80 80 60 85" /><path d="M45 65 Q40 85 50 90" /><path d="M55 65 Q60 85 50 90" /><path d="M25 45 L15 40" opacity="0.6"/><path d="M75 45 L85 40" opacity="0.6"/><circle cx="50" cy="20" r="2" fill="#22d3ee" class="animate-ping" /></svg>`,
            'mecha-hamster': `<svg viewBox="0 0 100 100" fill="none" stroke="#f97316" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="filter: drop-shadow(0 0 5px #f97316);"><defs><radialGradient id="grad2" cx="50%" cy="50%" r="50%" fx="50%" fy="50%"><stop offset="0%" style="stop-color:#334155;stop-opacity:1" /><stop offset="100%" style="stop-color:#0f172a;stop-opacity:1" /></radialGradient></defs><circle cx="50" cy="50" r="35" fill="url(#grad2)" /><circle cx="35" cy="40" r="8" fill="#000" stroke="#f97316"/><circle cx="65" cy="40" r="8" fill="#000" stroke="#f97316"/><circle cx="37" cy="38" r="2" fill="#fff" stroke="none"/><circle cx="67" cy="38" r="2" fill="#fff" stroke="none"/><path d="M45 55 L55 55" stroke-width="3"/><rect x="25" y="65" width="15" height="10" fill="#1e293b"/><rect x="60" y="65" width="15" height="10" fill="#1e293b"/><path d="M50 15 L50 25" stroke="#facc15"/><circle cx="50" cy="15" r="3" fill="#facc15" class="animate-pulse" stroke="none"/></svg>`,
            'holo-fox': `<svg viewBox="0 0 100 100" fill="none" stroke="#a855f7" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="filter: drop-shadow(0 0 5px #a855f7);"><path d="M50 80 L30 40 L20 20 L40 30 L50 40 L60 30 L80 20 L70 40 Z" fill="rgba(168, 85, 247, 0.15)"/><path d="M40 50 L45 55" stroke="#facc15"/><path d="M60 50 L55 55" stroke="#facc15"/><circle cx="45" cy="45" r="2" fill="#facc15" stroke="none"/><circle cx="55" cy="45" r="2" fill="#facc15" stroke="none"/><path d="M50 80 L50 95" stroke-dasharray="2,2"/><path d="M10 50 L30 40" opacity="0.5"/><path d="M90 50 L70 40" opacity="0.5"/></svg>`,
            'neon-stag': `<svg viewBox="0 0 100 100" fill="none" stroke="#22c55e" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="filter: drop-shadow(0 0 5px #22c55e);"><path d="M50 45 L40 25 L30 35 L20 20 L35 40 L50 55 L65 40 L80 20 L70 35 L60 25 Z" fill="rgba(34, 197, 94, 0.15)"/><circle cx="40" cy="55" r="2" fill="#fff" stroke="none"/><circle cx="60" cy="55" r="2" fill="#fff" stroke="none"/><path d="M48 70 L52 70" /></svg>`,
            'robo-dog': `<svg viewBox="0 0 100 100" fill="none" stroke="#3b82f6" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="filter: drop-shadow(0 0 5px #3b82f6);"><rect x="30" y="35" width="40" height="30" rx="5" fill="rgba(59, 130, 246, 0.15)"/><path d="M35 35 L30 15" /><path d="M65 35 L70 15 L55 35" /><circle cx="40" cy="50" r="4" fill="#ef4444" stroke="none" class="animate-pulse"/><circle cx="60" cy="50" r="4" fill="#ef4444" stroke="none" class="animate-pulse"/><rect x="45" y="65" width="10" height="10" fill="#1e293b"/><path d="M30 55 L20 65" /><path d="M70 55 L80 65" /></svg>`,
            'neko-mancer': `<svg viewBox="0 0 100 100" fill="none" stroke="#ec4899" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="filter: drop-shadow(0 0 5px #ec4899);"><circle cx="50" cy="50" r="25" fill="rgba(236, 72, 153, 0.15)" /><path d="M35 35 L30 15 L45 30" /><path d="M65 35 L70 15 L55 30" /><path d="M40 50 L45 55 L55 55 L60 50" fill="none"/><circle cx="40" cy="45" r="3" fill="#facc15" stroke="none"/><circle cx="60" cy="45" r="3" fill="#facc15" stroke="none"/><path d="M25 50 L15 55" /><path d="M75 50 L85 55" /><circle cx="50" cy="25" r="2" fill="#ec4899" class="animate-ping" stroke="none"/></svg>`
        };
        
        // V98: ENEMY DATABASE (SVG)
        const ENEMY_DB = {
            'drone': `<svg viewBox="0 0 100 100" fill="none" stroke="#22d3ee" stroke-width="2"><circle cx="50" cy="50" r="20" fill="rgba(34, 211, 238, 0.1)"/><circle cx="50" cy="50" r="8" fill="#facc15" class="animate-pulse"/><path d="M30 50 L10 30" /><path d="M70 50 L90 30" /><path d="M30 50 L10 70" /><path d="M70 50 L90 70" /></svg>`,
            'xeno': `<svg viewBox="0 0 100 100" fill="none" stroke="#a855f7" stroke-width="2"><path d="M50 20 Q30 20 30 50 Q30 80 50 90 Q70 80 70 50 Q70 20 50 20 Z" fill="rgba(168, 85, 247, 0.1)"/><path d="M35 40 Q50 50 65 40" stroke="#facc15"/><circle cx="40" cy="35" r="2" fill="#fff"/><circle cx="60" cy="35" r="2" fill="#fff"/><path d="M30 50 L10 40" /><path d="M70 50 L90 40" /><path d="M40 80 L30 95" /><path d="M60 80 L70 95" /></svg>`,
            'probe': `<svg viewBox="0 0 100 100" fill="none" stroke="#f97316" stroke-width="2"><circle cx="50" cy="40" r="15" fill="rgba(249, 115, 22, 0.1)"/><rect x="45" y="55" width="10" height="20" fill="#334155"/><path d="M20 40 L35 40" /><path d="M65 40 L80 40" /><circle cx="50" cy="40" r="5" fill="#ef4444" class="animate-ping" stroke="none"/></svg>`,
            'sentinel': `<svg viewBox="0 0 100 100" fill="none" stroke="#ef4444" stroke-width="2"><path d="M50 20 L80 50 L50 80 L20 50 Z" fill="rgba(239, 68, 68, 0.1)"/><circle cx="50" cy="50" r="10" fill="#000"/><circle cx="50" cy="50" r="4" fill="#ef4444" class="animate-pulse"/></svg>`,
            'crab': `<svg viewBox="0 0 100 100" fill="none" stroke="#22c55e" stroke-width="2"><rect x="30" y="40" width="40" height="30" rx="5" fill="rgba(34, 197, 94, 0.1)"/><path d="M30 50 L10 40 L20 30" /><path d="M70 50 L90 40 L80 30" /><path d="M35 70 L25 85" /><path d="M65 70 L75 85" /><circle cx="40" cy="55" r="3" fill="#facc15"/><circle cx="60" cy="55" r="3" fill="#facc15"/></svg>`,
            
            // BOSSES
            'boss_alpha': `<svg viewBox="0 0 100 100" fill="none" stroke="#ef4444" stroke-width="3"><path d="M30 20 L70 20 L80 40 L80 80 L20 80 L20 40 Z" fill="rgba(239, 68, 68, 0.2)"/><path d="M40 40 L60 40" stroke="#000" stroke-width="5"/><circle cx="35" cy="35" r="3" fill="#fff" stroke="none"/><circle cx="65" cy="35" r="3" fill="#fff" stroke="none"/><path d="M50 20 L50 10" /><path d="M20 40 L10 50" /><path d="M80 40 L90 50" /></svg>`,
            'boss_queen': `<svg viewBox="0 0 100 100" fill="none" stroke="#a855f7" stroke-width="3"><path d="M50 10 Q80 10 90 40 Q80 90 50 90 Q20 90 10 40 Q20 10 50 10 Z" fill="rgba(168, 85, 247, 0.2)"/><circle cx="50" cy="40" r="10" fill="#facc15" stroke="none" class="animate-pulse"/><path d="M20 40 L5 30" /><path d="M80 40 L95 30" /><path d="M30 80 L20 95" /><path d="M70 80 L80 95" /></svg>`,
            'boss_omega': `<svg viewBox="0 0 100 100" fill="none" stroke="#fbbf24" stroke-width="3"><rect x="25" y="25" width="50" height="60" fill="rgba(251, 191, 36, 0.2)"/><rect x="35" y="35" width="30" height="10" fill="#000"/><circle cx="40" cy="40" r="2" fill="#ef4444"/><circle cx="60" cy="40" r="2" fill="#ef4444"/><path d="M25 40 L10 50" /><path d="M75 40 L90 50" /><rect x="40" y="60" width="20" height="20" fill="#334155"/></svg>`,
            'boss_void': `<svg viewBox="0 0 100 100" fill="none" stroke="#ffffff" stroke-width="2"><path d="M30 80 Q10 50 30 20 Q50 10 70 20 Q90 50 70 80 Q50 90 30 80 Z" fill="rgba(255, 255, 255, 0.1)" stroke-dasharray="4,4"/><circle cx="40" cy="45" r="4" fill="#000"/><circle cx="60" cy="45" r="4" fill="#000"/><path d="M40 65 Q50 75 60 65" /></svg>`
        };

        const Leaderboard = {
            submit: async (name, dayReached) => { if (!db || !auth || !auth.currentUser) return; try { await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard'), { name, score: dayReached, date: new Date().toISOString() }); } catch (e) { console.error(e); } },
            fetch: async () => { if (!db || !auth || !auth.currentUser) return []; try { const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard')); const s = await getDocs(q); let r = []; s.forEach(d => r.push(d.data())); r.sort((a, b) => b.score - a.score); return r.slice(0, 10); } catch (e) { return []; } }
        };

        const GameData = {
            config: { startGold: 0, startGems: 20, baseCritRate: 0.10, critMultiplier: 1.5, volume: 0.3 },
            zones: [{id:1,name:"Plaines Synth√©tiques",diff:"Facile",color:"text-green-400"},{id:2,name:"D√©sert de N√©on",diff:"Facile",color:"text-green-400"},{id:3,name:"Marais Toxique",diff:"Facile",color:"text-green-400"},{id:4,name:"Cit√© Oubli√©e",diff:"Facile",color:"text-green-400"},{id:5,name:"Ruches M√©caniques",diff:"Facile",color:"text-green-400"},{id:6,name:"Orbital Station Alpha",diff:"Moyen",color:"text-yellow-400"},{id:7,name:"Ceinture d'Ast√©ro√Ødes",diff:"Moyen",color:"text-yellow-400"},{id:8,name:"Lune Morte",diff:"Moyen",color:"text-yellow-400"},{id:9,name:"N√©buleuse Obscure",diff:"Moyen",color:"text-yellow-400"},{id:10,name:"Cimeti√®re de Vaisseaux",diff:"Moyen",color:"text-yellow-400"},{id:11,name:"Dimension X",diff:"Difficile",color:"text-red-500"},{id:12,name:"Noyau Galactique",diff:"Difficile",color:"text-red-500"},{id:13,name:"Singularit√©",diff:"Difficile",color:"text-red-500"},{id:14,name:"Horizon des √âv√©nements",diff:"Difficile",color:"text-red-500"},{id:15,name:"Source du Code",diff:"Cauchemar",color:"text-purple-500"}],
            skills: [{id:'poison',name:"Toxine",icon:"‚ò†Ô∏è",desc:"DOT",type:"dot",el:"poison"},{id:'lightning',name:"Foudre",icon:"‚ö°",desc:"D√©g√¢ts",type:"proc",el:"elec"},{id:'fire',name:"Br√ªlure",icon:"üî•",desc:"DOT",type:"dot",el:"fire"},{id:'ice',name:"Gel",icon:"‚ùÑÔ∏è",desc:"Stun",type:"proc",el:"ice"},{id:'wind',name:"Mistral",icon:"üå™Ô∏è",desc:"Esquive",type:"passive",el:"wind"},{id:'shadow',name:"Vampire",icon:"üåë",desc:"Vol PV",type:"proc",el:"shadow"},{id:'light',name:"Barri√®re",icon:"‚ú®",desc:"Shield",type:"start_battle",el:"light"},{id:'bleed',name:"Saignement",icon:"ü©∏",desc:"Critique",type:"on_crit",el:"blood"},{id:'chi',name:"Chi",icon:"üß†",desc:"+Stats",type:"stat_percent",el:"chi",val:0.15},{id:'explosion',name:"Boom",icon:"üí•",desc:"Explosion",type:"proc",el:"fire"},{id:'chain',name:"Rebond",icon:"üß≤",desc:"Double hit",type:"proc",el:"elec"},{id:'shield',name:"Mur",icon:"üõ°Ô∏è",desc:"R√©duc Dmg",type:"passive",el:"light"},{id:'weakness',name:"Corrosion",icon:"üß™",desc:"Debuff",type:"proc",el:"poison"},{id:'crit',name:"Pr√©cision",icon:"üéØ",desc:"+Crit",type:"stat",el:"blood"},{id:'regen',name:"Bio-R√©pa",icon:"üß¨",desc:"Soin",type:"turn_start",el:"poison"}],
            randomEvents: [{title:"Campement",desc:"Repos.",choices:[{text:"Dormir",effect:"heal_60"}]},{title:"Hutte",desc:"Abri.",choices:[{text:"Dormir",effect:"heal_60"},{text:"Fouiller",effect:"search_module"}]},{title:"Monolithe",desc:"Myst√®re.",choices:[{text:"Prier",effect:"heal_30"},{text:"Toucher",effect:"sacrifice_hp_stat"}]},{title:"Ennemi",desc:"Menace.",choices:[{text:"Fuir",effect:"ignore"},{text:"Combat",effect:"elite_combat"}]},{title:"D√©mon",desc:"Pacte.",choices:[{text:"Non",effect:"ignore"},{text:"Oui",effect:"demon_pact"}]},{title:"Camp",desc:"Loot.",choices:[{text:"Prendre",effect:"safe_loot"}]},{title:"Fourmis Feu",desc:"-HP",type:"instant",effect:"dmg_10"},{title:"Fourmis Lames",desc:"-ATK",type:"instant",effect:"debuff_atk_5"},{title:"Lumi√®re",desc:"+ATK",type:"instant",effect:"buff_atk_7_percent"},{title:"Drone",desc:"+ATK",type:"instant",effect:"buff_atk_7_percent"},{title:"Donn√©es",desc:"+ATK",type:"instant",effect:"buff_atk_7_percent"},{title:"Gel",desc:"+HP",type:"instant",effect:"buff_hp_7_percent"},{title:"Blindage",desc:"+HP",type:"instant",effect:"buff_hp_7_percent"},{title:"Energie",desc:"+Soin",type:"instant",effect:"heal_20_fortune"},{title:"Ast√©ro√Øde",desc:"+XP",type:"instant",effect:"xp_fortune"},{title:"Signal",desc:"Code.",choices:[{text:"D√©crypter",effect:"treasure_hunt"}]},{title:"Machine",desc:"Jeu.",choices:[{text:"Jouer",effect:"lucky_slot"}]},{title:"Base",desc:"+ATK Major",type:"instant",effect:"big_buff_atk"},{title:"Prototype",desc:"+ATK Major",type:"instant",effect:"big_buff_atk"},{title:"Nanites",desc:"+HP Major",type:"instant",effect:"big_buff_hp"},{title:"Couveuse",desc:"+HP Major",type:"instant",effect:"big_buff_hp"},{title:"R√©acteur",desc:"+HP Major",type:"instant",effect:"big_buff_hp"},{title:"M√©decin",desc:"+Soin Major",type:"instant",effect:"big_heal"},{title:"√âpave",desc:"+XP Major",type:"instant",effect:"big_xp"}],
            // V98: Updated Bosses with ID
            bosses: [
                { id: "boss_alpha", name: "GARDIEN ALPHA", icon: "boss_alpha", hp: 500, atk: 40 },
                { id: "boss_queen", name: "REINE ESSAIM", icon: "boss_queen", hp: 800, atk: 60 },
                { id: "boss_omega", name: "COLOSSE OMEGA", icon: "boss_omega", hp: 1200, atk: 90 },
                { id: "boss_void", name: "SPECTRE DU N√âANT", icon: "boss_void", hp: 1500, atk: 120 }
            ],
            // V98: Updated Enemies with ID
            enemies: [
                { id: "drone", name: "Drone Pirate", icon: "drone", hp: 50, atk: 5 },
                { id: "xeno", name: "X√©no-Morphe", icon: "xeno", hp: 80, atk: 8 },
                { id: "probe", name: "Sonde Corrompue", icon: "probe", hp: 40, atk: 12 },
                { id: "sentinel", name: "Sentinelle", icon: "sentinel", hp: 120, atk: 15 },
                { id: "crab", name: "M√©ca-Crabe", icon: "crab", hp: 200, atk: 20 }
            ],
            items: [{name:"Lame Laser",icon:"‚öîÔ∏è",type:"weapon",stat:10},{name:"Bouclier Plasma",icon:"üõ°Ô∏è",type:"head",stat:20},{name:"Drone Support",icon:"ü§ñ",type:"pet",stat:5},{name:"Puce Tactique",icon:"üíæ",type:"weapon",stat:15},{name:"Casque HUD",icon:"ü•Ω",type:"head",stat:25}]
        };

        let Player = { name: "COMMANDANT", avatar: "cyber-octo", gold: 0, gems: 20, level: 1, baseStats: { hp: 0, atk: 0, def: 0 }, inventory: [], equipment: { weapon: { name: "Couteau", icon: "üî™", type: "weapon", stat: 5, uid: "w1", rarity: 0 }, head: { name: "Visi√®re", icon: "üß¢", type: "head", stat: 10, uid: "h1", rarity: 0 }, pet: { name: "Drone", icon: "üöÅ", type: "pet", stat: 5, uid: "p1", rarity: 0, el: "elec" } }, volume: 0.3, maxZone: 1 };
        let Run = { isActive: false, isProcessing: false, day: 0, currentHp: 100, maxHp: 100, atk: 10, def: 0, critRate: 0.1, dodgeRate: 0, luck: 0, autoMode: false, speedMultiplier: 1, skills: [], isAcidMode: false, omegaNarrativeContext: "Le pilote vient d'entrer dans la simulation Omega. L'IA l'accueille avec m√©pris." };
        let Combat = { isActive: false, isBoss: false, enemyHp: 0, enemyMaxHp: 0, enemyAtk: 0, status: { enemyPoison: 0, enemyBurn: 0, enemyBleed: 0, enemyFrozen: false, enemyWeak: 0, playerShield: 0 } };

        const UI = {
            hideBootScreen: () => { document.getElementById('boot-screen').classList.add('hidden'); document.getElementById('game-interface').classList.remove('blur'); },
            renderAvatar: (id, targetId) => {
                const el = document.getElementById(targetId);
                if (el && AVATAR_DB[id]) el.innerHTML = AVATAR_DB[id];
                else if (el) el.innerText = "?";
            },
            showTooltip: (e, title, desc = "") => { const tt = document.getElementById('tooltip'); tt.innerHTML = `<strong>${title}</strong>${desc}`; tt.style.display = 'block'; tt.style.left = (e.clientX + 15) + 'px'; tt.style.top = (e.clientY + 15) + 'px'; if (e.clientX + 250 > window.innerWidth) tt.style.left = (e.clientX - 260) + 'px'; if (e.clientY + 100 > window.innerHeight) tt.style.top = (e.clientY - 100) + 'px'; },
            showStatsTooltip: (e) => { const content = `<div class="stat-row"><span>Niveau :</span><span>${Math.floor(Run.day / 10) + 1}</span></div><div class="stat-row"><span>PV Max :</span><span>${Run.maxHp}</span></div><div class="stat-row"><span>Attaque :</span><span>${Run.atk}</span></div><div class="stat-row"><span>D√©fense :</span><span>${Run.def}</span></div><div class="stat-row"><span>Critique :</span><span>${(Run.critRate * 100).toFixed(0)}%</span></div><div class="stat-row"><span>Esquive :</span><span>${(Run.dodgeRate * 100).toFixed(0)}%</span></div><div class="stat-row"><span>Fortune :</span><span style="color:var(--skill-green)">${Run.luck}</span></div>`; UI.showTooltip(e, "STATS PILOTE", content); },
            hideTooltip: () => { document.getElementById('tooltip').style.display = 'none'; },
            updateAll: () => {
                const prevGold = parseInt(document.getElementById('ui-gold').innerText);
                const prevGems = parseInt(document.getElementById('ui-gems').innerText);
                document.getElementById('ui-gold').innerText = Player.gold; document.getElementById('ui-gems').innerText = Player.gems;
                document.getElementById('hub-gold').innerText = Player.gold; document.getElementById('hub-gems').innerText = Player.gems;
                if (Player.gold !== prevGold) { const el = document.getElementById('res-gold'); el.classList.remove('resource-pop'); void el.offsetWidth; el.classList.add('resource-pop'); }
                if (Player.gems !== prevGems) { const el = document.getElementById('res-gems'); el.classList.remove('resource-pop'); void el.offsetWidth; el.classList.add('resource-pop'); }
                const currentZone = Math.ceil(Run.day / 60) || 1; const currentDayInZone = (Run.day - 1) % 60 + 1; 
                if (Run.isAcidMode) document.getElementById('ui-zone-display').innerText = `ZONE OMEGA | JOUR ${Run.day}`;
                else document.getElementById('ui-zone-display').innerText = `ZONE ${currentZone} | JOUR ${currentDayInZone}/60`;
                UI.renderAvatar(Player.avatar, 'ui-avatar'); document.getElementById('ui-pseudo').innerText = Player.name || "COMMANDANT";
                UI.updateHpBar(); document.getElementById('ui-atk').innerText = Run.atk; document.getElementById('ui-def').innerText = Run.def;
                const petEl = document.getElementById('ui-pet-display');
                if (Player.equipment.pet) { petEl.innerText = Player.equipment.pet.icon; petEl.classList.remove('hidden'); } else { petEl.innerText = ""; petEl.classList.add('hidden'); }
                const sDiv = document.getElementById('ui-skills'); sDiv.innerHTML = ''; Run.skills.forEach(s => { const t = document.createElement('span'); t.className = 'skill-tag'; t.innerText = s.icon; t.onmouseenter = (e) => UI.showTooltip(e, s.name, s.desc || "Effet passif"); t.onmouseleave = UI.hideTooltip; sDiv.appendChild(t); });
                const grid = document.getElementById('inventory-grid'); grid.innerHTML = ''; Player.inventory.forEach(i => { const d = document.createElement('div'); d.className = `item-slot rarity-${i.rarity || 0}`; d.innerText = i.icon; d.onclick = () => Game.equipItem(i.uid); d.onmouseenter = (e) => UI.showTooltip(e, i.name, `${i.type.toUpperCase()}\n<span class='stat-bonus'>+${i.stat} ${i.type==='weapon'?'ATK':i.type==='head'?'HP':'ATK'}</span>`); d.onmouseleave = UI.hideTooltip; grid.appendChild(d); });
                ['weapon','head','pet'].forEach(s => { const el = document.getElementById(`slot-${s}`); const it = Player.equipment[s]; if(it) { el.innerText = it.icon; el.className = `item-slot equipped rarity-${it.rarity || 0}`; el.onmouseenter = (e) => UI.showTooltip(e, it.name, `${it.type.toUpperCase()}\n<span class='stat-bonus'>+${it.stat} ${it.type==='weapon'?'ATK':it.type==='head'?'HP':'ATK'}</span>`); el.onmouseleave = UI.hideTooltip; } else { el.innerText = s==='weapon'?'‚öîÔ∏è':s==='head'?'üõ°Ô∏è':'üêæ'; el.className = 'item-slot'; el.classList.remove('equipped'); el.onmouseenter = (e) => UI.showTooltip(e, 'VIDE', 'Emplacement libre'); el.onmouseleave = UI.hideTooltip; } });
                document.getElementById('cost-hp').innerText = `${100 + Player.baseStats.hp*50} ü™ô`; document.getElementById('cost-atk').innerText = `${100 + Player.baseStats.atk*50} ü™ô`; document.getElementById('cost-def').innerText = `${100 + Player.baseStats.def*50} ü™ô`;
                UI.updateControls();
            },
            updateHpBar: () => { const pct = (Run.currentHp / Run.maxHp) * 100; const fill = document.getElementById('ui-hp-fill'); fill.style.width = `${Math.max(0, pct)}%`; document.getElementById('ui-hp-text').innerText = `${Math.floor(Run.currentHp)}/${Run.maxHp}`; fill.classList.remove('hp-high', 'hp-mid', 'hp-low'); if (pct > 50) { fill.classList.add('hp-high'); } else if (pct > 25) { fill.classList.add('hp-mid'); } else { fill.classList.add('hp-low'); } const shield = Combat.isActive ? Combat.status.playerShield : 0; const shieldBar = document.getElementById('ui-shield-bar'); if (shield > 0) { shieldBar.classList.remove('hidden'); const sPct = Math.min(100, (shield / Run.maxHp) * 100); document.getElementById('ui-shield-fill').style.width = `${sPct}%`; } else { shieldBar.classList.add('hidden'); } },
            updateEnemyHpBar: (cur, max) => { const hpPercent = Math.max(0, (cur / max) * 100); document.getElementById('ui-enemy-hp-fill').style.width = `${hpPercent}%`; document.getElementById('ui-enemy-hp-text').innerText = `${Math.max(0, cur)}/${max}`; },
            triggerFX: (type) => { const el = document.getElementById('enemy-sprite'); el.classList.remove(`fx-${type}`); void el.offsetWidth; el.classList.add(`fx-${type}`); setTimeout(() => el.classList.remove(`fx-${type}`), 500); },
            animPetAttack: () => { const petEl = document.getElementById('ui-pet-display'); petEl.classList.remove('anim-pet-float'); petEl.classList.add('anim-pet-attacking'); setTimeout(() => { petEl.classList.remove('anim-pet-attacking'); petEl.classList.add('anim-pet-float'); }, 300); },
            updateStatusVisuals: () => { const el = document.getElementById('enemy-sprite'); el.classList.remove('status-poison', 'status-burn', 'status-frozen', 'status-weak'); if (Combat.status.enemyPoison > 0) el.classList.add('status-poison'); if (Combat.status.enemyBurn > 0) el.classList.add('status-burn'); if (Combat.status.enemyFrozen) el.classList.add('status-frozen'); if (Combat.status.enemyWeak > 0) el.classList.add('status-weak'); },
            updateControls: () => { const b = document.getElementById('btn-action'); if(Run.isProcessing || Combat.isActive) { b.innerText = Combat.isActive ? "COMBAT..." : "EN COURS..."; b.disabled = true; b.classList.add('opacity-50'); } else { b.innerText = Run.isAcidMode ? "CONTINUER (IA)" : (Run.isActive ? "EXPLORER" : "LANCER"); b.disabled = false; b.classList.remove('opacity-50'); } document.getElementById('btn-speed').innerText = `VIT: x${Run.speedMultiplier}`; const auto = document.getElementById('btn-auto'); if(Run.isAcidMode) { auto.disabled=true; auto.innerText="AUTO: OFF"; auto.classList.add('opacity-50'); } else { auto.disabled=false; auto.innerText = Run.autoMode ? "AUTO: ON" : "AUTO: OFF"; auto.classList.toggle('active', Run.autoMode); } },
            showSkillChoice: () => { const el = document.getElementById('event-choices-container'); el.innerHTML = '<div class="event-grid"></div>'; const g = el.querySelector('.event-grid'); document.getElementById('event-title').innerText = "T√âL√âCHARGEMENT"; document.getElementById('event-desc').innerText = "Choisissez un module."; for(let i=0; i<3; i++) { const idx = Math.floor(Math.random() * GameData.skills.length); const s = GameData.skills[idx]; const c = document.createElement('div'); c.className = 'event-card'; c.innerHTML = `<div class="event-icon">${s.icon}</div><div class="event-title">${s.name}</div><div class="event-desc">${s.desc}</div>`; c.onclick = () => Game.selectSkill(idx); c.onmouseenter = (e) => UI.showTooltip(e, s.name, s.desc); c.onmouseleave = UI.hideTooltip; g.appendChild(c); } document.getElementById('event-overlay').style.display = 'flex'; },
            showScenario: (ev) => { const el = document.getElementById('event-choices-container'); el.innerHTML = ''; document.getElementById('event-title').innerText = ev.title; const descEl = document.getElementById('event-desc'); descEl.innerText = ev.desc; ev.choices.forEach(ch => { const b = document.createElement('button'); b.className = 'choice-btn'; if(ch.risk) b.classList.add('choice-risky'); b.innerText = ch.text; b.onclick = () => Game.resolveScenario(ch); el.appendChild(b); }); document.getElementById('event-overlay').style.display = 'flex'; },
            showInstantEvent: (ev) => { const el = document.getElementById('event-choices-container'); el.innerHTML = `<div class='text-center text-4xl mb-4'>${ev.effect.includes('fortune') ? 'üçÄ' : '‚ö†Ô∏è'}</div><button class='choice-btn' onclick='UI.closeEventModal(); Game.endAction();'>CONTINUER</button>`; document.getElementById('event-title').innerText = ev.title; document.getElementById('event-desc').innerText = ev.desc; document.getElementById('event-overlay').style.display = 'flex'; },
            closeEventModal: () => { document.getElementById('event-overlay').style.display = 'none'; UI.hideTooltip(); },
            showGameOver: () => { document.getElementById('game-over-overlay').style.display = 'flex'; },
            hideGameOver: () => { document.getElementById('game-over-overlay').style.display = 'none'; },
            
            // V98: RENDER ENEMY SVG
            showCombatView: (icon) => { 
                document.getElementById('view-mission').classList.add('hidden'); 
                document.getElementById('view-combat').classList.remove('hidden'); 
                const enemyEl = document.getElementById('enemy-sprite');
                // Check if SVG exists in DB, else use default text
                if (ENEMY_DB[icon]) {
                    enemyEl.innerHTML = ENEMY_DB[icon];
                } else {
                    enemyEl.innerHTML = `<span>${icon}</span>`; // Fallback to emoji text if not found
                }
                
                document.getElementById('ui-enemy-hp-fill').style.width = '100%'; document.getElementById('ui-enemy-hp-text').innerText = '100%'; UI.updateStatusVisuals(); 
            },
            
            showMissionView: () => { document.getElementById('view-combat').classList.add('hidden'); document.getElementById('view-mission').classList.remove('hidden'); },
            log: (msg, type='normal') => { const c = document.getElementById('log-container'); const e = document.createElement('div'); e.className = `log-entry log-${type}`; e.innerText = `> ${msg}`; c.insertBefore(e, c.firstChild); if(c.children.length>50) c.lastChild.remove(); },
            showFloatingText: (targetId, text, colorClass) => { const layer = document.getElementById('fx-layer'); const target = document.getElementById(targetId); if (!target) return; const rect = target.getBoundingClientRect(); const el = document.createElement('div'); el.className = 'floating-text'; el.style.left = (rect.left + rect.width / 2) + 'px'; el.style.top = (rect.top) + 'px'; el.innerText = text; if (colorClass === 'damage') el.style.color = '#ef4444'; else if (colorClass === 'heal') el.style.color = '#22c55e'; else if (colorClass === 'crit') el.style.color = '#fbbf24'; else if (colorClass === 'shield') el.style.color = '#22d3ee'; else if (colorClass === 'status') el.style.color = '#a855f7'; else el.style.color = '#fff'; layer.appendChild(el); setTimeout(() => el.remove(), 1000); },
            animPlayerAttack: () => { const a = document.getElementById('ui-avatar'); a.classList.remove('anim-hero-float'); a.classList.add('anim-attacking'); setTimeout(()=> { a.classList.remove('anim-attacking'); a.classList.add('anim-hero-float'); },300); },
            animCritEffect: () => { const a = document.getElementById('ui-avatar'); a.classList.remove('anim-hero-float'); a.classList.add('anim-crit'); setTimeout(()=> { a.classList.remove('anim-crit'); a.classList.add('anim-hero-float'); },400); },
            animPlayerHit: () => { const p = document.querySelector('.game-panel'); p.classList.add('anim-hit'); setTimeout(()=> p.classList.remove('anim-hit'),400); },
            animEnemyAttack: () => { const e = document.getElementById('enemy-sprite'); e.classList.remove('anim-enemy-float'); e.classList.add('anim-enemy-attacking'); setTimeout(()=> { e.classList.remove('anim-enemy-attacking'); e.classList.add('anim-enemy-float'); },400); },
            animEnemyHit: () => { const e = document.getElementById('enemy-sprite'); e.classList.remove('anim-enemy-float'); e.classList.add('anim-enemy-hit'); setTimeout(()=> { e.classList.remove('anim-enemy-hit'); e.classList.add('anim-enemy-float'); },400); },
            openBase: () => { document.getElementById('hub-overlay').classList.remove('hidden'); },
            closeHub: () => { document.getElementById('hub-overlay').classList.add('hidden'); },
            switchTab: (t) => { if(t==='hub') UI.openBase(); },
            openSettings: () => document.getElementById('settings-modal').style.display = 'flex',
            closeSettings: () => document.getElementById('settings-modal').style.display = 'none',
            showLeaderboard: async () => { /* ... */ },
            closeLeaderboard: () => { document.getElementById('leaderboard-modal').style.display = 'none'; },
            openMap: () => {
                document.getElementById('map-modal').style.display = 'flex';
                const container = document.getElementById('map-content'); container.innerHTML = '';
                const maxZ = Player.maxZone || 1;
                GameData.zones.forEach(z => {
                    const card = document.createElement('div'); const locked = z.id > maxZ; card.className = `zone-card ${locked ? 'locked' : ''}`;
                    card.innerHTML = `<div class="font-bold ${z.color} text-lg">${locked ? 'VERROUILL√â' : z.name}</div><div class="text-xs text-gray-400">ZONE ${z.id} - ${z.diff}</div>`;
                    if (!locked) { card.onclick = () => { Game.startRun(z.id); UI.closeMap(); UI.closeHub(); }; }
                    container.appendChild(card);
                });
            },
            closeMap: () => { document.getElementById('map-modal').style.display = 'none'; },
            initAvatarGrid: () => {
                const grid = document.getElementById('avatar-grid');
                grid.innerHTML = '';
                Object.keys(AVATAR_DB).forEach(key => {
                    const btn = document.createElement('button');
                    btn.className = 'avatar-option';
                    btn.innerHTML = AVATAR_DB[key];
                    btn.onclick = () => Game.selectAvatar(key);
                    grid.appendChild(btn);
                });
            }
        };

        const Game = {
            init: () => {
                const save = localStorage.getItem('distory_save_v98'); // NEW SAVE KEY V98
                if (save) { 
                    Player = JSON.parse(save); 
                    if (!Player.maxZone) Player.maxZone = 1;
                    if (Player.equipment.pet && !Player.equipment.pet.el) Player.equipment.pet.el = "elec";
                    if (Player.volume !== undefined) { GameData.config.volume = Player.volume; bgMusic.volume = Player.volume; document.getElementById('volume-slider').value = Player.volume; document.getElementById('volume-val').innerText = Math.round(Player.volume*100) + "%"; }
                    if (Player.avatar && !AVATAR_DB[Player.avatar]) Player.avatar = 'cyber-octo';
                    if (Player.avatar) { Game.calculateStats(); Run.currentHp = Run.maxHp; UI.hideBootScreen(); UI.updateAll(); } 
                }
                UI.initAvatarGrid();
                bgMusic.volume = GameData.config.volume;
            },
            // ... (Game methods follow same pattern as V94.1, updated for V98 context) ...
            getDifficultyScale: () => {
                const zone = Math.ceil(Run.day / 60) || 1; const dayInZone = (Run.day - 1) % 60 + 1;
                let zoneBaseMult = 1; let dailyGrowth = 0.02;
                if (zone <= 5) { zoneBaseMult = 1 + ((zone - 1) * 0.2); dailyGrowth = 0.02; } 
                else if (zone <= 10) { zoneBaseMult = 2.0 + ((zone - 6) * 0.4); dailyGrowth = 0.05; } 
                else { zoneBaseMult = 4.0 + ((zone - 11) * 0.8); dailyGrowth = 0.10; }
                return zoneBaseMult + (dayInZone * dailyGrowth);
            },
            setVolume: (val) => { const v = parseFloat(val); bgMusic.volume = v; Player.volume = v; document.getElementById('volume-val').innerText = Math.round(v*100) + "%"; Game.save(); },
            selectAvatar: (key) => { const nameInput = document.getElementById('player-name-input').value.trim(); Player.name = nameInput || "COMMANDANT"; Player.avatar = key; Game.calculateStats(); Game.save(); bgMusic.play().catch(e => console.log("Audio autoplay bloqu√©, attente interaction")); UI.hideBootScreen(); UI.updateAll(); },
            startRun: (zoneId) => { Run.isActive = true; Run.isAcidMode = false; Run.day = (zoneId - 1) * 60; Run.skills = []; Run.luck = 0; Game.calculateStats(); Run.currentHp = Run.maxHp; UI.log(`D√©ploiement en Zone ${zoneId}...`); UI.updateAll(); Game.triggerAction(); },
            startAcidRun: () => { if (!apiKey) { UI.log("ERREUR: Cl√© API manquante dans le code (Variable apiKey).", 'crit'); return; } UI.closeMap(); Run.isActive = true; Run.isAcidMode = true; Run.day = 0; Run.skills = []; Run.luck = 0; Run.omegaNarrativeContext = "Le pilote vient d'entrer dans la simulation Omega. L'IA l'accueille avec m√©pris."; Game.calculateStats(); Run.currentHp = Run.maxHp; UI.log("INITIATION PROTOCOLE OMEGA. IA ACTIV√âE.", 'ai'); UI.updateAll(); Game.triggerAction(); },
            triggerAction: () => {
                if (Run.isProcessing || Combat.isActive) return;
                if (!Run.isActive) { Game.startRun(1); return; }
                Run.isProcessing = true; UI.updateControls();
                if (Run.isAcidMode) { Game.triggerAcidEvent(); return; }
                setTimeout(() => {
                    Run.day++; Game.calculateStats();
                    const zoneDay = (Run.day - 1) % 60 + 1;
                    if (zoneDay === 60) { Game.startBossCombat(); return; }
                    if (Math.random() < 0.3) { Game.triggerEvent(); return; }
                    const isCombat = (Run.day % 4 === 0 || Math.random() < 0.25);
                    const story = "Exploration du secteur...";
                    let rewardHtml = isCombat ? "<div class='mt-3 text-red-400 font-bold text-sm tracking-widest uppercase animate-pulse'>‚ö†Ô∏è MENACE D√âTECT√âE</div>" : `<div class='mt-3 text-gold font-bold text-xl'>+25 ü™ô</div>`;
                    document.getElementById('mission-story-text').innerHTML = `<span>${story}</span>${rewardHtml}`;
                    if (!isCombat) { Player.gold += 25; UI.log("> Exploration : +25 Or"); UI.showFloatingText('ui-gold', '+25', 'crit'); UI.updateAll(); Game.endAction(); } else { Game.startCombat(); }
                }, 400 / Run.speedMultiplier);
            },
            triggerAcidEvent: async () => {
                Run.day++;
                document.getElementById('mission-story-text').innerHTML = `<div class="anim-ai-loading text-purple-400 font-bold text-xl">IA G√âN√àRE LA R√âALIT√â...</div>`;
                const stats = `PV:${Math.floor(Run.currentHp)}/${Run.maxHp}, OR:${Player.gold}`;
                const prompt = `Tu es le Ma√Ætre du Jeu sadique du Protocole Omega. Tu racontes une histoire suivie, coh√©rente, o√π le joueur souffre de mani√®re hilarante.
Contexte narratif actuel : ${Run.omegaNarrativeContext}
Jour : ${Run.day}. Stats Joueur : ${stats}.
G√©n√®re un √©v√©nement court (max 30 mots) dr√¥le et m√©chant.
Format JSON STRICT:
{
  "title": "Titre Court",
  "desc": "Description de la situation",
  "choices": [
    { "text": "Action A (Risque)", "effect": "ai_bonus", "val": 50, "narrative": "Cons√©quence dr√¥le si succ√®s." },
    { "text": "Action B (S√©curit√© relative)", "effect": "ai_malus", "val": 20, "narrative": "Cons√©quence humiliante." }
  ],
  "nextContext": "R√©sum√© court (1 phrase) de la situation apr√®s cet √©v√©nement pour la m√©moire de la prochaine fois."
}`;
                try {
                    const response = await callGemini(prompt);
                    const eventData = JSON.parse(response);
                    const aiEvent = { title: eventData.title, desc: eventData.desc, nextContext: eventData.nextContext, choices: eventData.choices.map(c => ({ text: c.text, effect: c.effect, val: c.val, narrative: c.narrative, nextContext: eventData.nextContext })) };
                    UI.showScenario(aiEvent);
                } catch (e) { console.error("AI Error", e); UI.log("Erreur IA. Passage au mode manuel.", 'crit'); Game.endAction(); }
            },
            endAction: () => { Run.isProcessing = false; UI.updateControls(); if (Run.autoMode && Run.isActive && !Combat.isActive && !Run.isAcidMode) setTimeout(Game.triggerAction, 1200 / Run.speedMultiplier); },
            triggerEvent: () => { if (Math.random() < 0.4) { UI.showSkillChoice(); return; } const eventTemplate = GameData.randomEvents[Math.floor(Math.random() * GameData.randomEvents.length)]; if (eventTemplate.type === "instant") { UI.showInstantEvent(eventTemplate); Game.resolveEffect(eventTemplate.effect, eventTemplate.title); } else { UI.showScenario(eventTemplate); } },
            selectSkill: (idx) => { const skill = { ...GameData.skills[idx] }; Run.skills.push(skill); UI.log(`Comp√©tence : ${skill.name}`, 'event'); Game.calculateStats(); UI.closeEventModal(); Game.endAction(); },
            resolveScenario: (choice) => { 
                if (choice.nextContext) Run.omegaNarrativeContext = choice.nextContext;
                if (choice.effect === 'ai_bonus') { Player.gold += choice.val || 10; UI.log(`IA: ${choice.narrative} (+${choice.val} Or)`, 'ai'); UI.showFloatingText('ui-gold', `+${choice.val || 10}`, 'crit'); } 
                else if (choice.effect === 'ai_malus') { Run.currentHp -= choice.val || 10; UI.log(`IA: ${choice.narrative} (-${choice.val} PV)`, 'ai'); UI.showFloatingText('ui-avatar', `-${choice.val || 10}`, 'damage'); if (Run.currentHp <= 0) { Game.loseCombat(); return; } } 
                else { Game.resolveEffect(choice.effect, "Choix"); }
                UI.updateAll(); UI.closeEventModal(); Game.endAction();
            },
            resolveEffect: (effectCode, sourceName) => {
                let msg = ""; let endTurn = true;
                if (effectCode === "heal_60") { const h = Math.floor(Run.maxHp * 0.6); Run.currentHp = Math.min(Run.maxHp, Run.currentHp + h); UI.updateHpBar(); msg = `Repos : +${h} PV`; UI.showFloatingText('ui-avatar', `+${h}`, 'heal'); }
                else if (effectCode === "elite_combat") { UI.closeEventModal(); Game.startCombat(true); return; }
                else if (effectCode === "safe_loot") { Player.gold += 50; msg = "Cargaison : +50 Or"; UI.showFloatingText('ui-gold', '+50', 'crit'); }
                else if (effectCode === "dmg_10") { const d = Math.floor(Run.maxHp * 0.1); Run.currentHp -= d; UI.updateHpBar(); msg = `D√©g√¢ts subis : -${d} PV`; UI.showFloatingText('ui-avatar', `-${d}`, 'damage'); }
                else if (effectCode === "ignore") { msg = "Vous passez votre chemin."; }
                else { msg = "Effet appliqu√©."; }
                UI.log(msg, 'event');
                if (Run.currentHp <= 0) { Game.loseCombat(); return; }
                Game.calculateStats(); UI.updateAll(); if (endTurn) Game.endAction();
            },
            startBossCombat: () => { Combat.isActive = true; Combat.isBoss = true; UI.updateControls(); const zone = Math.ceil(Run.day / 60); const bossIdx = Math.min(zone - 1, GameData.bosses.length - 1); const bossTemplate = GameData.bosses[bossIdx]; const scale = Game.getDifficultyScale(); Combat.enemyMaxHp = Math.floor(bossTemplate.hp * scale * 1.5); Combat.enemyHp = Combat.enemyMaxHp; Combat.enemyAtk = Math.floor(bossTemplate.atk * scale * 1.2); Combat.status = { enemyPoison: 0, enemyBurn: 0, enemyBleed: 0, enemyFrozen: false, enemyWeak: 0, playerShield: 0 }; document.getElementById('mission-story-text').innerHTML = `<span class="text-red-500 font-bold text-2xl animate-pulse">‚ö†Ô∏è ALERTE MAJEURE ‚ö†Ô∏è</span><br>LE GARDIEN DE LA ZONE EST L√Ä !`; UI.updateAll(); setTimeout(() => { UI.showCombatView(bossTemplate.id); document.getElementById('enemy-sprite').classList.add('anim-boss-spawn'); UI.log(`!!! BOSS : ${bossTemplate.name} !!!`, 'crit'); setTimeout(Game.combatRound, 1200 / Run.speedMultiplier); }, 1500 / Run.speedMultiplier); },
            startCombat: (isElite = false) => { Combat.isActive = true; Combat.isBoss = false; UI.updateControls(); let template = GameData.enemies[Math.floor(Math.random() * GameData.enemies.length)]; let scale = Game.getDifficultyScale(); if (isElite) { template = { name: "COMMANDANT √âLITE", icon: "üíÄ", hp: 300, atk: 25 }; scale *= 1.5; UI.log("‚ö†Ô∏è SIGNAL √âLITE D√âTECT√â ‚ö†Ô∏è", 'crit'); } Combat.enemyMaxHp = Math.floor(template.hp * scale); Combat.enemyHp = Combat.enemyMaxHp; Combat.enemyAtk = Math.floor(template.atk * scale); Combat.status = { enemyPoison: 0, enemyBurn: 0, enemyBleed: 0, enemyFrozen: false, enemyWeak: 0, playerShield: 0 }; if (Game.hasSkill('light')) { Combat.status.playerShield = Math.floor(Run.maxHp * 0.2); UI.log("Barri√®re Sacr√©e activ√©e !", 'light'); } UI.updateAll(); setTimeout(() => { UI.showCombatView(template.id); document.getElementById('enemy-sprite').classList.remove('anim-boss-spawn'); UI.log(`! ALERTE : ${template.name} !`); setTimeout(Game.combatRound, 800 / Run.speedMultiplier); }, 1000 / Run.speedMultiplier); },
            winCombat: () => { Combat.isActive = false; let gold = 50 + (Run.day * 5); if (Combat.isBoss) { gold *= 5; Player.gems += 5; UI.log(`BOSS VAINCU ! +${gold} Or`, 'crit'); const currentZone = Math.ceil(Run.day / 60); if (Player.maxZone < currentZone + 1) { Player.maxZone = currentZone + 1; UI.log(`ACC√àS AUTORIS√â : ZONE ${Player.maxZone}`, 'event'); } } else { Player.gems += 1; UI.log(`Victoire ! +${gold} Or`, 'event'); } Player.gold += gold; UI.showMissionView(); UI.updateAll(); Game.save(); Game.endAction(); },
            loseCombat: () => { Combat.isActive = false; Run.isActive = false; Run.autoMode = false; Run.isProcessing = false; Run.currentHp = 0; UI.log("!!! MISSION FAILED !!!"); UI.showMissionView(); UI.updateAll(); UI.showGameOver(); Leaderboard.submit(Player.name, Run.day); Game.save(); },
            calculateStats: () => {
                let mh = 100 + (Player.baseStats.hp * 20); let at = 10 + (Player.baseStats.atk * 5); let df = 0 + (Player.baseStats.def * 2); let cr = GameData.config.baseCritRate; let dg = 0;
                if (Player.equipment.weapon) at += Player.equipment.weapon.stat; if (Player.equipment.head) mh += Player.equipment.head.stat; if (Player.equipment.pet) at += Player.equipment.pet.stat;
                let globalMult = 1;
                Run.skills.forEach(s => {
                    if (s.type === 'stat') { if (s.stat === 'atk') at = Math.floor(at * (1 + s.val)); if (s.stat === 'def') df = Math.floor(df * (1 + s.val)); if (s.stat === 'hp') mh = Math.floor(mh * (1 + s.val)); if (s.stat === 'crit') cr += s.val; }
                    if (s.id === 'wind') dg += 0.15; if (s.id === 'crit') cr += 0.10; if (s.id === 'chi') globalMult += 0.15;
                });
                if (globalMult > 1) { mh = Math.floor(mh * globalMult); at = Math.floor(at * globalMult); df = Math.floor(df * globalMult); }
                Run.maxHp = mh; Run.atk = at; Run.def = df; Run.critRate = cr; Run.dodgeRate = dg;
                if (!Run.isActive) Run.currentHp = Run.maxHp; else if (Run.currentHp > Run.maxHp) Run.currentHp = Run.maxHp;
            },
            openChest: () => { if (Player.gems >= 5) { Player.gems -= 5; const template = GameData.items[Math.floor(Math.random()*GameData.items.length)]; const newItem = { ...template, uid: Date.now(), rarity: 0 }; Player.inventory.push(newItem); UI.log(`Obtenu : ${newItem.name}`); Game.checkFusion(); UI.updateAll(); Game.save(); } },
            checkFusion: () => {
                const groups = {}; Player.inventory.forEach(i => { const key = i.name + "_" + (i.rarity || 0); if (!groups[key]) groups[key] = []; groups[key].push(i); });
                for (const key in groups) {
                    if (groups[key].length >= 3) {
                        const baseItems = groups[key]; const base = baseItems[0];
                        for(let k=0; k<3; k++) { const idx = Player.inventory.findIndex(i => i.uid === baseItems[k].uid); if(idx !== -1) Player.inventory.splice(idx, 1); }
                        const newRarity = (base.rarity || 0) + 1; const newStat = Math.floor(base.stat * 2.2);
                        const newItem = { ...base, uid: Date.now(), rarity: newRarity, stat: newStat, name: base.name };
                        Player.inventory.push(newItem); UI.log(`FUSION R√âUSSIE ! ${base.name} (R${newRarity})`, 'event'); Game.checkFusion(); return;
                    }
                }
            },
            equipItem: (uid) => { const idx = Player.inventory.findIndex(i => i.uid === uid); if(idx === -1) return; const item = Player.inventory[idx]; if(Player.equipment[item.type]) Player.inventory.push(Player.equipment[item.type]); Player.equipment[item.type] = item; Player.inventory.splice(idx, 1); Game.calculateStats(); UI.updateAll(); Game.save(); },
            upgradeStat: (t) => { const c = 100 + (Player.baseStats[t]*50); if(Player.gold >= c) { Player.gold -= c; Player.baseStats[t]++; Game.calculateStats(); UI.updateAll(); Game.save(); } },
            toggleAuto: () => { Run.autoMode = !Run.autoMode; UI.updateControls(); if(Run.autoMode && Run.isActive && !Run.isProcessing) Game.triggerAction(); },
            toggleSpeed: () => { Run.speedMultiplier = (Run.speedMultiplier===1)?2:1; UI.updateControls(); },
            hardReset: () => { if(confirm("Reset ?")) { localStorage.removeItem('distory_save_v94'); location.reload(); } },
            save: () => localStorage.setItem('distory_save_v94', JSON.stringify(Player)),
            // V94.1 FIX: RE-ADD HAS SKILL
            hasSkill: (id) => Run.skills.some(s => s.id === id)
        };

        // --- V87: GEMINI CALLER ---
        async function callGemini(prompt) {
            if (!apiKey) throw new Error("API Key missing");
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await response.json();
                
                if (data.error) throw new Error(data.error.message);
                
                let text = data.candidates?.[0]?.content?.parts?.[0]?.text || "";
                if (text.startsWith("```json")) {
                    text = text.replace(/```json\n?|```/g, "");
                }
                return text;
            } catch (e) {
                console.error("Gemini Error:", e);
                throw e;
            }
        }

        window.Game = Game;
        window.UI = UI;
        window.onload = Game.init;

    </script>
</body>
</html>
