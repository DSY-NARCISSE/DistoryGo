<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Distory Go - V35 SERVER</title>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* === TH√àME DISCORD-LIKE === */
        :root { 
            --d-bg: #313338;        /* Fond principal */
            --d-panel: #2b2d31;     /* Panneaux lat√©raux */
            --d-chat: #313338;      /* Zone de chat */
            --d-blurple: #5865F2;   /* Couleur accent */
            --d-green: #23a559;     /* Valid√©/Soin */
            --d-red: #da373c;       /* Erreur/D√©g√¢ts */
            --d-yellow: #f0b232;    /* Avertissement */
            --d-text: #dbdee1;      /* Texte normal */
            --d-text-dim: #949ba4;  /* Texte secondaire */
            --d-hover: #3f4147;     /* Survol */
            
            --font-main: 'Open Sans', sans-serif;
        }
        
        body { 
            background-color: var(--d-bg); 
            color: var(--d-text); 
            font-family: var(--font-main); 
            overflow: hidden; height: 100vh; user-select: none; 
        }

        /* LAYOUT */
        .layout { display: grid; grid-template-columns: 300px 1fr 280px; gap: 0; height: 100vh; max-width: 1920px; margin: 0 auto; transition: filter 0.3s; }
        .layout.blur { filter: blur(5px); pointer-events: none; }

        /* SIDEBAR GAUCHE (PROFIL) */
        .sidebar-left { background: var(--d-panel); display: flex; flex-direction: column; border-right: 1px solid #1e1f22; }
        
        /* BANNIERE PROFIL */
        .user-card-header { height: 120px; background: var(--d-blurple); position: relative; border-radius: 8px 8px 0 0; margin: 10px; }
        .user-avatar { 
            width: 90px; height: 90px; background: var(--d-bg); border: 6px solid var(--d-panel); 
            border-radius: 50%; position: absolute; bottom: -45px; left: 15px; 
            display: flex; align-items: center; justify-content: center; font-size: 40px; cursor: pointer;
            transition: 0.2s;
        }
        .user-avatar:hover { transform: scale(1.05); border-color: var(--d-blurple); }
        .status-dot { width: 16px; height: 16px; background: var(--d-green); border: 3px solid var(--d-panel); border-radius: 50%; position: absolute; bottom: 5px; right: 5px; }

        /* CENTRE (CHAT & JEU) */
        .chat-area { background: var(--d-bg); display: flex; flex-direction: column; position: relative; }
        .channel-header { 
            height: 50px; border-bottom: 1px solid #26272d; display: flex; align-items: center; padding: 0 16px; 
            font-weight: bold; font-size: 16px; color: #fff; background: var(--d-panel);
        }
        .hashtag { color: var(--d-text-dim); margin-right: 8px; font-size: 20px; }

        /* ZONE DE JEU (EMBED STYLE) */
        .game-embed { 
            margin: 20px; background: #2b2d31; border-left: 4px solid var(--d-blurple); 
            border-radius: 4px; padding: 16px; display: flex; flex-direction: column; gap: 10px;
            flex-grow: 1; position: relative; overflow: hidden;
        }
        .embed-title { font-weight: 700; color: #fff; margin-bottom: 8px; }
        
        /* ENNEMI */
        .enemy-container { text-align: center; margin: auto; transition: 0.2s; }
        .enemy-emoji { font-size: 100px; filter: drop-shadow(0 5px 10px rgba(0,0,0,0.3)); }
        
        /* SIDEBAR DROITE (MEMBRES/SKILLS) */
        .sidebar-right { background: var(--d-panel); border-left: 1px solid #1e1f22; padding: 16px; overflow-y: auto; }
        .category-title { 
            font-size: 12px; font-weight: 700; color: var(--d-text-dim); text-transform: uppercase; 
            margin-bottom: 8px; margin-top: 16px; letter-spacing: 0.5px; 
        }
        .member-item { 
            display: flex; align-items: center; gap: 10px; padding: 6px 8px; 
            border-radius: 4px; cursor: pointer; transition: 0.1s; opacity: 0.9;
        }
        .member-item:hover { background: var(--d-hover); opacity: 1; }
        .member-avatar { width: 32px; height: 32px; border-radius: 50%; background: #313338; display: flex; align-items: center; justify-content: center; font-size: 18px; }
        .member-name { font-weight: 600; font-size: 14px; color: #f2f3f5; }
        .member-sub { font-size: 11px; color: var(--d-text-dim); }

        /* BOUTONS STYLE DISCORD */
        .btn-discord { 
            background: var(--d-blurple); color: #fff; font-weight: 600; border-radius: 4px; 
            padding: 10px 20px; transition: 0.2s; text-align: center; border: none; cursor: pointer;
        }
        .btn-discord:hover { background: #4752c4; }
        .btn-discord:active { transform: translateY(1px); }
        .btn-discord.secondary { background: #4e5058; }
        .btn-discord.secondary:hover { background: #6d6f78; }
        .btn-discord.danger { background: var(--d-red); }
        .btn-discord.danger:hover { background: #a1282c; }
        .btn-discord:disabled { opacity: 0.5; cursor: not-allowed; }

        /* BARRES */
        .bar-bg { height: 8px; background: #111214; border-radius: 4px; overflow: hidden; width: 100%; margin-top: 4px; }
        .bar-fill { height: 100%; border-radius: 4px; transition: width 0.2s; }
        .hp-color { background: var(--d-green); }
        .xp-color { background: var(--d-blurple); }

        /* LOGS CHAT */
        .chat-log { 
            height: 150px; overflow-y: auto; padding: 10px 20px; 
            border-top: 1px solid #26272d; background: #313338; 
            font-size: 14px; display: flex; flex-direction: column-reverse; 
        }
        .msg { margin-bottom: 4px; line-height: 1.4; display: flex; gap: 8px; }
        .msg-time { font-size: 10px; color: var(--d-text-dim); margin-top: 4px; width: 35px; }
        
        /* ECRAN TITRE */
        .screen-overlay { 
            position: fixed; inset: 0; background: var(--d-bg); z-index: 2000; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
        }
        .screen-overlay.hidden { opacity: 0; pointer-events: none; }
        
        .menu-input { 
            background: #1e1f22; border: none; color: #fff; padding: 12px; width: 300px; 
            border-radius: 4px; margin-bottom: 16px; outline: none; font-size: 16px;
        }
        .menu-input:focus { background: #1e1f22; }

        /* TOOLTIP (POPUP PROFIL) */
        #tooltip { 
            position: fixed; pointer-events: none; z-index: 5000; 
            background: #111214; border-radius: 8px; padding: 16px; width: 250px; 
            display: none; box-shadow: 0 8px 16px rgba(0,0,0,0.24);
            border-left: 4px solid var(--d-blurple);
        }
        #tooltip.visible { display: block; }
        .tt-header { font-weight: 700; font-size: 16px; margin-bottom: 4px; color: #fff; }
        .tt-body { font-size: 13px; color: var(--d-text-dim); line-height: 1.4; }
        .tt-stat { background: #2b2d31; padding: 4px 8px; border-radius: 4px; font-size: 11px; margin-top: 8px; display: inline-block; color: #fff; }

        /* FX */
        .dmg { position: absolute; font-weight: 900; font-size: 24px; animation: fly 0.8s forwards; pointer-events: none; z-index: 50; text-shadow: 1px 1px 0 black; }
        @keyframes fly { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(-50px); opacity: 0; } }
        .shake-anim { animation: shake 0.2s; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

        /* MODAL */
        #modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 1000; display: flex; align-items: center; justify-content: center; }
        .modal-box { background: #313338; padding: 24px; border-radius: 8px; width: 440px; box-shadow: 0 0 0 1px #1e1f22, 0 2px 10px 0 rgba(0,0,0,0.2); }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="start-screen" class="screen-overlay">
        <div class="mb-8 text-center">
            <div class="text-3xl font-bold text-white mb-2">Bienvenue sur le Serveur</div>
            <div class="text-[#949ba4]">Veuillez vous identifier pour commencer.</div>
        </div>
        <input type="text" id="player-pseudo" class="menu-input" placeholder="Pseudo..." maxlength="12">
        <button onclick="Core.bootGame()" class="btn-discord w-[300px] mb-2">Rejoindre</button>
        <button onclick="Core.hardReset()" class="btn-discord danger w-[300px]">R√©initialiser le compte</button>
    </div>

    <div id="game-ui" class="layout blur">
        
        <div class="sidebar-left p-0">
            <div class="user-card-header">
                <div class="absolute top-2 right-2 flex gap-1">
                    <button onclick="UI.modal('settings')" class="w-8 h-8 bg-black/20 rounded hover:bg-black/40 text-white flex items-center justify-center">‚öôÔ∏è</button>
                </div>
            </div>
            <div class="px-4 pb-4 pt-12 relative">
                <div id="vis-hero" class="user-avatar">?</div>
                <div class="status-dot"></div>
                <div class="text-xl font-bold text-white mt-2" id="ui-pseudo">...</div>
                <div class="text-sm text-[#949ba4] mb-4">#<span id="ui-id">0001</span></div>
                
                <div class="bg-[#1e1f22] p-3 rounded mb-4">
                    <div class="text-xs font-bold text-[#949ba4] uppercase mb-1">√Ä PROPOS DE MOI</div>
                    <div class="text-sm">Niveau <span id="ui-lvl" class="text-white">1</span></div>
                    <div class="bar-bg"><div class="bar-fill xp-color" style="width: 0%"></div></div>
                </div>

                <div class="space-y-3">
                    <div>
                        <div class="flex justify-between text-xs font-bold text-[#949ba4] mb-1">SANT√â <span id="ui-hp-txt" class="text-white">100/100</span></div>
                        <div class="bar-bg"><div id="ui-hp-bar" class="bar-fill hp-color"></div></div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2 mt-4">
                        <div class="bg-[#1e1f22] p-2 rounded text-center">
                            <div class="text-[10px] text-[#949ba4] font-bold">ATK</div>
                            <div id="ui-atk" class="text-lg font-bold text-white">10</div>
                        </div>
                        <div class="bg-[#1e1f22] p-2 rounded text-center">
                            <div class="text-[10px] text-[#949ba4] font-bold">DEF</div>
                            <div id="ui-def" class="text-lg font-bold text-white">0</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="chat-area">
            <div class="channel-header">
                <span class="hashtag">#</span> aventure-rpg
                <div class="ml-auto flex gap-4 text-xs text-[#949ba4]">
                    <span class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-red-500"></span> <span id="ui-gold">0</span> Mentions</span>
                    <span class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-[#f47fff]"></span> <span id="ui-perls">0</span> Boosts</span>
                </div>
            </div>

            <div class="game-embed">
                <div class="embed-title">JOUR <span id="ui-day">1</span></div>
                
                <div class="flex-grow flex flex-col items-center justify-center relative">
                    <div id="enemy-box" class="enemy-container hidden">
                        <div class="w-48 h-2 bg-black/50 rounded overflow-hidden mb-2 mx-auto"><div id="ui-en-bar" class="h-full bg-red-500 w-full transition-all"></div></div>
                        <div id="vis-enemy" class="enemy-emoji">üëπ</div>
                        <div id="name-enemy" class="font-bold text-white mt-2 bg-black/50 px-2 rounded">Troll Internet</div>
                    </div>
                    <div id="text-box" class="text-center">
                        <div id="txt-1" class="text-2xl font-bold text-white mb-2">EN LIGNE</div>
                        <div id="txt-2" class="text-[#949ba4]">En attente d'activit√©...</div>
                    </div>
                </div>

                <div class="grid grid-cols-4 gap-2 mt-auto">
                    <div class="col-span-3">
                        <button id="btn-act" onclick="Core.click()" class="btn-discord w-full h-full text-lg">LANCER</button>
                    </div>
                    <div class="flex flex-col gap-2">
                        <button id="btn-auto" onclick="Core.toggleAuto()" class="btn-discord secondary text-xs py-2">AUTO: OFF</button>
                        <button id="btn-speed" onclick="Core.toggleSpeed()" class="btn-discord secondary text-xs py-2">VIT: x1</button>
                    </div>
                </div>
            </div>

            <div id="logs" class="chat-log"></div>
        </div>

        <div class="sidebar-right">
            <div class="category-title">INVENTAIRE ‚Äî 3</div>
            <div id="inv-list"></div>

            <div class="category-title">COMP√âTENCES ACQUISES ‚Äî <span id="skill-count">0</span></div>
            <div id="skill-list"></div>
            
            <div class="mt-4 pt-4 border-t border-[#3f4147]">
                <button onclick="Core.chest()" class="btn-discord w-full text-sm mb-2" style="background-color: #f47fff;">LOOTBOX (5üíé)</button>
                <button onclick="UI.tab('hub')" class="btn-discord w-full text-sm secondary">PARAM√àTRES DU SERVEUR</button>
            </div>
        </div>

    </div>

    <div id="view-hub" class="hidden absolute inset-0 bg-[#313338] z-40 flex flex-col items-center justify-center p-10">
        <h2 class="text-3xl text-white font-bold mb-8">CONFIGURATION DU SERVEUR</h2>
        <div class="grid grid-cols-3 gap-4 w-full max-w-4xl">
            <div onclick="Core.upg('hp')" class="bg-[#2b2d31] p-6 rounded hover:bg-[#35373c] cursor-pointer text-center">
                <div class="text-4xl mb-2">üõ°Ô∏è</div>
                <div class="font-bold text-white">MOD√âRATION (HP)</div>
                <div class="text-xs text-[#949ba4]">+20 PV Max</div>
                <div class="mt-2 bg-[#1e1f22] px-2 py-1 rounded text-xs text-red-400 font-mono inline-block" id="cost-hp">100 Mentions</div>
            </div>
            <div onclick="Core.upg('atk')" class="bg-[#2b2d31] p-6 rounded hover:bg-[#35373c] cursor-pointer text-center">
                <div class="text-4xl mb-2">üî®</div>
                <div class="font-bold text-white">BAN HAMMER (ATK)</div>
                <div class="text-xs text-[#949ba4]">+5 D√©g√¢ts</div>
                <div class="mt-2 bg-[#1e1f22] px-2 py-1 rounded text-xs text-red-400 font-mono inline-block" id="cost-atk">100 Mentions</div>
            </div>
            <div onclick="Core.upg('def')" class="bg-[#2b2d31] p-6 rounded hover:bg-[#35373c] cursor-pointer text-center">
                <div class="text-4xl mb-2">ü§ñ</div>
                <div class="font-bold text-white">ANTI-RAID (DEF)</div>
                <div class="text-xs text-[#949ba4]">+2 Armure</div>
                <div class="mt-2 bg-[#1e1f22] px-2 py-1 rounded text-xs text-red-400 font-mono inline-block" id="cost-def">100 Mentions</div>
            </div>
        </div>
        <button onclick="UI.tab('adv')" class="mt-8 text-[#949ba4] hover:underline">Retour au salon #g√©n√©ral</button>
    </div>

    <div id="fx-layer" class="fixed inset-0 pointer-events-none z-50"></div>
    <div id="toast-container" class="fixed top-20 left-1/2 -translate-x-1/2 z-[60] flex flex-col gap-2 w-auto"></div>
    <div id="tooltip"></div>
    <div id="modal-overlay" class="hidden"><div id="modal-content" class="modal-box"></div></div>

    <script>
        // --- AUDIO ---
        const AudioSys = {
            ctx: null, muted: false,
            init: () => { window.AudioContext = window.AudioContext || window.webkitAudioContext; AudioSys.ctx = new AudioContext(); },
            play: (type) => {
                if(AudioSys.muted || !AudioSys.ctx) return;
                const o = AudioSys.ctx.createOscillator(); const g = AudioSys.ctx.createGain();
                o.connect(g); g.connect(AudioSys.ctx.destination);
                const t = AudioSys.ctx.currentTime;
                if(type==='coin'){ // Discord join sound approx
                    o.type='sine'; o.frequency.setValueAtTime(400,t); o.frequency.setValueAtTime(600,t+0.1); 
                    g.gain.setValueAtTime(0.1,t); g.gain.linearRampToValueAtTime(0,t+0.3); o.start(t); o.stop(t+0.3);
                } else if(type==='hit'){ // Notification sound
                    o.type='triangle'; o.frequency.setValueAtTime(200,t); g.gain.setValueAtTime(0.1,t); g.gain.exponentialRampToValueAtTime(0.01,t+0.1); o.start(t); o.stop(t+0.1);
                }
            },
            toggle: () => { AudioSys.muted = !AudioSys.muted; UI.toast(AudioSys.muted ? "Son muet" : "Son activ√©"); }
        };

        // --- DATA ---
        const DB = {
            chars: [{id:"üòé",n:"Admin"}, {id:"ü§ñ",n:"Bot"}, {id:"üé®",n:"Artiste"}, {id:"üéÆ",n:"Gamer"}],
            enemies: {
                common: [{n:"Spammer",hp:50,atk:5,i:"üì¢"}, {n:"Troll",hp:40,atk:8,i:"ü§°"}, {n:"Ghost",hp:30,atk:10,i:"üëª"}, {n:"Alt Account",hp:60,atk:6,i:"üé≠"}],
                boss: [{n:"RAIDER",hp:600,atk:20,i:"üè¥‚Äç‚ò†Ô∏è"}, {n:"HACKER",hp:800,atk:25,i:"üíª"}]
            },
            skills: {
                'fire': {n:"Mute",i:"üîá",d:"R√©duit l'attaque ennemie (D√©g√¢ts)"}, 
                'heal':{n:"Nitro",i:"üöÄ",d:"R√©g√©n√©ration de PV par tour"},
                'bolt':{n:"Ban",i:"üî®",d:"Chance de coup critique"}, 
                'shield':{n:"Slowmode",i:"‚è±Ô∏è",d:"Augmente la d√©fense"},
                'luck':{n:"Giveaway",i:"üéÅ",d:"Plus de butin"}
            },
            events: [
                {t:"Nouveau Membre", d:"Un utilisateur rejoint le serveur.", c:[{t:"Accueillir (+Or)",a:"loot_gold"},{t:"Ignorer",a:"leave"}]},
                {t:"Drama", d:"Une dispute √©clate dans le g√©n√©ral.", c:[{t:"Mod√©rer (-PV)",a:"dmg_low"},{t:"Regarder",a:"leave"}]},
                {t:"Serveur Down", d:"Probl√®me de connexion.", c:[{t:"Attendre",a:"leave"},{t:"R√©parer (+XP)",a:"skill_xp"}]},
                {t:"Lien Suspect", d:"Quelqu'un a post√© un lien.", c:[{t:"Cliquer",a:"curse"},{t:"Supprimer",a:"loot_gold"}]}
            ],
            items: [{n:"Clavier",e:"‚å®Ô∏è",s:10,t:"weapon",r:"r-common",d:"M√©canique."}, {n:"Casque",e:"üéß",s:20,t:"head",r:"r-common",d:"Anti-bruit."}, {n:"Badge",e:"üìõ",s:5,t:"pet",r:"r-common",d:"Certifi√©."}]
        };

        let D = { gold:0, perls:50, stats:{hp:0,atk:0,def:0}, weapon:null, head:null, pet:null, inv:[], char:null, pseudo:"USER" };
        let R = { active:false, day:0, hp:100, max:100, atk:10, def:0, skills:[] };
        let C = { active:false, hp:0, max:0, atk:0, boss:false };
        let Conf = { auto:false, speed:1, pause: false };
        let Act = null;

        const Core = {
            bootGame: () => {
                AudioSys.init();
                const n = document.getElementById('player-pseudo').value.trim();
                if(n) D.pseudo = n;
                document.getElementById('ui-id').innerText = Math.floor(Math.random()*9000)+1000;
                document.getElementById('start-screen').classList.add('hidden');
                document.getElementById('game-ui').classList.remove('blur');
                Core.init();
            },
            init: () => {
                let s = localStorage.getItem('distory_v35');
                if(s) { try { let l = JSON.parse(s); if(l.char) D = l; } catch(e) {} }
                document.getElementById('ui-pseudo').innerText = D.pseudo;
                if(!D.char) UI.modal('char');
                else { Core.calc(); UI.upd(); if(R.active && !C.active) UI.btn("CONTINUER", Core.next); else if(C.active) { C.active=false; UI.btn("REPRENDRE", Core.next); } else UI.btn("LANCER LE SERVEUR", Core.start); }
            },
            resetGame: () => { localStorage.clear(); location.reload(); },
            hardReset: () => { if(confirm("Supprimer le compte ?")) Core.resetGame(); },
            returnToTitle: () => { Core.save(); location.reload(); },
            save: () => localStorage.setItem('distory_v35', JSON.stringify(D)),
            
            calc: () => {
                R.max = 100 + (D.stats.hp*20); R.atk = 10 + (D.stats.atk*5); R.def = 0 + (D.stats.def*2);
                if(D.weapon) R.atk += D.weapon.s; if(D.head) { R.def += D.head.s; R.max += D.head.s; } if(D.pet) R.atk += D.pet.s;
                let sAtk = R.skills.find(s=>s.id==='fire'); if(sAtk) R.atk += (5*sAtk.lvl);
                let sDef = R.skills.find(s=>s.id==='shield'); if(sDef) R.def += (2*sDef.lvl);
                R.hp = Math.min(R.hp, R.max);
            },
            
            upg: (t) => {
                let cost = 100 + (D.stats[t] * 50);
                if(D.gold >= cost) { D.gold -= cost; D.stats[t]++; Core.save(); Core.calc(); UI.upd(); UI.toast("Niveau Sup√©rieur !", "success"); AudioSys.play('coin'); } 
                else UI.toast("Pas assez de Mentions", "err");
            },

            pick: (c) => { 
                D.char = c; 
                if(c==='üòé'){D.weapon={n:"Banhammer",e:"üî®",s:5,t:"weapon",r:"r-rare",d:"Excalibur des admins"}; D.head={n:"Casquette",e:"üß¢",s:5,t:"head",r:"r-common",d:"Dev"}; D.pet={n:"Bot Musique",e:"üéµ",s:5,t:"pet",r:"r-common",d:"DJ"};}
                else {D.weapon={n:"Clavier",e:"‚å®Ô∏è",s:5,t:"weapon",r:"r-common",d:"RGB"}; D.head={n:"Casque",e:"üéß",s:5,t:"head",r:"r-common",d:"Gamer"}; D.pet={n:"Wumpus",e:"üê∑",s:5,t:"pet",r:"r-common",d:"Mascotte"};}
                Core.save(); document.getElementById('modal-overlay').classList.add('hidden'); UI.upd(); UI.btn("INITIALISER", Core.start); AudioSys.play('coin'); 
            },
            start: () => { Core.calc(); R.hp=R.max; R.day=1; R.active=true; R.skills=[]; UI.scene('adv'); UI.btn("JOUR SUIVANT", Core.next); UI.txt("SERVEUR ONLINE","En attente de membres"); AudioSys.play('coin'); Core.next(); },
            
            next: () => { 
                if(Conf.pause) return;
                R.day++; Core.calc(); UI.upd(); 
                if(R.day === 60) { Core.fight(true); return; }
                if(R.day % 5 === 0) { UI.modal('shop'); UI.txt("BOT SHOP","Vente de r√¥les"); return; }
                let roll = Math.random();
                if(roll < 0.2) Core.fight(false); 
                else if (roll < 0.9) Core.triggerEvent(); 
                else UI.modal('skill-choice'); 
                UI.upd();
            },
            
            triggerEvent: () => { let ev = DB.events[Math.floor(Math.random()*DB.events.length)]; UI.modal('event', ev); },
            resolveEvent: (a) => {
                document.getElementById('modal-overlay').classList.add('hidden');
                let res = "Rien de sp√©cial."; let bad = false;
                if(a.includes('loot')) { D.gold += 30; res = "+30 Mentions r√©cup√©r√©es."; }
                else if(a.includes('dmg')) { R.hp -= 15; res = "Tu as perdu des PV (-15)."; bad=true; }
                else if(a.includes('heal')) { R.hp = Math.min(R.max, R.hp+40); res = "Pause caf√© (+40 PV)."; }
                else if(a === 'fight') { Core.fight(false); return; }
                else if(a === 'skill_xp') { D.gold += 50; res = "Tu as gagn√© de l'XP (+50)."; }
                else if(a === 'curse') { R.hp -= 5; res = "Virus ! (-5 PV)"; bad=true; }
                else if(a === 'leave') { res = "Tu ignores l'√©v√©nement."; }
                UI.log(res); UI.toast(res, bad?'err':'success'); UI.upd(); Core.checkAuto();
            },

            addSkill: (id) => {
                let s = R.skills.find(x=>x.id===id); if(s) s.lvl++; else R.skills.push({id:id, lvl:1});
                document.getElementById('modal-overlay').classList.add('hidden'); UI.toast("NOUVELLE PERM", "loot"); Core.calc(); UI.upd(); Core.checkAuto();
            },

            fight: (boss) => { 
                C.active = true; C.boss = boss;
                let pool = boss ? DB.enemies.boss : DB.enemies.common; let en = pool[Math.floor(Math.random() * pool.length)]; 
                let scale = 1 + (R.day * 0.1); C.max = Math.floor(en.hp * scale * (boss?3:1)); C.hp = C.max; C.atk = Math.floor(en.atk * scale * (boss?1.5:1)); 
                UI.scene('com'); document.getElementById('vis-enemy').innerText = en.i; document.getElementById('name-enemy').innerText = boss ? "RAID : "+en.n : en.n;
                UI.btn(boss ? "CONTRE-ATTAQUE" : "BANNIR", null, true); 
                setTimeout(Core.turn, 800/Conf.speed); 
            },
            turn: () => { 
                if(!C.active || Conf.pause) return; 
                let dmg = R.atk; let vamp = R.skills.find(s=>s.id==='heal'); if(vamp && Math.random()<0.3) { R.hp += (2*vamp.lvl); UI.toast("BOOST HP"); }
                C.hp -= dmg; UI.fx(dmg, '#5865F2', 'vis-enemy'); UI.shake('vis-enemy'); UI.bar(); AudioSys.play('hit'); 
                if(C.hp <= 0) { setTimeout(()=>Core.end(true), 500/Conf.speed); return; } 
                setTimeout(()=>{ 
                    if(!C.active || Conf.pause) return; 
                    let edmg = Math.max(1, C.atk - R.def); R.hp -= edmg; UI.fx(edmg, '#da373c', 'vis-hero'); UI.shake('vis-hero'); UI.upd(); AudioSys.play('hit'); 
                    if(R.hp <= 0) Core.end(false); else setTimeout(Core.turn, 800/Conf.speed); 
                }, 500/Conf.speed); 
            },
            end: (win) => { 
                C.active = false; 
                if(win) { 
                    let gain = 15 + R.day + (C.boss ? 50 : 0); D.gold += gain; if(C.boss) { D.perls += 5; UI.toast("RAID STOPP√â ! (+5 üíé)", "loot"); }
                    UI.log(`Utilisateur banni ! (+${gain} üî¥)`); UI.btn("CONTINUER", Core.next); AudioSys.play('coin'); Core.checkAuto(); 
                } else { R.active = false; UI.log("Serveur crash√©..."); UI.btn("RED√âMARRER", Core.start); } 
                Core.save(); UI.scene('adv'); 
            },
            
            click: () => { if(Act) Act(); },
            checkAuto: () => { if(Conf.auto && R.active && !C.active && !Conf.pause && document.getElementById('modal-overlay').classList.contains('hidden')) setTimeout(() => { let b=document.getElementById('btn-act'); if(!b.disabled) b.click(); }, 1000/Conf.speed); },
            toggleAuto: () => { Conf.auto = !Conf.auto; document.getElementById('btn-auto').innerText = Conf.auto ? "AUTO: ON" : "AUTO: OFF"; document.getElementById('btn-auto').classList.toggle('secondary'); if(Conf.auto) Core.checkAuto(); },
            toggleSpeed: () => { Conf.speed = Conf.speed === 1 ? 2 : 1; document.getElementById('btn-speed').innerText = `VIT: x${Conf.speed}`; },
            chest: () => { if(D.perls >= 5) { D.perls -= 5; let i = DB.items[Math.floor(Math.random()*DB.items.length)]; D.inv.push({...i, uid:Date.now()}); Core.save(); UI.upd(); UI.toast("ITEM RE√áU", "loot"); AudioSys.play('coin'); } },
            equip: (idx) => { let it = D.inv[idx]; if(D[it.t]) D.inv.push(D[it.t]); D[it.t] = it; D.inv.splice(idx,1); Core.save(); Core.calc(); UI.upd(); AudioSys.play('coin'); },
            bloodPact: () => { if(R.max > 20) { D.stats.hp--; Core.calc(); UI.toast("DON DE SOI", "err"); UI.modal('skill-choice'); } else UI.toast("HP TROP BAS", "err"); }
        };

        const UI = {
            upd: () => {
                document.getElementById('ui-gold').innerText = D.gold;
                document.getElementById('ui-perls').innerText = D.perls;
                document.getElementById('ui-day').innerText = R.day;
                document.getElementById('ui-lvl').innerText = D.level || 1;
                ['hp','atk','def'].forEach(k => document.getElementById('cost-'+k).innerText = (100 + D.stats[k]*50) + " üî¥");
                if(R.active || D.char) { document.getElementById('ui-hp-txt').innerText = `${Math.floor(R.hp)}/${R.max}`; document.getElementById('ui-hp-bar').style.width = (R.hp/R.max*100)+"%"; document.getElementById('ui-atk').innerText = R.atk; document.getElementById('ui-def').innerText = R.def; }
                if(D.char) document.getElementById('vis-hero').innerText = D.char;
                
                // SKILLS LIST (RIGHT)
                let sl = document.getElementById('skill-list'); sl.innerHTML = '';
                document.getElementById('skill-count').innerText = R.skills.length;
                if(R.skills.length === 0) sl.innerHTML = '<div class="text-[#949ba4] text-xs px-2">Aucun r√¥le.</div>';
                R.skills.forEach(s => { 
                    let inf = DB.skills[s.id]; 
                    sl.innerHTML += `<div class="member-item" onmouseenter="UI.tip(event, '${inf.n}', '${inf.d}')" onmouseleave="UI.untip()"><div class="member-avatar">${inf.i}</div><div><div class="member-name" style="color:#5865F2">${inf.n}</div><div class="member-sub">Niveau ${s.lvl}</div></div></div>`; 
                });

                // INVENTORY LIST (RIGHT)
                let il = document.getElementById('inv-list'); il.innerHTML = '';
                if(D.inv.length === 0) il.innerHTML = '<div class="text-[#949ba4] text-xs px-2">Inventaire vide.</div>';
                D.inv.forEach((it,i) => {
                    il.innerHTML += `<div class="member-item" onclick="Core.equip(${i})" onmouseenter="UI.tip(event, '${it.n}', '${it.d} (+${it.s} Stats)')" onmouseleave="UI.untip()"><div class="member-avatar">${it.e}</div><div><div class="member-name">${it.n}</div><div class="member-sub">Cliquer pour √©quiper</div></div></div>`;
                });
            },
            bar: () => document.getElementById('ui-en-bar').style.width = (C.hp/C.max*100)+"%",
            scene: (t) => { let e=document.getElementById('enemy-box'), tx=document.getElementById('text-box'); if(t==='com'){e.classList.remove('hidden'); tx.classList.add('hidden');}else{e.classList.add('hidden'); tx.classList.remove('hidden');} },
            btn: (t,a,dis) => { let b=document.getElementById('btn-act'); b.innerText=t; Act=a; b.disabled=dis; },
            txt: (t,s) => { document.getElementById('txt-1').innerText=t; document.getElementById('txt-2').innerText=s; },
            log: (m) => { 
                let t = new Date().toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'});
                let l=document.getElementById('logs'); 
                l.innerHTML=`<div class="msg"><div class="msg-time">${t}</div><div><span class="font-bold text-[#f2f3f5]">Syst√®me</span> <span class="text-[#dbdee1]">${m}</span></div></div>`+l.innerHTML; 
            },
            fx: (t,c,id) => { let el=document.createElement('div'); el.className='dmg'; el.style.color=c; el.innerText=t; let r=document.getElementById(id).getBoundingClientRect(); el.style.left=(r.left+20)+'px'; el.style.top=r.top+'px'; document.getElementById('fx-layer').appendChild(el); setTimeout(()=>el.remove(),800); },
            shake: (id) => { let el=document.getElementById(id); el.classList.remove('shake-anim'); void el.offsetWidth; el.classList.add('shake-anim'); },
            toast: (m,t) => { let d=document.createElement('div'); let c = t==='err'?'bg-red-500':'bg-[#5865F2]'; d.className=`toast ${c} text-white px-4 py-2 rounded shadow-lg`; d.innerText=m; document.getElementById('toast-container').appendChild(d); setTimeout(()=>d.remove(),2500); },
            modal: (t, data) => { 
                let l=document.getElementById('modal-overlay'), c=document.getElementById('modal-content'); l.classList.remove('hidden'); 
                if(t==='settings') {
                    Conf.pause = true;
                    c.innerHTML=`<h2 class="text-white text-xl font-bold mb-6">Param√®tres Utilisateur</h2>
                    <button onclick="UI.closeModal()" class="btn-discord w-full mb-2 bg-[#23a559]">Reprendre</button>
                    <button onclick="AudioSys.toggle()" class="btn-discord secondary w-full mb-2">Son On/Off</button>
                    <button onclick="Core.returnToTitle()" class="btn-discord secondary w-full mb-2">D√©connexion</button>
                    <button onclick="Core.hardReset()" class="btn-discord danger w-full">Supprimer le compte</button>`;
                } else if(t==='char') c.innerHTML=`<h2 class="text-white text-2xl font-bold mb-4">Choisis ton R√¥le</h2><div class="flex gap-4 justify-center">${DB.chars.map(x=>`<button onclick="Core.pick('${x.id}')" class="text-6xl p-4 bg-[#2b2d31] rounded-full hover:bg-[#5865F2] transition">${x.id}</button>`).join('')}</div>`; 
                else if(t==='shop') c.innerHTML=`<h2 class="text-[#f0b232] text-xl font-bold mb-4">BOUTIQUE SERVEUR</h2><button onclick="Core.bloodPact()" class="w-full p-4 bg-[#2b2d31] border border-red-500 text-red-400 font-bold mb-2">ü©∏ Vendre Donn√©es (-20 Max HP = R√¥le)</button><button onclick="document.getElementById('modal-overlay').classList.add('hidden');Core.checkAuto()" class="text-[#949ba4] hover:underline">Fermer</button>`;
                else if(t==='skill-choice') {
                    let k1=Object.keys(DB.skills)[Math.floor(Math.random()*5)], k2=Object.keys(DB.skills)[Math.floor(Math.random()*5)], k3=Object.keys(DB.skills)[Math.floor(Math.random()*5)];
                    c.innerHTML=`<h2 class="text-[#5865F2] text-xl font-bold mb-4">NOUVEAU R√îLE D√âBLOQU√â</h2><div class="grid grid-cols-3 gap-2">
                        <div class="bg-[#2b2d31] p-4 rounded hover:bg-[#404249] cursor-pointer" onclick="Core.addSkill('${k1}')"><div class="text-3xl mb-2">${DB.skills[k1].i}</div><div class="font-bold text-white text-sm">${DB.skills[k1].n}</div></div>
                        <div class="bg-[#2b2d31] p-4 rounded hover:bg-[#404249] cursor-pointer" onclick="Core.addSkill('${k2}')"><div class="text-3xl mb-2">${DB.skills[k2].i}</div><div class="font-bold text-white text-sm">${DB.skills[k2].n}</div></div>
                        <div class="bg-[#2b2d31] p-4 rounded hover:bg-[#404249] cursor-pointer" onclick="Core.addSkill('${k3}')"><div class="text-3xl mb-2">${DB.skills[k3].i}</div><div class="font-bold text-white text-sm">${DB.skills[k3].n}</div></div>
                    </div>`;
                }
                else if(t==='event') {
                    c.innerHTML=`<h2 class="text-[#5865F2] text-xl font-bold mb-2">${data.t}</h2><p class="text-[#dbdee1] mb-6">${data.d}</p>
                    <button onclick="Core.resolveEvent('${data.c[0].a}')" class="btn-discord w-full mb-2">${data.c[0].t}</button>
                    <button onclick="Core.resolveEvent('${data.c[1].a}')" class="btn-discord secondary w-full">${data.c[1].t}</button>`;
                }
            },
            closeModal: () => { document.getElementById('modal-overlay').classList.add('hidden'); Conf.pause = false; if(R.active && !C.active) Core.checkAuto(); },
            tab: (t) => document.getElementById('view-hub').classList.toggle('hidden', t!=='hub'),
            tip: (e, t, d) => { 
                let tt = document.getElementById('tooltip'); 
                tt.innerHTML = `<div class="tt-header">${t}</div><div class="tt-body">${d}</div>`; 
                tt.classList.add('visible'); 
                // Position intelligente
                let x = e.clientX + 15; let y = e.clientY + 15;
                if(x + 250 > window.innerWidth) x -= 270; // Flip left if near edge
                tt.style.left = x + 'px'; tt.style.top = y + 'px'; 
            },
            untip: () => document.getElementById('tooltip').classList.remove('visible')
        };
        
        document.addEventListener('mousemove', (e) => { let tt = document.getElementById('tooltip'); if(tt.classList.contains('visible')) { 
            let x = e.clientX + 15; let y = e.clientY + 15;
            if(x + 250 > window.innerWidth) x -= 270;
            tt.style.left = x + 'px'; tt.style.top = y + 'px'; 
        } });
        window.onload = Core.bootGame;
    </script>
</body>
</html>
