<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Distory Go - V60 TITAN</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ==========================================================================
           1. VARIABLES ET CONFIGURATION GRAPHIQUE
           ========================================================================== */
        :root {
            --color-background: #02050e;
            --color-panel: rgba(10, 15, 30, 0.98);
            --color-border: #1e293b;
            --color-highlight: #3b82f6; /* Bleu N√©on */
            --color-accent: #a855f7;    /* Violet */
            --color-danger: #ef4444;    /* Rouge */
            --color-gold: #fbbf24;      /* Or */
            --color-text-main: #e2e8f0;
            --color-text-dim: #64748b;
        }

        body {
            background-color: var(--color-background);
            color: var(--color-text-main);
            font-family: 'Rajdhani', sans-serif;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            user-select: none;
            margin: 0;
            padding: 0;
        }

        /* ==========================================================================
           2. ANIMATIONS KEYFRAMES (EXPLICITES)
           ========================================================================== */
        
        /* Respiration de l'avatar */
        @keyframes animation-breathe {
            0% { transform: scale(1); filter: drop-shadow(0 0 10px rgba(59, 130, 246, 0.4)); }
            50% { transform: scale(1.05); filter: drop-shadow(0 0 30px rgba(59, 130, 246, 0.8)); }
            100% { transform: scale(1); filter: drop-shadow(0 0 10px rgba(59, 130, 246, 0.4)); }
        }

        /* Laser de Scan */
        @keyframes animation-scan {
            0% { top: -20px; opacity: 0; box-shadow: 0 0 5px var(--color-highlight); }
            10% { opacity: 1; box-shadow: 0 0 20px var(--color-highlight); }
            90% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }

        /* Tremblement d'impact (Cible) */
        @keyframes animation-shake-target {
            0% { transform: translate(0, 0) rotate(0deg); }
            25% { transform: translate(-10px, 10px) rotate(-5deg); }
            50% { transform: translate(10px, -10px) rotate(5deg); }
            75% { transform: translate(-10px, -10px) rotate(-5deg); }
            100% { transform: translate(0, 0) rotate(0deg); }
        }

        /* Tremblement d'√©cran (D√©g√¢ts re√ßus) */
        @keyframes animation-shake-screen {
            0% { transform: translate(0, 0); filter: brightness(1); }
            10% { transform: translate(-5px, 0); filter: brightness(1.5) sepia(1) hue-rotate(-50deg) saturate(3); }
            20% { transform: translate(5px, 0); }
            30% { transform: translate(-5px, 0); }
            100% { transform: translate(0, 0); filter: brightness(1); }
        }

        /* Attaque du joueur (Charge vers la droite) */
        @keyframes animation-attack-player {
            0% { transform: translateX(0) scale(1); }
            20% { transform: translateX(-20px) scale(0.9); } /* Anticipation */
            50% { transform: translateX(150px) scale(1.2); } /* Impact */
            100% { transform: translateX(0) scale(1); }
        }

        /* Classes utilitaires pour d√©clencher les animations via JS */
        .effect-breathe { animation: animation-breathe 4s infinite ease-in-out; }
        .effect-scanning { display: block !important; animation: animation-scan 0.8s linear forwards; }
        .effect-shake-target { animation: animation-shake-target 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        .effect-shake-screen { animation: animation-shake-screen 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        .effect-attack { animation: animation-attack-player 0.3s ease-out forwards; }

        /* ==========================================================================
           3. STYLES DES √âL√âMENTS DU JEU
           ========================================================================== */
        
        /* Laser Overlay */
        #laser-overlay {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 4px;
            background-color: var(--color-highlight);
            box-shadow: 0 0 30px var(--color-highlight);
            z-index: 999;
            pointer-events: none;
            display: none;
        }

        /* Layout Grid */
        .main-grid {
            display: grid;
            grid-template-columns: 350px 1fr 320px;
            gap: 15px;
            height: 100vh;
            padding: 15px;
            transition: filter 0.3s;
        }
        .blur-active { filter: blur(10px) brightness(0.5); pointer-events: none; }

        /* Panels */
        .panel {
            background-color: var(--color-panel);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .panel-header {
            padding: 15px;
            background: rgba(255, 255, 255, 0.02);
            border-bottom: 1px solid var(--color-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 700;
            font-size: 14px;
            letter-spacing: 1px;
            color: var(--color-highlight);
            text-transform: uppercase;
        }

        /* Avatar Zone */
        .avatar-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            padding: 20px;
        }
        .avatar-display { font-size: 140px; transition: transform 0.2s; }

        /* Bars & Stats */
        .hp-bar-track {
            width: 100%;
            height: 8px;
            background-color: #000;
            border: 1px solid #334155;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }
        .hp-bar-fill {
            height: 100%;
            background-color: var(--color-danger);
            width: 100%;
            transition: width 0.3s ease-out;
        }

        .stats-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 0 20px 20px; }
        .stat-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--color-border);
            border-radius: 6px;
            padding: 10px;
            text-align: center;
        }
        .stat-val { font-size: 26px; font-weight: 800; color: #fff; }
        .stat-name { font-size: 10px; color: var(--color-text-dim); font-weight: 700; text-transform: uppercase; }

        /* Equipment */
        .equip-row {
            padding: 15px;
            border-top: 1px solid var(--color-border);
            display: flex;
            gap: 10px;
            background: rgba(0,0,0,0.2);
        }
        .equip-box {
            flex: 1;
            aspect-ratio: 1;
            background: rgba(255,255,255,0.02);
            border: 1px solid var(--color-border);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #475569;
        }
        .equip-box.equipped {
            color: white;
            border-color: var(--color-highlight);
            box-shadow: inset 0 0 15px rgba(59, 130, 246, 0.2);
        }

        /* Main Viewport */
        .viewport-container {
            flex-grow: 1;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        .story-text-container { text-align: center; max-width: 90%; }
        .story-title { font-size: 70px; font-weight: 900; line-height: 1; text-transform: uppercase; margin-bottom: 20px; }
        .story-desc { font-size: 16px; color: var(--color-highlight); border: 1px solid var(--color-highlight); padding: 5px 20px; border-radius: 20px; background: rgba(59, 130, 246, 0.1); }

        .enemy-container { text-align: center; display: none; }
        .enemy-container.active { display: block; }
        .enemy-icon { font-size: 160px; filter: drop-shadow(0 0 40px rgba(239, 68, 68, 0.6)); }

        /* Action Area */
        .action-area {
            height: 220px;
            border-top: 1px solid var(--color-border);
            padding: 15px;
            display: grid;
            grid-template-columns: 1fr 180px;
            gap: 15px;
            background: rgba(0,0,0,0.2);
        }

        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 6px;
            align-content: flex-start;
        }
        .inv-item {
            aspect-ratio: 1;
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--color-border);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .inv-item:hover {
            border-color: var(--color-highlight);
            transform: scale(1.1);
            background: rgba(59, 130, 246, 0.1);
        }

        .btn-launch {
            width: 100%;
            height: 60px;
            background: linear-gradient(180deg, #3b82f6, #1d4ed8);
            border: 1px solid #60a5fa;
            border-radius: 8px;
            color: white;
            font-size: 22px;
            font-weight: 800;
            text-transform: uppercase;
            cursor: pointer;
            transition: 0.1s;
            box-shadow: 0 4px 0 #1e40af;
        }
        .btn-launch:active { transform: translateY(4px); box-shadow: none; }
        .btn-launch:disabled { filter: grayscale(100%); opacity: 0.5; cursor: not-allowed; }

        .control-btn {
            flex: 1;
            background: transparent;
            border: 1px solid var(--color-border);
            color: var(--color-text-dim);
            font-size: 10px;
            font-weight: bold;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            text-transform: uppercase;
        }
        .control-btn.active {
            border-color: var(--color-highlight);
            color: white;
            background: rgba(59, 130, 246, 0.1);
        }

        /* Logs */
        .logs-wrapper {
            flex-grow: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column-reverse;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #94a3b8;
        }
        .log-item { border-bottom: 1px solid rgba(255,255,255,0.05); margin-bottom: 4px; padding-bottom: 2px; }

        /* Modals */
        .modal-wrapper {
            position: fixed;
            inset: 0;
            background-color: var(--color-background);
            z-index: 9000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0,0,0,0.9);
            z-index: 9500;
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        .avatar-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 40px; }
        .avatar-card { font-size: 70px; padding: 30px; background: rgba(255,255,255,0.05); border: 2px solid var(--color-border); border-radius: 16px; cursor: pointer; transition: 0.2s; }
        .avatar-card:hover { border-color: var(--color-highlight); transform: scale(1.1); }

        .hub-box { width: 400px; padding: 40px; background: #0f172a; border: 1px solid var(--color-highlight); border-radius: 12px; text-align: center; }

        .hidden { display: none !important; }
        .text-gold { color: var(--color-gold); }
        .text-purple { color: var(--color-accent); }

    </style>
</head>
<body>

    <div id="laser-overlay" class="laser-effect"></div>

    <div id="screen-selection" class="modal-wrapper">
        <h1 class="text-4xl font-black text-white mb-12 tracking-widest uppercase">S√©lection Pilote</h1>
        <div class="avatar-grid">
            <button class="avatar-card" onclick="GameEngine.selectCharacter('üêô')">üêô</button>
            <button class="avatar-card" onclick="GameEngine.selectCharacter('üêπ')">üêπ</button>
            <button class="avatar-card" onclick="GameEngine.selectCharacter('ü¶ä')">ü¶ä</button>
            <button class="avatar-card" onclick="GameEngine.selectCharacter('ü¶å')">ü¶å</button>
            <button class="avatar-card" onclick="GameEngine.selectCharacter('üêï')">üêï</button>
            <button class="avatar-card" onclick="GameEngine.selectCharacter('üê±')">üê±</button>
        </div>
        <button onclick="SaveSystem.wipe()" class="text-xs text-red-500 uppercase border-b border-transparent hover:border-red-500">R√©initialiser les donn√©es</button>
    </div>

    <div id="screen-game" class="main-grid blur-active">
        
        <div class="panel">
            <div class="panel-header">
                <span>PILOTE</span>
                <span id="ui-name" class="text-blue-400 font-bold">COMMANDANT</span>
            </div>
            
            <div class="avatar-zone">
                <div class="absolute top-4 right-4 text-right">
                    <div class="text-[10px] text-gray-500 font-bold uppercase">Niveau</div>
                    <div id="ui-level" class="text-3xl font-black text-white">1</div>
                </div>
                <div id="ui-avatar" class="avatar-display effect-breathe">?</div>
            </div>

            <div class="stats-wrapper">
                <div class="hp-container mb-6">
                    <div class="hp-text-row">
                        <span>STRUCTURE</span>
                        <span id="ui-hp-text">100/100</span>
                    </div>
                    <div class="hp-bar-track">
                        <div id="ui-hp-fill" class="hp-bar-fill"></div>
                    </div>
                </div>

                <div class="attributes-grid">
                    <div class="stat-card">
                        <div class="stat-name">PUISSANCE</div>
                        <div id="ui-atk" class="stat-val text-blue-400">10</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-name">BLINDAGE</div>
                        <div id="ui-def" class="stat-val text-blue-400">0</div>
                    </div>
                </div>
            </div>

            <div class="equip-row">
                <div id="slot-weapon" class="equip-box">‚öîÔ∏è</div>
                <div id="slot-head" class="equip-box">üõ°Ô∏è</div>
                <div id="slot-pet" class="equip-box">üêæ</div>
            </div>
        </div>

        <div class="panel" id="center-viewport">
            <div class="panel-header">
                <span>ZONE <span id="ui-zone">1-1</span></span>
                <div class="flex gap-4">
                    <span class="text-gold font-bold">ü™ô <span id="ui-gold">0</span></span>
                    <span class="text-purple font-bold">‚ú® <span id="ui-gems">0</span></span>
                </div>
            </div>

            <div class="viewport-container">
                <div id="view-mission" class="mission-screen">
                    <div class="mission-big-text">MISSION</div>
                    <div class="mission-story-box">
                        <div id="ui-story-text" class="story-desc">PR√äT AU D√âCOLLAGE</div>
                    </div>
                </div>

                <div id="view-combat" class="enemy-container">
                    <div id="ui-enemy-icon" class="enemy-icon">üëæ</div>
                    <div class="mt-4 bg-red-900/30 border border-red-500 text-red-400 px-4 py-1 rounded font-bold uppercase inline-block">Cible D√©tect√©e</div>
                </div>
            </div>

            <div class="action-area">
                <div class="flex flex-col">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-[10px] font-bold text-gray-500 uppercase">SOUTE</span>
                        <button onclick="GameEngine.openChest()" class="bg-purple-600 hover:bg-purple-500 text-white text-[10px] font-bold px-3 py-1 rounded">COFFRE (5‚ú®)</button>
                    </div>
                    <div id="ui-inventory" class="inventory-grid"></div>
                </div>

                <div class="flex flex-col justify-end gap-2">
                    <button id="btn-launcher" onclick="GameEngine.handleMainClick()" class="btn-launch">
                        LANCER
                    </button>
                    <div class="flex gap-2">
                        <button id="btn-auto" onclick="AutoPilot.toggle()" class="control-btn">AUTO: OFF</button>
                        <button id="btn-speed" onclick="GameEngine.toggleSpeed()" class="control-toggle control-btn">VIT: x1</button>
                        <button onclick="UIManager.openSettings()" class="control-btn" style="flex: 0.3;">‚öôÔ∏è</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="panel">
            <div class="panel-header"><span>TERMINAL</span></div>
            <div id="ui-logs" class="logs-wrapper">
                <div class="log-item">> Syst√®me initialis√©.</div>
            </div>
            <div class="flex border-t border-gray-700">
                <button class="flex-1 p-3 text-xs font-bold text-white border-b-2 border-blue-500 bg-white/5">AVENTURE</button>
                <button onclick="UIManager.openHub()" class="flex-1 p-3 text-xs font-bold text-gray-500 hover:text-white transition">BASE</button>
            </div>
        </div>
    </div>

    <div id="modal-hub" class="modal-wrapper hidden" style="background-color: rgba(2, 5, 14, 0.95);">
        <h2 class="text-4xl font-bold text-white mb-10 italic uppercase">Centre d'Am√©lioration</h2>
        <div class="grid grid-cols-1 gap-6 w-80">
            <div onclick="GameEngine.upgradeStat('hp')" class="bg-white/5 border border-blue-900 p-4 rounded hover:border-blue-500 cursor-pointer flex justify-between items-center transition">
                <div><div class="text-xs text-gray-500 font-bold uppercase">Structure</div><div class="text-xl font-bold text-white">+20 PV</div></div>
                <div id="cost-hp" class="text-gold font-bold">100 ü™ô</div>
            </div>
            <div onclick="GameEngine.upgradeStat('atk')" class="bg-white/5 border-blue-900 p-4 rounded hover:border-blue-500 cursor-pointer flex justify-between items-center transition">
                <div><div class="text-xs text-gray-500 font-bold uppercase">Armement</div><div class="text-xl font-bold text-white">+5 ATK</div></div>
                <div id="cost-atk" class="text-gold font-bold">100 ü™ô</div>
            </div>
            <div onclick="GameEngine.upgradeStat('def')" class="bg-white/5 border-blue-900 p-4 rounded hover:border-blue-500 cursor-pointer flex justify-between items-center transition">
                <div><div class="text-xs text-gray-500 font-bold uppercase">Boucliers</div><div class="text-xl font-bold text-white">+2 DEF</div></div>
                <div id="cost-def" class="text-gold font-bold">100 ü™ô</div>
            </div>
        </div>
        <button onclick="UIManager.closeHub()" class="mt-12 text-blue-500 font-bold uppercase hover:text-white border-b border-transparent hover:border-white transition">Retour Mission</button>
    </div>

    <div id="modal-settings" class="modal-overlay">
        <div class="hub-box">
            <h2 class="text-2xl font-bold text-white mb-8">PARAM√àTRES SYST√àME</h2>
            <button onclick="SaveSystem.wipe()" class="w-full py-4 bg-red-900/50 border border-red-500 rounded text-white font-bold hover:bg-red-900 mb-4 transition">
                R√âINITIALISATION D'USINE
            </button>
            <button onclick="UIManager.closeSettings()" class="w-full py-4 bg-slate-800 rounded text-white font-bold hover:bg-slate-700 transition">
                RETOUR
            </button>
        </div>
    </div>

    <script>
        
        /* ==========================================================================
           1. DONN√âES DU JEU (BASE DE DONN√âES)
           ========================================================================== */
        const Database = {
            enemies: [
                { name: "Drone", icon: "üõ∏", hp: 50, atk: 5 },
                { name: "Xeno", icon: "üëæ", hp: 80, atk: 8 },
                { name: "Sonde", icon: "üõ∞Ô∏è", hp: 40, atk: 12 },
                { name: "Blob", icon: "ü¶†", hp: 100, atk: 4 }
            ],
            items: [
                { name: "Lame", icon: "‚öîÔ∏è", type: "weapon", stat: 10 },
                { name: "Casque", icon: "üõ°Ô∏è", type: "head", stat: 20 },
                { name: "Bot", icon: "ü§ñ", type: "pet", stat: 5 }
            ],
            stories: [
                "Signal radio inconnu capt√©.", "D√©bris d'un ancien vaisseau.", "Pluie de m√©t√©orites mineure.", 
                "Zone de radiation d√©tect√©e.", "Transmission crypt√©e re√ßue.", "Ravitaillement automatique."
            ]
        };

        /* ==========================================================================
           2. SYST√àME DE SAUVEGARDE
           ========================================================================== */
        const SaveSystem = {
            key: 'distory_save_v60',
            
            save: function(data) {
                localStorage.setItem(this.key, JSON.stringify(data));
            },

            load: function() {
                const data = localStorage.getItem(this.key);
                return data ? JSON.parse(data) : null;
            },

            wipe: function() {
                if (confirm("ATTENTION : Effacement total des donn√©es ?")) {
                    localStorage.removeItem(this.key);
                    location.reload();
                }
            }
        };

        /* ==========================================================================
           3. √âTAT DU JEU (STATE)
           ========================================================================== */
        let Player = {
            avatar: null,
            gold: 0,
            gems: 20,
            stats: { hp: 0, atk: 0, def: 0 },
            inventory: [],
            equipment: { weapon: null, head: null, pet: null }
        };

        let GameState = {
            status: "IDLE", // IDLE, SCANNING, COMBAT
            day: 0,
            currentHp: 100,
            maxHp: 100,
            atk: 10,
            def: 0,
            speedMultiplier: 1,
            
            // Combat Info
            enemyCurrentHp: 0,
            enemyMaxHp: 0,
            enemyAtk: 0
        };

        /* ==========================================================================
           4. MOTEUR DE JEU (LOGIC)
           ========================================================================== */
        const GameEngine = {
            
            // --- INITIALISATION ---
            init: function() {
                const loaded = SaveSystem.load();
                if (loaded) {
                    Player = loaded;
                    if (Player.avatar) {
                        UIManager.showGameScreen();
                        this.recalcStats();
                        UIManager.refreshAll();
                    }
                }
            },

            selectCharacter: function(emoji) {
                Player.avatar = emoji;
                SaveSystem.save(Player);
                UIManager.showGameScreen();
                UIManager.refreshAll();
            },

            // --- ACTION PRINCIPALE ---
            handleMainClick: function() {
                if (GameState.status !== "IDLE") return;
                this.startCycle();
            },

            startCycle: function() {
                // Initialisation premier jour si besoin
                if (GameState.day === 0) {
                    GameState.day = 1;
                    UIManager.log("Mission d√©marr√©e.");
                }

                GameState.status = "SCANNING";
                UIManager.playScanAnimation(() => {
                    this.executeCycleResult();
                });
            },

            executeCycleResult: function() {
                GameState.day++;
                this.recalcStats();

                // 25% Chance de combat tous les jours
                if (GameState.day % 4 === 0 || Math.random() < 0.2) {
                    this.startCombat();
                } else {
                    // √âv√©nement narratif + Loot
                    const story = Database.stories[Math.floor(Math.random() * Database.stories.length)];
                    const gold = 20 + Math.floor(Math.random() * 20);
                    Player.gold += gold;
                    
                    UIManager.updateStory(story);
                    UIManager.log(`> ${story}`);
                    UIManager.log(`> Gain: +${gold} Or.`);
                    
                    this.endCycle();
                }
            },

            endCycle: function() {
                UIManager.refreshAll();
                SaveSystem.save(Player);
                GameState.status = "IDLE";
                AutoPilot.checkResume();
            },

            // --- COMBAT ---
            startCombat: function() {
                GameState.status = "COMBAT";
                
                // G√©n√©ration ennemi
                const template = Database.enemies[Math.floor(Math.random() * Database.enemies.length)];
                const scaling = 1 + (GameState.day * 0.1);
                
                GameState.enemyMaxHp = Math.floor(template.hp * scaling);
                GameState.enemyCurrentHp = GameState.enemyMaxHp;
                GameState.enemyAtk = Math.floor(template.atk * (1 + GameState.day * 0.05));
                
                UIManager.showCombatScreen(template.icon);
                UIManager.log(`! ALERTE : ${template.name} !`);
                
                // Lancer le premier tour
                setTimeout(() => this.combatRound(), 1000 / GameState.speedMultiplier);
            },

            combatRound: function() {
                if (GameState.status !== "COMBAT") return;

                // 1. Joueur attaque
                UIManager.animAttack();
                GameState.enemyCurrentHp -= GameState.atk;
                UIManager.shakeEnemy();

                if (GameState.enemyCurrentHp <= 0) {
                    this.winCombat();
                    return;
                }

                // 2. Ennemi attaque (D√©lai)
                setTimeout(() => {
                    const dmg = Math.max(1, GameState.enemyAtk - GameState.def);
                    GameState.currentHp -= dmg;
                    
                    UIManager.shakeScreen();
                    UIManager.refreshAll(); // Update barre de vie

                    if (GameState.currentHp <= 0) {
                        this.loseCombat();
                    } else {
                        // Tour suivant
                        setTimeout(() => this.combatRound(), 800 / GameState.speedMultiplier);
                    }
                }, 500 / GameState.speedMultiplier);
            },

            winCombat: function() {
                const reward = 50 + (GameState.day * 2);
                Player.gold += reward;
                UIManager.log(`> Cible d√©truite (+${reward} Or).`);
                UIManager.showMissionScreen();
                this.endCycle();
            },

            loseCombat: function() {
                GameState.status = "IDLE";
                GameState.day = 0; // Reset jour (Optionnel)
                GameState.currentHp = 0;
                AutoPilot.stop();
                UIManager.log("!!! √âCHEC MISSION !!!");
                UIManager.showMissionScreen();
                UIManager.refreshAll();
                SaveSystem.save(Player);
            },

            // --- GESTION ITEMS ---
            openChest: function() {
                if (Player.gems >= 5) {
                    Player.gems -= 5;
                    const itemTpl = Database.items[Math.floor(Math.random() * Database.items.length)];
                    // Cr√©ation instance unique
                    const newItem = { ...itemTpl, uid: Date.now() };
                    Player.inventory.push(newItem);
                    
                    UIManager.log(`> Trouv√©: ${newItem.name}`);
                    this.checkFusion();
                    UIManager.refreshAll();
                    SaveSystem.save(Player);
                } else {
                    UIManager.log("> Pas assez de mati√®re (5‚ú®).");
                }
            },

            checkFusion: function() {
                const counts = {};
                Player.inventory.forEach(i => counts[i.name] = (counts[i.name] || 0) + 1);

                for (const name in counts) {
                    if (counts[name] >= 3) {
                        const base = Player.inventory.find(i => i.name === name);
                        // Retirer 3
                        let removed = 0;
                        Player.inventory = Player.inventory.filter(i => {
                            if (i.name === name && removed < 3) { removed++; return false; }
                            return true;
                        });
                        // Ajouter am√©lior√©
                        const upg = { ...base, stat: Math.floor(base.stat * 2.2), name: base.name + "+", uid: Date.now() };
                        Player.inventory.push(upg);
                        
                        UIManager.log(`*** FUSION : ${base.name} -> ${upg.name} ***`);
                        // V√©rifier r√©cursivement (si on en avait 9, √ßa fait 3, puis 1)
                        this.checkFusion();
                        return;
                    }
                }
            },

            equipItem: function(uid) {
                const idx = Player.inventory.findIndex(i => i.uid === uid);
                if (idx > -1) {
                    const item = Player.inventory[idx];
                    // Echange si slot occup√©
                    if (Player.equipment[item.type]) {
                        Player.inventory.push(Player.equipment[item.type]);
                    }
                    Player.equipment[item.type] = item;
                    Player.inventory.splice(idx, 1);
                    
                    this.recalcStats();
                    UIManager.refreshAll();
                    SaveSystem.save(Player);
                }
            },

            upgradeStat: function(type) {
                const cost = 100 + (Player.stats[type] * 50);
                if (Player.gold >= cost) {
                    Player.gold -= cost;
                    Player.stats[type]++;
                    this.recalcStats();
                    UIManager.refreshAll();
                    SaveSystem.save(Player);
                }
            },

            recalcStats: function() {
                // Base
                let mHp = 100 + (Player.stats.hp * 20);
                let mAtk = 10 + (Player.stats.atk * 5);
                let mDef = 0 + (Player.stats.def * 2);

                // Equipement
                if (Player.equipment.weapon) mAtk += Player.equipment.weapon.stat;
                if (Player.equipment.head) mHp += Player.equipment.head.stat;
                if (Player.equipment.pet) mAtk += Player.equipment.pet.stat;

                GameState.maxHp = mHp;
                GameState.atk = mAtk;
                GameState.def = mDef;

                // Soin passif si non combat
                if (GameState.status === "IDLE") {
                    if (GameState.currentHp < GameState.maxHp) GameState.currentHp = Math.min(GameState.currentHp + 10, GameState.maxHp);
                }
            },

            toggleSpeed: function() {
                GameState.speedMultiplier = (GameState.speedMultiplier === 1) ? 2 : 1;
                UIManager.refreshAll();
            }
        };

        /* ==========================================================================
           5. GESTION DU MODE AUTO (AUTOPILOT)
           ========================================================================== */
        const AutoPilot = {
            isActive: false,
            timer: null,

            toggle: function() {
                this.isActive = !this.isActive;
                UIManager.refreshAll();
                if (this.isActive) this.checkResume();
                else clearTimeout(this.timer);
            },

            stop: function() {
                this.isActive = false;
                clearTimeout(this.timer);
                UIManager.refreshAll();
            },

            checkResume: function() {
                if (this.isActive && GameState.status === "IDLE" && GameState.currentHp > 0) {
                    this.timer = setTimeout(() => {
                        GameEngine.triggerCycle();
                    }, 1000 / GameState.speedMultiplier);
                }
            }
        };

        /* ==========================================================================
           6. GESTION DE L'INTERFACE (UI MANAGER)
           ========================================================================== */
        const UIManager = {
            
            showGameScreen: function() {
                document.getElementById('boot-screen').classList.add('hidden');
                document.getElementById('game-interface').classList.remove('blur-active');
            },

            refreshAll: function() {
                // Headers
                document.getElementById('ui-gold').innerText = Player.gold;
                document.getElementById('ui-gems').innerText = Player.gems;
                document.getElementById('ui-zone').innerText = `1-${GameState.day}`;
                
                // Avatar
                document.getElementById('ui-avatar-display').innerText = Player.avatar;
                document.getElementById('ui-level').innerText = Math.floor(GameState.day / 10) + 1;

                // Barres de vie
                document.getElementById('ui-hp-text').innerText = `${Math.floor(GameState.currentHp)}/${GameState.maxHp}`;
                const hpPct = Math.max(0, (GameState.currentHp / GameState.maxHp) * 100);
                document.getElementById('ui-hp-fill').style.width = `${hpPct}%`;

                // Stats
                document.getElementById('ui-atk').innerText = GameState.atk;
                document.getElementById('ui-def').innerText = GameState.def;

                // Boutons
                const btnMain = document.getElementById('btn-launcher');
                const btnAuto = document.getElementById('btn-auto');
                const btnSpeed = document.getElementById('btn-speed');

                if (GameState.status !== "IDLE") {
                    btnMain.innerText = GameState.status === "COMBAT" ? "COMBAT..." : "EN COURS...";
                    btnMain.disabled = true;
                } else {
                    btnMain.innerText = "LANCER";
                    btnMain.disabled = false;
                }

                btnAuto.innerText = AutoPilot.isActive ? "AUTO: ON" : "AUTO: OFF";
                btnAuto.classList.toggle('active', AutoPilot.isActive);

                btnSpeed.innerText = `VIT: x${GameState.speedMultiplier}`;

                // Inventaire
                const grid = document.getElementById('ui-inventory');
                grid.innerHTML = '';
                Player.inventory.forEach(item => {
                    const el = document.createElement('div');
                    el.className = 'inv-item';
                    el.innerText = item.icon;
                    el.onclick = () => GameEngine.equipItem(item.uid);
                    grid.appendChild(el);
                });

                // √âquipement
                const setEq = (id, item, defIcon) => {
                    const el = document.getElementById(id);
                    if (item) {
                        el.innerText = item.icon;
                        el.classList.add('equipped');
                    } else {
                        el.innerText = defIcon;
                        el.classList.remove('equipped');
                    }
                };
                setEq('slot-weapon', Player.equipment.weapon, "‚öîÔ∏è");
                setEq('slot-head', Player.equipment.head, "üõ°Ô∏è");
                setEq('slot-pet', Player.equipment.pet, "üêæ");

                // Co√ªts upgrades
                ['hp','atk','def'].forEach(k => {
                    document.getElementById(`cost-${k}`).innerText = (100 + Player.stats[k]*50) + " ü™ô";
                });
            },

            // --- ANIMATIONS VISUELLES ---
            playScanAnimation: function(callback) {
                const laser = document.getElementById('laser-overlay');
                laser.style.display = 'block';
                // Force Reflow pour red√©marrer l'anim
                void laser.offsetWidth;
                laser.style.animation = 'none';
                void laser.offsetWidth;
                laser.style.animation = 'animation-scan 0.8s linear forwards';

                setTimeout(() => {
                    laser.style.display = 'none';
                    if (callback) callback();
                }, 800 / GameState.speedMultiplier);
            },

            animAttack: function() {
                const el = document.getElementById('ui-avatar-display');
                el.classList.remove('anim-breathe');
                el.classList.add('effect-attack');
                setTimeout(() => {
                    el.classList.remove('effect-attack');
                    el.classList.add('anim-breathe');
                }, 300);
            },

            shakeEnemy: function() {
                const el = document.getElementById('ui-enemy-icon');
                el.classList.add('effect-shake-target');
                setTimeout(() => el.classList.remove('effect-shake-target'), 400);
            },

            shakeScreen: function() {
                const el = document.getElementById('center-viewport');
                el.classList.add('effect-shake-screen');
                setTimeout(() => el.classList.remove('effect-shake-screen'), 500);
            },

            // --- VUES ---
            showCombatScreen: function(icon) {
                document.getElementById('view-mission').classList.add('hidden');
                document.getElementById('view-combat').classList.add('active');
                document.getElementById('ui-enemy-icon').innerText = icon;
            },

            showMissionScreen: function() {
                document.getElementById('view-combat').classList.remove('active');
                document.getElementById('view-mission').classList.remove('hidden');
            },

            updateStory: function(text) {
                document.getElementById('ui-story-text').innerText = text;
            },

            log: function(msg) {
                const container = document.getElementById('ui-logs');
                const div = document.createElement('div');
                div.className = 'log-item';
                div.innerText = `> ${msg}`;
                container.prepend(div);
                if (container.children.length > 50) container.lastChild.remove();
            },

            // --- MODALS ---
            openHub: () => document.getElementById('modal-hub').classList.remove('hidden'),
            closeHub: () => document.getElementById('modal-hub').classList.add('hidden'),
            openSettings: () => document.getElementById('modal-settings').style.display = 'flex',
            closeSettings: () => document.getElementById('modal-settings').style.display = 'none'
        };

        // Lancement au chargement
        window.onload = GameEngine.init;

    </script>
</body>
</html>
