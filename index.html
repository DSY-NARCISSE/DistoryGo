<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Distory Go - V56 UNLIMITED</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* === CONFIGURATION GRAPHIQUE GLOBALE === */
        :root {
            --bg-dark: #02050e;
            --panel-bg: rgba(10, 15, 30, 0.95);
            --border-color: #1e293b;
            --highlight-blue: #3b82f6;
            --highlight-purple: #8b5cf6;
            --text-main: #94a3b8;
            --text-light: #f8fafc;
            --hp-red: #be123c;
            --gold: #fbbf24;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-light);
            font-family: 'Rajdhani', sans-serif;
            height: 100vh;
            overflow: hidden;
            user-select: none;
            background-image: radial-gradient(circle at 50% 50%, #0f172a 0%, #02050e 100%);
        }

        /* === ANIMATIONS (KEYFRAMES) === */
        @keyframes scanline-move {
            0% { top: -5%; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: 105%; opacity: 0; }
        }

        @keyframes hero-float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }

        @keyframes attack-lunge {
            0% { transform: translateX(0); }
            50% { transform: translateX(80px) scale(1.1); }
            100% { transform: translateX(0); }
        }

        @keyframes hit-shake {
            0% { transform: translate(0, 0); filter: brightness(1); }
            20% { transform: translate(-5px, 5px); filter: brightness(2) sepia(1) hue-rotate(-50deg) saturate(5); }
            40% { transform: translate(5px, -5px); }
            60% { transform: translate(-5px, 5px); }
            80% { transform: translate(5px, -5px); }
            100% { transform: translate(0, 0); filter: brightness(1); }
        }

        @keyframes loot-pop {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* === CLASSES UTILITAIRES ANIMATIONS === */
        .anim-scanning {
            position: absolute;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--highlight-blue);
            box-shadow: 0 0 20px var(--highlight-blue);
            z-index: 50;
            pointer-events: none;
            animation: scanline-move 0.8s linear forwards;
        }

        .anim-floating {
            animation: hero-float 4s ease-in-out infinite;
        }

        .anim-attacking {
            animation: attack-lunge 0.3s ease-in-out forwards;
        }

        .anim-hit {
            animation: hit-shake 0.4s cubic-bezier(.36,.07,.19,.97) both;
        }

        /* === LAYOUT & PANNEAUX === */
        .main-layout {
            display: grid;
            grid-template-columns: 350px 1fr 320px;
            gap: 16px;
            height: 100vh;
            padding: 16px;
            transition: filter 0.3s ease;
        }

        .game-panel {
            background-color: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        .panel-header {
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.03);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            font-weight: 700;
            letter-spacing: 1px;
            color: var(--highlight-blue);
            text-transform: uppercase;
        }

        /* === GAUCHE : PILOTE === */
        .bio-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            padding: 20px;
        }

        .hero-avatar {
            font-size: 140px;
            filter: drop-shadow(0 0 30px rgba(59, 130, 246, 0.4));
            transition: transform 0.2s;
        }

        .level-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            text-align: right;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            padding: 0 20px 20px 20px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 10px;
            text-align: center;
        }

        .stat-title { font-size: 10px; color: var(--text-main); font-weight: 700; text-transform: uppercase; }
        .stat-value { font-size: 24px; font-weight: 700; color: white; }

        .hp-bar-container {
            width: 100%;
            padding: 0 20px 10px 20px;
        }
        
        .hp-track {
            width: 100%;
            height: 8px;
            background: #000;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            overflow: hidden;
        }

        .hp-fill {
            height: 100%;
            background: linear-gradient(90deg, #9f1239, #e11d48);
            width: 100%;
            transition: width 0.3s ease-out;
        }

        .equipment-slots {
            display: flex;
            gap: 10px;
            padding: 20px;
            background: rgba(0,0,0,0.3);
            border-top: 1px solid var(--border-color);
        }

        /* === CENTRE : MISSION === */
        .mission-display {
            flex-grow: 1;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .mission-title {
            font-size: 80px;
            font-weight: 900;
            color: white;
            text-transform: uppercase;
            letter-spacing: -2px;
            text-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        .mission-subtitle {
            font-size: 14px;
            color: var(--highlight-blue);
            border: 1px solid var(--highlight-blue);
            padding: 4px 20px;
            border-radius: 20px;
            margin-top: 10px;
            background: rgba(59, 130, 246, 0.1);
        }

        .enemy-display {
            font-size: 160px;
            filter: drop-shadow(0 0 40px rgba(220, 38, 38, 0.6));
            transition: transform 0.1s;
        }

        .bottom-action-area {
            height: 200px;
            background: rgba(0,0,0,0.2);
            border-top: 1px solid var(--border-color);
            padding: 15px;
            display: grid;
            grid-template-columns: 1fr 200px;
            gap: 15px;
        }

        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            align-content: start;
        }

        .item-slot {
            aspect-ratio: 1;
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .item-slot:hover {
            border-color: var(--highlight-blue);
            transform: scale(1.05);
            background: rgba(59, 130, 246, 0.1);
        }

        .item-slot.equipped {
            border-color: var(--gold);
            box-shadow: inset 0 0 10px rgba(251, 191, 36, 0.2);
        }

        .main-btn {
            width: 100%;
            height: 70px;
            background: linear-gradient(to bottom, #3b82f6, #1d4ed8);
            border: 1px solid #60a5fa;
            border-radius: 8px;
            color: white;
            font-size: 24px;
            font-weight: 800;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.1s;
            box-shadow: 0 4px 0 #1e40af;
        }

        .main-btn:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 #1e40af;
        }

        .main-btn:disabled {
            filter: grayscale(100%);
            opacity: 0.5;
            cursor: not-allowed;
        }

        .controls-row {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }

        .control-toggle {
            font-size: 11px;
            font-weight: 700;
            color: var(--text-main);
            background: none;
            border: 1px solid var(--border-color);
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            text-transform: uppercase;
        }

        .control-toggle.active {
            color: var(--highlight-blue);
            border-color: var(--highlight-blue);
            background: rgba(59, 130, 246, 0.1);
        }

        /* === DROITE : JOURNAL === */
        .log-container {
            flex-grow: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column-reverse;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #94a3b8;
        }

        .log-entry {
            margin-bottom: 6px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            padding-bottom: 4px;
        }

        .nav-tabs {
            display: flex;
            height: 50px;
            border-top: 1px solid var(--border-color);
        }

        .nav-tab {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-main);
            font-weight: 700;
            font-size: 12px;
            text-transform: uppercase;
            cursor: pointer;
            transition: 0.3s;
        }

        .nav-tab:hover { color: white; }
        .nav-tab.active {
            color: white;
            border-bottom: 3px solid var(--highlight-blue);
            background: rgba(255,255,255,0.02);
        }

        /* === MODALS & OVERLAYS === */
        .modal-fullscreen {
            position: fixed;
            inset: 0;
            background-color: var(--bg-dark);
            z-index: 5000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .avatar-selection-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 40px;
        }

        .avatar-option {
            font-size: 60px;
            padding: 30px;
            background: rgba(255,255,255,0.05);
            border: 2px solid var(--border-color);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .avatar-option:hover {
            transform: scale(1.1);
            border-color: var(--highlight-blue);
            background: rgba(59, 130, 246, 0.1);
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            z-index: 6000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .modal-box {
            background: #0f172a;
            border: 1px solid var(--highlight-blue);
            padding: 40px;
            border-radius: 12px;
            text-align: center;
            width: 400px;
            max-width: 90%;
        }

        /* UTILS */
        .hidden { display: none !important; }
        .text-gold { color: var(--gold); }
        .text-purple { color: var(--highlight-purple); }
        
    </style>
</head>
<body>

    <div id="laser-layer"></div>

    <div id="boot-screen" class="modal-fullscreen">
        <h1 class="text-4xl font-bold text-white mb-12 tracking-widest text-center">INITIALISATION DU PILOTE</h1>
        
        <div class="avatar-selection-grid">
            <button class="avatar-option" onclick="Game.selectAvatar('üêô')">üêô</button>
            <button class="avatar-option" onclick="Game.selectAvatar('üêπ')">üêπ</button>
            <button class="avatar-option" onclick="Game.selectAvatar('ü¶ä')">ü¶ä</button>
            <button class="avatar-option" onclick="Game.selectAvatar('ü¶å')">ü¶å</button>
            <button class="avatar-option" onclick="Game.selectAvatar('üêï')">üêï</button>
            <button class="avatar-option" onclick="Game.selectAvatar('üê±')">üê±</button>
        </div>

        <button onclick="Game.hardReset()" class="text-xs text-gray-500 uppercase hover:text-red-500 transition border-b border-transparent hover:border-red-500">
            Effacer les donn√©es locales
        </button>
    </div>

    <div id="game-interface" class="main-layout blur">
        
        <div class="game-panel">
            <div class="panel-header">
                <span>PILOTE</span>
                <span id="ui-pseudo" class="text-blue-400">COMMANDANT</span>
            </div>

            <div class="bio-container">
                <div class="level-badge">
                    <span class="text-[10px] text-gray-500 uppercase font-bold">Niveau</span>
                    <span id="ui-level" class="block text-3xl font-bold text-white">1</span>
                </div>
                <div id="ui-avatar" class="hero-avatar anim-floating">?</div>
            </div>

            <div class="hp-bar-container">
                <div class="flex justify-between text-[10px] font-bold text-gray-400 mb-1 uppercase">
                    <span>Int√©grit√© Structurelle</span>
                    <span id="ui-hp-text">100/100</span>
                </div>
                <div class="hp-track">
                    <div id="ui-hp-fill" class="hp-fill"></div>
                </div>
            </div>

            <div class="stat-grid">
                <div class="stat-card">
                    <div class="stat-title">PUISSANCE</div>
                    <div id="ui-atk" class="stat-value text-blue-400">10</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">BLINDAGE</div>
                    <div id="ui-def" class="stat-value text-blue-400">0</div>
                </div>
            </div>

            <div class="equipment-slots">
                <div id="slot-weapon" class="item-slot" style="flex:1;">‚öîÔ∏è</div>
                <div id="slot-head" class="item-slot" style="flex:1;">üõ°Ô∏è</div>
                <div id="slot-pet" class="item-slot" style="flex:1;">üêæ</div>
            </div>
        </div>

        <div class="game-panel">
            <div class="panel-header">
                <span>ZONE <span id="ui-zone">1-1</span></span>
                <div class="flex gap-4">
                    <span class="text-gold font-bold">ü™ô <span id="ui-gold">0</span></span>
                    <span class="text-purple font-bold">‚ú® <span id="ui-gems">0</span></span>
                </div>
            </div>

            <div class="mission-display" id="mission-viewport">
                <div id="view-mission" class="text-center">
                    <div class="mission-title">MISSION</div>
                    <div class="mission-subtitle">SECTEUR D'EXPLORATION</div>
                </div>
                
                <div id="view-combat" class="text-center hidden">
                    <div id="enemy-sprite" class="enemy-display">üëæ</div>
                    <div class="mt-4 inline-block bg-red-900/50 border border-red-500 px-4 py-1 rounded text-red-300 font-bold uppercase text-sm">
                        Cible D√©tect√©e
                    </div>
                </div>
            </div>

            <div class="bottom-action-area">
                <div class="flex flex-col h-full">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-[10px] font-bold text-gray-500 uppercase">SOUTE MAT√âRIEL</span>
                        <button onclick="Game.openChest()" class="bg-purple-600 hover:bg-purple-500 text-white text-[10px] font-bold px-2 py-1 rounded transition">
                            COFFRE (5‚ú®)
                        </button>
                    </div>
                    <div id="inventory-grid" class="inventory-grid">
                        </div>
                </div>

                <div class="flex flex-col justify-end">
                    <button id="btn-action" onclick="Game.triggerAction()" class="main-btn">
                        LANCER
                    </button>
                    
                    <div class="controls-row">
                        <button id="btn-auto" onclick="Game.toggleAuto()" class="control-toggle">AUTO: OFF</button>
                        <button id="btn-speed" onclick="Game.toggleSpeed()" class="control-toggle">VIT: x1</button>
                        <button onclick="UI.openSettings()" class="control-toggle">‚öôÔ∏è</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="game-panel">
            <div class="panel-header">
                <span>TERMINAL</span>
            </div>

            <div id="log-container" class="log-container">
                <div class="log-entry">> Syst√®me initialis√©.</div>
            </div>

            <div class="nav-tabs">
                <button class="nav-tab active" onclick="UI.switchTab('logs')">JOURNAL</button>
                <button class="nav-tab" onclick="UI.switchTab('hub')">BASE</button>
            </div>
        </div>
    </div>

    <div id="hub-overlay" class="modal-fullscreen hidden">
        <h2 class="text-4xl font-bold text-white mb-10 italic">AM√âLIORATION DE LA BASE</h2>
        
        <div class="grid grid-cols-1 gap-6 w-80">
            <div onclick="Game.upgradeStat('hp')" class="stat-card cursor-pointer hover:border-blue-500 transition p-6 flex justify-between items-center">
                <div class="text-left">
                    <div class="stat-title">INT√âGRIT√â</div>
                    <div class="text-xl font-bold text-white">+20 PV</div>
                </div>
                <div id="cost-hp" class="text-gold font-bold">100 ü™ô</div>
            </div>

            <div onclick="Game.upgradeStat('atk')" class="stat-card cursor-pointer hover:border-blue-500 transition p-6 flex justify-between items-center">
                <div class="text-left">
                    <div class="stat-title">PUISSANCE</div>
                    <div class="text-xl font-bold text-white">+5 ATK</div>
                </div>
                <div id="cost-atk" class="text-gold font-bold">100 ü™ô</div>
            </div>

            <div onclick="Game.upgradeStat('def')" class="stat-card cursor-pointer hover:border-blue-500 transition p-6 flex justify-between items-center">
                <div class="text-left">
                    <div class="stat-title">BLINDAGE</div>
                    <div class="text-xl font-bold text-white">+2 DEF</div>
                </div>
                <div id="cost-def" class="text-gold font-bold">100 ü™ô</div>
            </div>
        </div>

        <button onclick="UI.closeHub()" class="mt-12 text-blue-400 font-bold uppercase hover:text-white transition tracking-widest border-b border-transparent hover:border-white">
            RETOUR AUX OP√âRATIONS
        </button>
    </div>

    <div id="settings-modal" class="modal-overlay">
        <div class="modal-box">
            <h2 class="text-2xl font-bold text-white mb-8">PARAM√àTRES</h2>
            <button onclick="Game.hardReset()" class="w-full py-3 bg-red-900/50 border border-red-500 text-red-200 rounded font-bold hover:bg-red-900 transition mb-4">
                R√âINITIALISATION D'USINE
            </button>
            <button onclick="UI.closeSettings()" class="w-full py-3 bg-slate-800 rounded text-white font-bold hover:bg-slate-700 transition">
                RETOUR
            </button>
        </div>
    </div>

    <script>
        // --- DONN√âES DU JEU ---
        const GameData = {
            enemies: [
                { name: "Drone Pirate", icon: "üõ∏", hp: 50, atk: 5 },
                { name: "X√©no-Morphe", icon: "üëæ", hp: 80, atk: 8 },
                { name: "Sonde Corrompue", icon: "üõ∞Ô∏è", hp: 40, atk: 12 }
            ],
            items: [
                { name: "Lame Laser", icon: "‚öîÔ∏è", type: "weapon", stat: 10 },
                { name: "Bouclier Plasma", icon: "üõ°Ô∏è", type: "head", stat: 20 },
                { name: "Drone Support", icon: "ü§ñ", type: "pet", stat: 5 }
            ]
        };

        // --- √âTAT DU JOUEUR ---
        let Player = {
            avatar: null,
            gold: 0,
            gems: 20,
            level: 1,
            baseStats: { hp: 0, atk: 0, def: 0 },
            inventory: [],
            equipment: { weapon: null, head: null, pet: null }
        };

        // --- √âTAT DE LA RUN ---
        let Run = {
            isActive: false,
            isProcessing: false,
            day: 0,
            currentHp: 100,
            maxHp: 100,
            atk: 10,
            def: 0,
            autoMode: false,
            speedMultiplier: 1 // 1 = normal (1000ms), 2 = rapide (500ms)
        };

        let Combat = {
            isActive: false,
            enemyHp: 0,
            enemyMaxHp: 0,
            enemyAtk: 0
        };

        // --- C≈íUR DU JEU (LOGIQUE) ---
        const Game = {
            // Initialisation
            init: () => {
                const save = localStorage.getItem('distory_save_v56');
                if (save) {
                    Player = JSON.parse(save);
                    if (Player.avatar) {
                        UI.hideBootScreen();
                        UI.updateAll();
                    }
                }
            },

            selectAvatar: (emoji) => {
                Player.avatar = emoji;
                Game.save();
                UI.hideBootScreen();
                UI.updateAll();
            },

            // Boucle principale d'action
            triggerAction: () => {
                if (Run.isProcessing || Combat.isActive) return;
                
                // Si c'est le tout premier lancement
                if (!Run.isActive) {
                    Run.isActive = true;
                    Run.day = 1;
                    UI.log("Mission initialis√©e. Syst√®mes pr√™ts.");
                }

                Run.isProcessing = true;
                UI.triggerScanEffect();

                // D√©lai simulant le scan
                setTimeout(() => {
                    Run.day++;
                    Game.calculateStats();
                    
                    // Logique de rencontre (1 chance sur 5 d'avoir un combat)
                    if (Run.day % 5 === 0) {
                        Game.startCombat();
                    } else {
                        // √âv√©nement pacifique
                        const goldFound = 20 + Math.floor(Math.random() * 20);
                        Player.gold += goldFound;
                        UI.log(`> Ressources trouv√©es (+${goldFound} Or)`);
                        UI.updateAll();
                        Game.endAction();
                    }
                }, 600 / Run.speedMultiplier); // Vitesse d√©pend du multiplicateur
            },

            endAction: () => {
                Run.isProcessing = false;
                if (Run.autoMode && Run.isActive && !Combat.isActive) {
                    setTimeout(Game.triggerAction, 800 / Run.speedMultiplier);
                }
            },

            // Syst√®me de Combat
            startCombat: () => {
                Combat.isActive = true;
                const enemyTemplate = GameData.enemies[Math.floor(Math.random() * GameData.enemies.length)];
                
                // Scaling des stats ennemies
                const scale = 1 + (Run.day * 0.1);
                Combat.enemyMaxHp = Math.floor(enemyTemplate.hp * scale);
                Combat.enemyHp = Combat.enemyMaxHp;
                Combat.enemyAtk = Math.floor(enemyTemplate.atk * scale);

                UI.showCombatView(enemyTemplate.icon);
                UI.log(`! ALERTE : ${enemyTemplate.name} d√©tect√© !`);

                setTimeout(Game.combatRound, 800 / Run.speedMultiplier);
            },

            combatRound: () => {
                if (!Combat.isActive) return;

                // Tour du Joueur
                UI.animPlayerAttack();
                Combat.enemyHp -= Run.atk;
                
                if (Combat.enemyHp <= 0) {
                    Game.winCombat();
                    return;
                }

                // Tour de l'ennemi (apr√®s petit d√©lai)
                setTimeout(() => {
                    const dmg = Math.max(1, Combat.enemyAtk - Run.def);
                    Run.currentHp -= dmg;
                    UI.animPlayerHit();
                    UI.updateHpBar();

                    if (Run.currentHp <= 0) {
                        Game.loseCombat();
                    } else {
                        // Prochain round
                        setTimeout(Game.combatRound, 800 / Run.speedMultiplier);
                    }
                }, 400 / Run.speedMultiplier);
            },

            winCombat: () => {
                Combat.isActive = false;
                const goldReward = 50 + (Run.day * 2);
                Player.gold += goldReward;
                UI.log(`> Cible √©limin√©e. Gain: ${goldReward} Or.`);
                UI.showMissionView();
                UI.updateAll();
                Game.save();
                Game.endAction(); // Reprend la boucle auto si active
            },

            loseCombat: () => {
                Combat.isActive = false;
                Run.isActive = false;
                Run.autoMode = false; // Stop l'auto en cas de mort
                Run.currentHp = 0;
                UI.log("!!! √âCHEC CRITIQUE DE LA MISSION !!!");
                UI.showMissionView();
                UI.updateAll();
                Game.save();
                // Ne rappelle pas endAction, le joueur doit relancer manuellement
            },

            // Gestion Inventaire & Stats
            openChest: () => {
                if (Player.gems >= 5) {
                    Player.gems -= 5;
                    const itemTemplate = GameData.items[Math.floor(Math.random() * GameData.items.length)];
                    // Cr√©ation instance objet unique
                    const newItem = { ...itemTemplate, uid: Date.now() };
                    Player.inventory.push(newItem);
                    UI.log(`> Coffre ouvert : ${newItem.name} obtenu.`);
                    Game.checkFusion();
                    UI.updateAll();
                    Game.save();
                } else {
                    UI.log("> Pas assez de mati√®re (5‚ú® requis).");
                }
            },

            checkFusion: () => {
                // Compte les items par nom
                const counts = {};
                Player.inventory.forEach(item => {
                    counts[item.name] = (counts[item.name] || 0) + 1;
                });

                for (const name in counts) {
                    if (counts[name] >= 3) {
                        // Fusion trouv√©e
                        const baseItem = Player.inventory.find(i => i.name === name);
                        // Retirer 3 exemplaires
                        let removed = 0;
                        Player.inventory = Player.inventory.filter(item => {
                            if (item.name === name && removed < 3) {
                                removed++;
                                return false;
                            }
                            return true;
                        });
                        
                        // Ajouter version am√©lior√©e (Stat * 2 approx)
                        const upgradedItem = {
                            ...baseItem,
                            stat: Math.floor(baseItem.stat * 2.2),
                            name: baseItem.name + "+"
                        };
                        Player.inventory.push(upgradedItem);
                        UI.log(`*** FUSION R√âUSSIE : ${baseItem.name} -> ${upgradedItem.name} ***`);
                        
                        // R√©cursivit√© pour fusionner en cha√Æne si on en avait 9 par exemple
                        Game.checkFusion();
                        return;
                    }
                }
            },

            equipItem: (uid) => {
                const index = Player.inventory.findIndex(i => i.uid === uid);
                if (index === -1) return;

                const item = Player.inventory[index];
                const type = item.type;

                // Si un item est d√©j√† √©quip√©, on le remet dans l'inventaire
                if (Player.equipment[type]) {
                    Player.inventory.push(Player.equipment[type]);
                }

                // √âquiper le nouveau
                Player.equipment[type] = item;
                // Retirer de l'inventaire
                Player.inventory.splice(index, 1);

                Game.calculateStats();
                UI.updateAll();
                Game.save();
            },

            calculateStats: () => {
                // Base stats
                let maxHp = 100 + (Player.baseStats.hp * 20);
                let atk = 10 + (Player.baseStats.atk * 5);
                let def = 0 + (Player.baseStats.def * 2);

                // Equipment stats
                if (Player.equipment.weapon) atk += Player.equipment.weapon.stat;
                if (Player.equipment.head) maxHp += Player.equipment.head.stat;
                if (Player.equipment.pet) atk += Player.equipment.pet.stat;

                // Update Run stats
                Run.maxHp = maxHp;
                Run.atk = atk;
                Run.def = def;
                
                // Soin si on augmente les HP max ou d√©but de run
                if (Run.currentHp > Run.maxHp) Run.currentHp = Run.maxHp;
                if (!Run.isActive) Run.currentHp = Run.maxHp; 
            },

            upgradeStat: (statType) => {
                const cost = 100 + (Player.baseStats[statType] * 50);
                if (Player.gold >= cost) {
                    Player.gold -= cost;
                    Player.baseStats[statType]++;
                    Game.calculateStats();
                    UI.updateAll();
                    Game.save();
                }
            },

            // Contr√¥les
            toggleAuto: () => {
                Run.autoMode = !Run.autoMode;
                UI.updateControls();
                // Si on active l'auto et qu'on est idle, on relance
                if (Run.autoMode && Run.isActive && !Run.isProcessing && !Combat.isActive) {
                    Game.triggerAction();
                }
            },

            toggleSpeed: () => {
                Run.speedMultiplier = (Run.speedMultiplier === 1) ? 2 : 1;
                UI.updateControls();
            },

            hardReset: () => {
                if (confirm("ATTENTION : Cela effacera toute votre progression. Continuer ?")) {
                    localStorage.removeItem('distory_save_v56');
                    location.reload();
                }
            },

            save: () => {
                localStorage.setItem('distory_save_v56', JSON.stringify(Player));
            }
        };

        // --- GESTION DE L'INTERFACE (UI) ---
        const UI = {
            hideBootScreen: () => {
                document.getElementById('boot-screen').classList.add('hidden');
                document.getElementById('game-interface').classList.remove('blur');
            },

            updateAll: () => {
                // Top Stats
                document.getElementById('ui-gold').innerText = Player.gold;
                document.getElementById('ui-gems').innerText = Player.gems;
                document.getElementById('ui-zone').innerText = `1-${Run.day}`;

                // Pilot Stats
                document.getElementById('ui-avatar').innerText = Player.avatar;
                document.getElementById('ui-level').innerText = Math.floor(Run.day / 10) + 1;
                
                document.getElementById('ui-hp-txt').innerText = `${Math.floor(Run.currentHp)}/${Run.maxHp}`;
                const hpPercent = Math.max(0, (Run.currentHp / Run.maxHp) * 100);
                document.getElementById('ui-hp-fill').style.width = `${hpPercent}%`;

                document.getElementById('ui-atk').innerText = Run.atk;
                document.getElementById('ui-def').innerText = Run.def;

                // Inventory Grid
                const grid = document.getElementById('inventory-grid');
                grid.innerHTML = '';
                Player.inventory.forEach(item => {
                    const el = document.createElement('div');
                    el.className = 'item-slot';
                    el.innerText = item.icon;
                    el.onclick = () => Game.equipItem(item.uid);
                    grid.appendChild(el);
                });

                // Equipment Slots
                const setSlot = (id, item) => {
                    const el = document.getElementById(id);
                    if (item) {
                        el.innerText = item.icon;
                        el.classList.add('equipped');
                    } else {
                        // Reset icon default (un peu brut, on pourrait garder les ic√¥nes par d√©faut)
                        if(id.includes('weapon')) el.innerText = "‚öîÔ∏è";
                        if(id.includes('head')) el.innerText = "üõ°Ô∏è";
                        if(id.includes('pet')) el.innerText = "üêæ";
                        el.classList.remove('equipped');
                    }
                };
                setSlot('slot-weapon', Player.equipment.weapon);
                setSlot('slot-head', Player.equipment.head);
                setSlot('slot-pet', Player.equipment.pet);

                // Upgrade Costs
                document.getElementById('cost-hp').innerText = `${100 + Player.baseStats.hp*50} ü™ô`;
                document.getElementById('cost-atk').innerText = `${100 + Player.baseStats.atk*50} ü™ô`;
                document.getElementById('cost-def').innerText = `${100 + Player.baseStats.def*50} ü™ô`;

                UI.updateControls();
            },

            updateControls: () => {
                const btnAuto = document.getElementById('btn-auto');
                btnAuto.innerText = Run.autoMode ? "AUTO: ON" : "AUTO: OFF";
                btnAuto.classList.toggle('active', Run.autoMode);

                const btnSpeed = document.getElementById('btn-speed');
                btnSpeed.innerText = `VIT: x${Run.speedMultiplier}`;
                
                const mainBtn = document.getElementById('btn-action');
                if (Run.isActive) {
                    mainBtn.innerText = "EN COURS...";
                    mainBtn.disabled = true;
                } else {
                    mainBtn.innerText = "LANCER";
                    mainBtn.disabled = false;
                }
            },

            triggerScanEffect: () => {
                const layer = document.getElementById('laser-layer');
                const laser = document.createElement('div');
                laser.className = 'anim-scanning';
                layer.appendChild(laser);
                setTimeout(() => laser.remove(), 800);
            },

            showCombatView: (enemyIcon) => {
                document.getElementById('view-mission').classList.add('hidden');
                document.getElementById('view-combat').classList.remove('hidden');
                document.getElementById('enemy-sprite').innerText = enemyIcon;
            },

            showMissionView: () => {
                document.getElementById('view-combat').classList.add('hidden');
                document.getElementById('view-mission').classList.remove('hidden');
            },

            animPlayerAttack: () => {
                const avatar = document.getElementById('ui-avatar');
                avatar.classList.remove('anim-floating'); // Pause float
                avatar.classList.add('anim-attacking');
                setTimeout(() => {
                    avatar.classList.remove('anim-attacking');
                    avatar.classList.add('anim-floating');
                }, 300);
            },

            animPlayerHit: () => {
                const panel = document.querySelector('.game-panel'); // Shake whole panel
                panel.classList.add('anim-hit');
                setTimeout(() => panel.classList.remove('anim-hit'), 400);
            },

            updateHpBar: () => {
                const hpPercent = Math.max(0, (Run.currentHp / Run.maxHp) * 100);
                document.getElementById('ui-hp-fill').style.width = `${hpPercent}%`;
                document.getElementById('ui-hp-txt').innerText = `${Math.floor(Run.currentHp)}/${Run.maxHp}`;
            },

            log: (msg) => {
                const container = document.getElementById('log-container');
                const entry = document.createElement('div');
                entry.className = 'log-entry';
                entry.innerText = `> ${msg}`;
                container.insertBefore(entry, container.firstChild);
                // Limite le log √† 50 entr√©es
                if (container.children.length > 50) container.lastChild.remove();
            },

            switchTab: (tabName) => {
                if (tabName === 'hub') {
                    document.getElementById('hub-overlay').classList.remove('hidden');
                }
            },

            closeHub: () => {
                document.getElementById('hub-overlay').classList.add('hidden');
            },

            openSettings: () => {
                document.getElementById('settings-modal').style.display = 'flex';
            },

            closeSettings: () => {
                document.getElementById('settings-modal').style.display = 'none';
            }
        };

        // Lancement au chargement de la page
        window.onload = Game.init;

    </script>
</body>
</html>
